<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KW Classification - Interactive Rubrics</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; color: #333; }
        .header { background: #fff; padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .header h1 { font-size: 18px; color: #1a1a1a; }
        .header .stats { font-size: 13px; color: #666; }
        .main { display: flex; height: calc(100vh - 52px); }
        .sidebar { width: 320px; background: #fff; border-right: 1px solid #e0e0e0; overflow-y: auto; flex-shrink: 0; }
        .sidebar.split-mode { width: 260px; }
        .module { border-bottom: 1px solid #e8e8e8; }
        .module-header { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
        .module-header:hover { background: #f5f5f5; }
        .module-header.active { background: #e3f2fd; }
        .module-arrow { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #999; transition: transform 0.2s; }
        .module.open .module-arrow { transform: rotate(180deg); }
        .module-name { font-weight: 600; color: #1976d2; cursor: pointer; padding: 2px 6px; border-radius: 3px; }
        .module-name:hover { background: #e3f2fd; }
        .module-title { color: #555; font-size: 13px; flex: 1; }
        .module-count { background: #e8e8e8; padding: 2px 8px; border-radius: 10px; font-size: 11px; color: #666; }
        .rubrics-list { display: none; background: #fafafa; padding: 5px 0; }
        .module.open .rubrics-list { display: block; }
        .rubric-item { padding: 8px 15px 8px 35px; font-size: 12px; border-left: 2px solid transparent; }
        .rubric-item:hover { background: #f0f0f0; }
        .rubric-id { color: #00796b; font-family: monospace; }
        .rubric-check { color: #0277bd; margin-left: 8px; }
        .rubric-item.code-based .rubric-id::after { content: "CODE"; background: #fff3e0; color: #e65100; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-left: 6px; }
        .split-container { display: none; flex: 1; }
        .split-container.active { display: flex; }
        .prompt-panel { flex: 0.42; background: #fff; border-right: 1px solid #e0e0e0; overflow-y: auto; padding: 20px; }
        .prompt-panel h2 { color: #1976d2; margin-bottom: 15px; font-size: 16px; position: sticky; top: 0; background: #fff; padding: 10px 0; border-bottom: 1px solid #e8e8e8; }
        .prompt-content { font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px; line-height: 1.6; white-space: pre-wrap; color: #333; }
        .rubric-panel { flex: 0.58; background: #f8f9fa; overflow-y: auto; padding: 20px; }
        .rubric-panel h2 { color: #00796b; margin-bottom: 15px; font-size: 16px; position: sticky; top: 0; background: #f8f9fa; padding: 10px 0; border-bottom: 1px solid #e8e8e8; }
        .rubric-card { background: #fff; border-radius: 6px; padding: 15px; margin-bottom: 12px; border-left: 3px solid #00796b; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .rubric-card.code-based { border-left-color: #e65100; }
        .rubric-card-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .rubric-card-id { font-family: monospace; color: #00796b; font-size: 13px; }
        .rubric-card-badge { background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 3px; font-size: 10px; }
        .rubric-card-criterion { color: #1a1a1a; font-weight: 600; margin-bottom: 8px; }
        .rubric-card-check { color: #0277bd; font-size: 13px; margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px; }
        .rubric-card-section { margin-bottom: 10px; }
        .rubric-card-label { color: #7b1fa2; font-size: 11px; text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
        .rubric-card-label.pass { color: #2e7d32; }
        .rubric-card-label.fail { color: #c62828; }
        .rubric-card-content { font-size: 12px; color: #444; white-space: pre-wrap; background: #fafafa; padding: 8px; border-radius: 4px; border: 1px solid #e8e8e8; }
        .close-split { position: fixed; top: 60px; right: 15px; background: #e0e0e0; border: none; color: #333; padding: 5px 12px; border-radius: 4px; cursor: pointer; z-index: 100; }
        .close-split:hover { background: #d0d0d0; }
        .welcome { flex: 1; display: flex; align-items: center; justify-content: center; color: #888; flex-direction: column; gap: 10px; }
        .welcome.hidden { display: none; }
        .welcome-icon { font-size: 48px; opacity: 0.3; }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #f0f0f0; }
        ::-webkit-scrollbar-thumb { background: #c0c0c0; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>KW Classification - Interactive Rubrics v2.2</h1>
        <div class="stats">67 rubrics across 18 modules | Click module name to view prompt + rubrics</div>
    </div>
    <div class="main">
        <div class="sidebar" id="sidebar">
            
            <div class="module" data-module="M01">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M01', event)">M01</span>
                    <span class="module-title">Extract Own Brand Entities</span>
                    <span class="module-count">5</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M01_brand_extracted</span><span class="rubric-check">→ Brand extracted from title or listing_brand field</span></div>
<div class="rubric-item"><span class="rubric-id">M01_no_hallucination</span><span class="rubric-check">→ Base brand must come from input; typos must be variations of that brand</span></div>
<div class="rubric-item"><span class="rubric-id">M01_no_product_words</span><span class="rubric-check">→ No generic product/feature words in brand output</span></div>
<div class="rubric-item"><span class="rubric-id">M01_amazon_test_applied</span><span class="rubric-check">→ Entity is a brand you search FOR, not a product you search TO BUY</span></div>
<div class="rubric-item"><span class="rubric-id">M01_no_duplicates</span><span class="rubric-check">→ No exact duplicate strings in list</span></div>

                </div>
            </div>

            <div class="module" data-module="M01a">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M01a', event)">M01a</span>
                    <span class="module-title">Generate Brand Variations</span>
                    <span class="module-count">4</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M01a_has_variations</span><span class="rubric-check">→ Multiple brand variations generated</span></div>
<div class="rubric-item"><span class="rubric-id">M01a_no_unrelated_terms</span><span class="rubric-check">→ All variations are misspellings/typos of the SAME brand only</span></div>
<div class="rubric-item"><span class="rubric-id">M01a_count_in_range</span><span class="rubric-check">→ Exactly 8-12 variations</span></div>
<div class="rubric-item"><span class="rubric-id">M01a_first_is_canonical</span><span class="rubric-check">→ First variation matches input brand_name exactly</span></div>

                </div>
            </div>

            <div class="module" data-module="M01b">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M01b', event)">M01b</span>
                    <span class="module-title">Extract Brand Related Terms</span>
                    <span class="module-count">4</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M01b_sub_brands_found</span><span class="rubric-check">→ Sub-brands, product lines, brand-owned tech extracted from listing</span></div>
<div class="rubric-item"><span class="rubric-id">M01b_no_universal_standards</span><span class="rubric-check">→ No universal/industry standards listed as brand-specific</span></div>
<div class="rubric-item"><span class="rubric-id">M01b_manufacturer_null_when_same</span><span class="rubric-check">→ Manufacturer=null when same as brand</span></div>
<div class="rubric-item"><span class="rubric-id">M01b_searchable_standards_default_empty</span><span class="rubric-check">→ searchable_standards empty unless customers actively search for standard by name</span></div>

                </div>
            </div>

            <div class="module" data-module="M02">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M02', event)">M02</span>
                    <span class="module-title">Detect Brand in Keyword</span>
                    <span class="module-count">6</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M02_correct_classification</span><span class="rubric-check">→ OB when keyword contains brand from variations_own, null otherwise</span></div>
<div class="rubric-item"><span class="rubric-id">M02_brand_match_found</span><span class="rubric-check">→ Brand from variations_own detected in keyword when present</span></div>
<div class="rubric-item"><span class="rubric-id">M02_no_false_positives</span><span class="rubric-check">→ No generic words flagged as brand</span></div>
<div class="rubric-item"><span class="rubric-id">M02_case_insensitive</span><span class="rubric-check">→ Brand matching ignores uppercase/lowercase differences</span></div>
<div class="rubric-item"><span class="rubric-id">M02_word_boundary_respected</span><span class="rubric-check">→ Partial matches rejected (jbl ≠ jblue)</span></div>
<div class="rubric-item"><span class="rubric-id">M02_no_similar_brand_confusion</span><span class="rubric-check">→ Similar-looking brands rejected (jlab ≠ JBL)</span></div>

                </div>
            </div>

            <div class="module" data-module="M03">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M03', event)">M03</span>
                    <span class="module-title">Generate Competitor Entities</span>
                    <span class="module-count">3</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M03_competitors_relevant</span><span class="rubric-check">→ All competitors sell products in same category as ASIN</span></div>
<div class="rubric-item"><span class="rubric-id">M03_competitor_count</span><span class="rubric-check">→ 5-10 distinct competitor brands included</span></div>
<div class="rubric-item"><span class="rubric-id">M03_no_hallucinated_brands</span><span class="rubric-check">→ All competitor brands are verifiable real brands</span></div>

                </div>
            </div>

            <div class="module" data-module="M04">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M04', event)">M04</span>
                    <span class="module-title">Classify Competitor Brand Keywords</span>
                    <span class="module-count">5</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M04_correct_classification</span><span class="rubric-check">→ CB when competitor brand in keyword, null otherwise</span></div>
<div class="rubric-item"><span class="rubric-id">M04_own_brand_excluded</span><span class="rubric-check">→ Own brand terms never trigger CB classification</span></div>
<div class="rubric-item"><span class="rubric-id">M04_word_boundary_respected</span><span class="rubric-check">→ Partial/substring matches rejected - only full words match</span></div>
<div class="rubric-item"><span class="rubric-id">M04_known_brands_detected</span><span class="rubric-check">→ Recognizable brands caught even if not in competitors list</span></div>
<div class="rubric-item"><span class="rubric-id">M04_character_ip_recognized</span><span class="rubric-check">→ Licensed character and franchise names detected as brands</span></div>

                </div>
            </div>

            <div class="module" data-module="M05">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M05', event)">M05</span>
                    <span class="module-title">Classify Non-Branded Keywords</span>
                    <span class="module-count">5</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M05_correct_classification</span><span class="rubric-check">→ NB only when keyword has zero brand references</span></div>
<div class="rubric-item"><span class="rubric-id">M05_hidden_brands_detected</span><span class="rubric-check">→ Brands not in provided lists are still caught</span></div>
<div class="rubric-item"><span class="rubric-id">M05_typo_variations_caught</span><span class="rubric-check">→ Spacing and typo variations recognized as brands</span></div>
<div class="rubric-item"><span class="rubric-id">M05_product_lines_recognized</span><span class="rubric-check">→ Trademarked product line names caught as brands</span></div>
<div class="rubric-item"><span class="rubric-id">M05_ppc_terms_filtered</span><span class="rubric-check">→ ASIN codes and PPC match-type terms return null</span></div>

                </div>
            </div>

            <div class="module" data-module="M06">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M06', event)">M06</span>
                    <span class="module-title">Generate Product Type Taxonomy</span>
                    <span class="module-count">4</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M06_hierarchy_correct</span><span class="rubric-check">→ Rank 1 = most specific type, higher ranks = broader categories</span></div>
<div class="rubric-item"><span class="rubric-id">M06_product_type_accurate</span><span class="rubric-check">→ Rank 1 accurately describes what the product IS</span></div>
<div class="rubric-item"><span class="rubric-id">M06_synonyms_merged</span><span class="rubric-check">→ Terms with same meaning merged on same rank with " / " separator</span></div>
<div class="rubric-item"><span class="rubric-id">M06_no_excluded_terms</span><span class="rubric-check">→ No adjectives, features, materials, colors, sizes in taxonomy ranks</span></div>

                </div>
            </div>

            <div class="module" data-module="M07">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M07', event)">M07</span>
                    <span class="module-title">Extract Product Attributes</span>
                    <span class="module-count">4</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M07_attributes_from_listing</span><span class="rubric-check">→ Variants, use cases derived from title, bullets, description, or Keepa hints</span></div>
<div class="rubric-item"><span class="rubric-id">M07_no_fabricated_use_cases</span><span class="rubric-check">→ Use cases supported by product's actual function</span></div>
<div class="rubric-item"><span class="rubric-id">M07_audiences_explicit_or_dash</span><span class="rubric-check">→ Audiences from listing OR ["-"] when no specific audience mentioned</span></div>
<div class="rubric-item"><span class="rubric-id">M07_specs_preserve_units</span><span class="rubric-check">→ Full specs with numbers and units preserved</span></div>

                </div>
            </div>

            <div class="module" data-module="M08">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M08', event)">M08</span>
                    <span class="module-title">Assign Attribute Ranks</span>
                    <span class="module-count">3</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M08_important_ranked_high</span><span class="rubric-check">→ Title attributes = rank 1-2, bullet attributes = rank 2-3, description = rank 3-4</span></div>
<div class="rubric-item"><span class="rubric-id">M08_unique_ranks_per_type</span><span class="rubric-check">→ Each attribute_type has unique sequential ranks (no duplicates)</span></div>
<div class="rubric-item"><span class="rubric-id">M08_title_attributes_ranked_high</span><span class="rubric-check">→ Attributes appearing in title get rank 1-2 within their type</span></div>

                </div>
            </div>

            <div class="module" data-module="M09">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M09', event)">M09</span>
                    <span class="module-title">Identify Primary Intended Use</span>
                    <span class="module-count">4</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M09_captures_core_purpose</span><span class="rubric-check">→ Answers: "What is the ONE thing this product does?"</span></div>
<div class="rubric-item"><span class="rubric-id">M09_no_marketing_language</span><span class="rubric-check">→ No adjectives, quality claims, or marketing words</span></div>
<div class="rubric-item"><span class="rubric-id">M09_word_count_3_to_6</span><span class="rubric-check">→ Exactly 3-6 words in primary_use</span></div>
<div class="rubric-item"><span class="rubric-id">M09_no_brand_tech_names</span><span class="rubric-check">→ No brand names or technology specs in output</span></div>

                </div>
            </div>

            <div class="module" data-module="M10">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M10', event)">M10</span>
                    <span class="module-title">Validate Primary Intended Use</span>
                    <span class="module-count">2</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M10_invalid_correctly_flagged</span><span class="rubric-check">→ Correctly flags: adjectives, tech names, wrong word count, marketing language</span></div>
<div class="rubric-item"><span class="rubric-id">M10_fix_improves_output</span><span class="rubric-check">→ Corrected validated_use passes all M09 criteria</span></div>

                </div>
            </div>

            <div class="module" data-module="M11">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M11', event)">M11</span>
                    <span class="module-title">Identify Hard Constraints</span>
                    <span class="module-count">5</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M11_only_true_constraints</span><span class="rubric-check">→ Only attributes that make product PHYSICALLY UNABLE to function when removed</span></div>
<div class="rubric-item"><span class="rubric-id">M11_critical_not_missed</span><span class="rubric-check">→ Device compatibility and essential safety constraints not missed</span></div>
<div class="rubric-item"><span class="rubric-id">M11_never_categories_excluded</span><span class="rubric-check">→ No tech versions, durability, performance specs marked as hard</span></div>
<div class="rubric-item"><span class="rubric-id">M11_expected_distribution</span><span class="rubric-check">→ Most products have 0 hard constraints, accessories may have 1</span></div>
<div class="rubric-item"><span class="rubric-id">M11_three_step_test_applied</span><span class="rubric-check">→ All 3 tests applied: (1) Complete Removal, (2) Mechanism vs Quality, (3) Validated Use Alignment</span></div>

                </div>
            </div>

            <div class="module" data-module="M12">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M12', event)">M12</span>
                    <span class="module-title">Combined Classification</span>
                    <span class="module-count">2</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M12_correct_classification</span><span class="rubric-check">→ Classification follows decision tree: Hard Constraint → Product Type → Primary Use → Complementary</span></div>
<div class="rubric-item"><span class="rubric-id">M12_decision_path_followed</span><span class="rubric-check">→ Steps followed in order: (1) Hard constraint → (2) Product type → (3a/3b) Use check → (4) Complementary</span></div>

                </div>
            </div>

            <div class="module" data-module="M13">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M13', event)">M13</span>
                    <span class="module-title">Product Type Check</span>
                    <span class="module-count">3</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M13_same_type_correct</span><span class="rubric-check">→ Correctly identifies if keyword asks for same base product type as ASIN taxonomy</span></div>
<div class="rubric-item"><span class="rubric-id">M13_modifiers_stripped</span><span class="rubric-check">→ Core product noun extracted, modifiers ignored</span></div>
<div class="rubric-item"><span class="rubric-id">M13_synonyms_recognized</span><span class="rubric-check">→ Common synonyms recognized as same type</span></div>

                </div>
            </div>

            <div class="module" data-module="M14">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M14', event)">M14</span>
                    <span class="module-title">Primary Use Check (Same Type)</span>
                    <span class="module-count">2</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M14_same_use_correct</span><span class="rubric-check">→ Keyword's implied use matches ASIN's validated_use</span></div>
<div class="rubric-item"><span class="rubric-id">M14_superficial_differences_ignored</span><span class="rubric-check">→ Material/form/character/brand differences don't change primary use classification</span></div>

                </div>
            </div>

            <div class="module" data-module="M15">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M15', event)">M15</span>
                    <span class="module-title">Substitute Check</span>
                    <span class="module-count">2</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M15_substitute_correct</span><span class="rubric-check">→ Different product type that satisfies same customer need = Substitute</span></div>
<div class="rubric-item"><span class="rubric-id">M15_sixty_percent_overlap</span><span class="rubric-check">→ Near-substitutes with significant use overlap classified as S</span></div>

                </div>
            </div>

            <div class="module" data-module="M16">
                <div class="module-header">
                    <div class="module-arrow"></div>
                    <span class="module-name" onclick="openSplitView('M16', event)">M16</span>
                    <span class="module-title">Complementary Check</span>
                    <span class="module-count">4</span>
                </div>
                <div class="rubrics-list">
                    <div class="rubric-item"><span class="rubric-id">M16_complementary_correct</span><span class="rubric-check">→ One product maintains, stores, displays, or enhances the other = C</span></div>
<div class="rubric-item"><span class="rubric-id">M16_amazon_bundle_test</span><span class="rubric-check">→ "Would Amazon show these as Frequently Bought Together?"</span></div>
<div class="rubric-item"><span class="rubric-id">M16_same_category_not_complementary</span><span class="rubric-check">→ Products in same category but different functions are NOT complementary</span></div>
<div class="rubric-item"><span class="rubric-id">M16_relationship_type_identified</span><span class="rubric-check">→ For C classification: Maintenance/Storage/Display/Accessory/Workflow/Same-Occasion specified</span></div>

                </div>
            </div>

        </div>
        <div class="welcome" id="welcome">
            <div class="welcome-icon">&#128203;</div>
            <div>Click on a module name (e.g., <strong style="color:#4fc1ff">M01</strong>) to view prompt + rubrics side by side</div>
            <div style="font-size: 12px;">Or click the arrow to expand/collapse rubric list</div>
        </div>
        <div class="split-container" id="splitContainer">
            <button class="close-split" onclick="closeSplitView()">&#10005; Close</button>
            <div class="prompt-panel" id="promptPanel">
                <h2 id="promptTitle">Prompt</h2>
                <div class="prompt-content" id="promptContent">Loading...</div>
            </div>
            <div class="rubric-panel" id="rubricPanel">
                <h2 id="rubricTitle">Rubrics</h2>
                <div id="rubricContent"></div>
            </div>
        </div>
    </div>
    <script>
        document.querySelectorAll('.module-header').forEach(header => {
            header.addEventListener('click', (e) => {
                if (e.target.classList.contains('module-name')) return;
                header.parentElement.classList.toggle('open');
            });
        });

        const modulePrompts = {
    "M01": `# Task: ExtractOwnBrandEntities

You are an Amazon PPC specialist extracting brand entities from product listings.

## Core Concept: Brand Entity vs Product Word

**Brand Entity** = WHO makes this? (trademark, company name)
**Product Word** = WHAT is this? (thing you can buy)

### The Amazon Test

For each word, ask: **"Can I search Amazon and buy a [word] as a standalone product?"**

- "wallet" → Yes, you can buy a wallet → **PRODUCT WORD** → exclude
- "bottle" → Yes, you can buy a bottle → **PRODUCT WORD** → exclude
- "kitchen" → Yes, you can buy kitchen items → **PRODUCT WORD** → exclude
- "bread" → Yes, you can buy bread → **PRODUCT WORD** → exclude
- "Owala" → No, Owala is a brand name → **BRAND ENTITY** → include
- "FreeSip" → No, it's a trademarked product line → **BRAND ENTITY** → include

### Critical Rule

**If your entity is [Brand] + [Product Word], ONLY keep the brand part.**

Examples:
- \`Badiya Wallet\` → "wallet" passes Amazon test → keep only \`Badiya\`
- \`Cisily Kitchen\` → "kitchen" passes Amazon test → keep only \`Cisily\`
- \`FreeSip Bottle\` → "bottle" passes Amazon test → keep only \`FreeSip\`

## Inputs

- **brand_name**: {{brand_name}}
- **title**: {{title}}
- **bullet_points**: {{bullet_points}}
- **description**: {{description}}
- **manufacturer**: {{manufacturer}}

## Step-by-Step Extraction Process

### Step 1: Identify Brand Elements
1. **Brand Name**: The official brand from inputs
2. **Manufacturer**: If different from brand name
3. **Sub-brands**: Trademarked product lines (e.g., "FreeSip", "ColorStay", "Vibe Beam")

### Step 2: Generate Typos (MANDATORY - 3-5 per brand)

For EACH brand element, you MUST generate common customer misspellings:

| Typo Type | How to Apply |
|-----------|--------------|
| **Doubled letter** | Double the last vowel or consonant: Owala→\`Owalaa\`, Badiya→\`Badiyaa\` |
| **Missing letter** | Remove one letter: Owala→\`Owla\`, Badiya→\`Badya\` |
| **Swapped letters** | Swap adjacent letters: Owala→\`Oawla\`, Badiya→\`Badiay\` |
| **Case variation** | All lowercase: Owala→\`owala\`, JBL→\`jbl\` |
| **With space** | Add space in compound: KitchenAid→\`Kitchen Aid\` |

**Example typo generation:**
- Brand "Badiya" → \`Badiya\`, \`badiya\`, \`Badiyaa\`, \`Badiyah\`, \`Badiay\`
- Brand "Cisily" → \`Cisily\`, \`cisily\`, \`Cisiliy\`, \`Cisly\`, \`Cisilyy\`
- Brand "JBL" → \`JBL\`, \`jbl\`, \`JLB\`, \`J B L\`

### Step 3: Validate Each Entity (Amazon Test)
Before adding to output, check: "Can I buy [last word] on Amazon?"
- If YES → REMOVE (it's a product word)
- If NO → KEEP (it's a brand)

**EXCLUDE:**
- Any word that passes the Amazon test (products you can buy)
- Features (wireless, waterproof, slim, RFID)
- Any [Brand] + [product noun] combination

## Validation Process (MANDATORY)

**For EACH candidate entity, do this check BEFORE adding to output:**

### Step 1: Split entity into words
\`JBL Deep Bass\` → ["JBL", "Deep", "Bass"]

### Step 2: Check the LAST word
Ask: "Is [last word] something I can buy, use, or a feature?"

### Step 3: Decide
- **If last word is a product/feature** → REMOVE entire entity
- **If last word is only the brand name or typo** → KEEP

### Common product words (things you can buy/use):
toys, figure, earbuds, speaker, bass, sound, bottle, wallet, holder, bag, case, organizer, kitchen, bread

### Common features (describe the product):
wireless, waterproof, deep, slim, RFID, insulated, stainless

### Examples of the Amazon Test in Action

| Entity | Last Word | Amazon Test | Result |
|--------|-----------|-------------|--------|
| \`Badiya Wallet\` | wallet | Can buy wallets ✓ | REMOVE |
| \`Transformers Toys\` | toys | Can buy toys ✓ | REMOVE |
| \`JBL Earbuds\` | earbuds | Can buy earbuds ✓ | REMOVE |
| \`Cisily Kitchen\` | kitchen | Can buy kitchen items ✓ | REMOVE |
| \`honiitaa Bread\` | bread | Can buy bread ✓ | REMOVE |
| \`JBL Deep Bass\` | bass | "bass" is audio feature | REMOVE |
| \`Badiya\` | Badiya | Can't buy "Badiya" alone | KEEP |
| \`Vibe Beam\` | Beam | Trademarked name | KEEP |

## Output Format

Output validated brand entities with typos (max 10):

\`\`\`json
{"brand_entities": ["Brand", "brand", "Brnad", "Bradn", "Brandd", "SubBrand", ...]}
\`\`\`

**CRITICAL: Each entity must be UNIQUE - no duplicates allowed!**

**Expected output structure:**
- Original brand name + 3-5 typos (all unique)
- Lowercase variation
- Sub-brand if exists + its typos
- Manufacturer if different from brand

**Before adding any entity, check if it's already in the list.**

## STOP! Before outputting, verify:

1. **NO DUPLICATES** - Scan your list: if any entity appears more than once, REMOVE the duplicate
2. **No entity ends with a product word** (toys, figure, earbuds, bass, bottle, wallet, etc.)
3. **No entity ends with a feature** (wireless, deep, slim, RFID)
4. **No concatenated forms** (JBLVibeBeamEarbuds → wrong, use "JBL" and "Vibe Beam" separately)
5. **Max 1-2 words per entity** (except known trademarks like "The North Face")

**DUPLICATE CHECK (MANDATORY):**
Before returning, mentally scan: "Is 'X' already in my list?" for EACH entity you add.
Example BAD output: \`["JBL", "jbl", "JBL", "Vibe"]\` - "JBL" appears twice → REMOVE one

## Quick Reference

**Always remove if last word is a common noun like:**
- Things you wear/carry: wallet, bag, case, holder, jacket, shoes
- Kitchen items: bottle, organizer, caddy, tray, maker
- Electronics: phone, earbuds, speaker, charger
- Food: bread, snacks, drinks
- Any physical product category

**Always keep:**
- Brand names: Badiya, Cisily, Owala, JBL
- Typos of brand names: Badiyaa, Owalaa, JLB
- Trademarked product lines: FreeSip, ColorStay, Vibe Beam

---

## FINAL CHECK: Remove any duplicates from your output array before returning!
`,
    "M01a": `# Task: ExtractOwnBrandVariations

Generate realistic brand name search variations for Amazon PPC.

## Input

- **brand_name**: {{brand_name}}

## Output Format

Return ONLY a JSON object with a "variations" array containing 8-12 strings:

\`\`\`json
{"variations": ["BrandName", "brandname", "Brandnme"]}
\`\`\`

## STRICT RULES

1. **EXACTLY 8-12 variations** — no more, no less
2. **NO DUPLICATES** — each variation must be unique
3. **First item = correct spelling**
4. **Strings only** — no numbers, no scores, no objects

## Variation Categories

Generate variations from these 5 categories:

### 1. CANONICAL (1 item)
The correct brand spelling — always first.

### 2. CASE/SPACING (2-3 items)
- Lowercase: \`Owala\` → \`owala\`
- Compound (no space): \`Truly Indian\` → \`TrulyIndian\`
- Hyphenated: \`Truly Indian\` → \`Truly-Indian\`

### 3. TRUNCATION (0-1 item)
First word only IF brand has 2+ words AND first word is distinctive:
- \`Truly Indian\` → \`Truly\`
- \`Antarctic Star\` → \`Antarctic\`
- \`Rx Crush\` → \`Rx\`

Skip if first word is generic ("The", "My", "New").

### 4. KEYBOARD TYPOS (2-3 items)
Adjacent QWERTY key mistakes:
- \`t\` near \`r,y,g\`: \`Truly\` → \`Teuly\`
- \`a\` near \`s,q\`: \`Owala\` → \`Owsla\`
- \`i\` near \`u,o\`: \`Indian\` → \`Undian\`

### 5. PHONETIC/SPELLING (2-3 items)
Sound-alike mistakes:
- \`Truly\` → \`Truely\` (common misspelling)
- \`Cisily\` → \`Cicily\` (s/c confusion)
- \`Owala\` → \`Ohwala\` (sound interpretation)
- Missing/doubled letters: \`Owala\` → \`Owla\`, \`Owalla\`

## Examples

### Example 1: "Owala"
\`\`\`json
{
  "variations": [
    "Owala",
    "owala",
    "OWALA",
    "Owla",
    "Owalla",
    "Ohwala",
    "Owalq",
    "Owals",
    "O-wala"
  ]
}
\`\`\`
Count: 9 variations ✓

### Example 2: "Truly Indian"
\`\`\`json
{
  "variations": [
    "Truly Indian",
    "truly indian",
    "TrulyIndian",
    "Truly-Indian",
    "Truly",
    "Truely Indian",
    "Trully Indian",
    "Truly Indien",
    "Teuly Indian",
    "Truly Inidan"
  ]
}
\`\`\`
Count: 10 variations ✓

### Example 3: "JBL"
\`\`\`json
{
  "variations": [
    "JBL",
    "jbl",
    "Jbl",
    "JLB",
    "JBK",
    "JNL",
    "J.B.L.",
    "J B L"
  ]
}
\`\`\`
Count: 8 variations ✓

### Example 4: "Antarctic Star"
\`\`\`json
{
  "variations": [
    "Antarctic Star",
    "antarctic star",
    "AntarcticStar",
    "Antarctic-Star",
    "Antarctic",
    "Antartic Star",
    "Antarcic Star",
    "Antarctik Star",
    "Antrctic Star",
    "Antarctic Starr"
  ]
}
\`\`\`
Count: 10 variations ✓

## Before Output Checklist

□ Count is 8-12 items
□ First item is correct spelling
□ No duplicates in list
□ Only strings in array
□ Truncation included (if applicable)
□ Lowercase version included
□ At least 2 typos included

## DO NOT INCLUDE

- Sub-brands (FreeSip, ColorStay)
- Product names
- Category words (bottle, earbuds)
- Numbers or scores
- Nested objects
`,
    "M01b": `# Task: ExtractBrandRelatedTerms

Extract brand-related entities from Amazon product listings.

## Input

- **brand_name**: {{brand_name}}
- **title**: {{title}}
- **bullet_points**: {{bullet_points}}
- **description**: {{description}}
- **manufacturer**: {{manufacturer}}

## Output Format

\`\`\`json
{
  "sub_brands": [],
  "searchable_standards": [],
  "manufacturer": null
}
\`\`\`

---

## FIELD 1: sub_brands

Named sub-brands, product families, series, **or brand-owned technologies** within the parent brand.

### INCLUDE in sub_brands:
- Trademarked sub-brand names: \`FreeSip\`, \`ColorStay\`, \`Vibe Beam\`
- Named product series: \`Cyber Commander Series\`
- **Brand-owned technologies** that customers search WITH the brand:
  - \`OMNI-HEAT\` (Columbia's technology) → people search "Columbia OMNI-HEAT"
  - \`IceFlow\` (Stanley's product line) → people search "Stanley IceFlow"
  - \`QuietComfort\` (Bose's product line) → people search "Bose QuietComfort"
  - \`TrueFX\` (Mattel's technology) → collectors search "Mattel TrueFX"

### EXCLUDE from sub_brands:
- **Generic product types**: Pill Pouch, Pill Crusher, Water Bottle, Oven Mitt
- **Feature descriptions**: Deep Bass Sound, Waterproof, Lightweight
- **Size/color variants**: Large, Black, 24oz
- **Marketing fluff nobody searches**: "Adapti-Flex Color Lock Technology™"

### Test: Would someone search Amazon for "[sub_brand] [brand]"?
- ✓ "FreeSip Owala" — YES, it's a sub-brand
- ✓ "ColorStay Revlon" — YES
- ✓ "OMNI-HEAT Columbia" — YES, brand technology
- ✗ "Pill Pouch Rx Crush" — NO, that's a product type
- ✗ "Deep Bass Sound JBL" — NO, marketing phrase

---

## FIELD 2: searchable_standards

**UNIVERSAL industry standards that work ACROSS BRANDS - not brand-specific technologies.**

### THE KEY DISTINCTION:
- **Universal standard** = Works across brands → goes in \`searchable_standards\`
- **Brand technology** = Only this brand uses it → goes in \`sub_brands\` (if searchable)

### THE KEY QUESTION: Would shoppers search "[this term] [product type]" WITHOUT a brand name?

### INCLUDE in searchable_standards (VERY RARE - most products have NONE):
- **Licensed material standards**: \`Gore-Tex\` → people search "Gore-Tex jacket"
- **Licensed audio/video tech**: \`Dolby Atmos\` → people search "Dolby Atmos soundbar"

**That's basically it.** Most products should return \`[]\` for this field.

### NOT searchable_standards (common mistakes):
- **ISO/industry standards** that became universal: \`ENFit\` (ISO 80369-3), \`USB-C\`, \`Bluetooth\` — these are like "USB 2.0", everyone has them, they don't differentiate

### EXCLUDE from searchable_standards:

- **Generic technology standards** (not brand-differentiating):
  - \`USB-C\`, \`USB-A\`, \`Lightning\` — generic connectors
  - \`Bluetooth\`, \`Bluetooth 5.3\`, \`WiFi\`, \`NFC\` — everyone has these
  - \`MagSafe\` — now too generic for phone accessories

- **Brand-specific technologies** (→ put in sub_brands instead):
  - \`OMNI-HEAT\` — Columbia trademark → sub_brands
  - \`TrueFX\` — Mattel trademark → sub_brands
  - \`QuietComfort\` — Bose trademark → sub_brands
  - \`Cocoon® Cloud®\` — brand trademark → sub_brands
  - \`VoiceAware\` — JBL trademark → sub_brands

- **Eco-certifications** (nobody searches these on Amazon):
  - \`STANDARD 100 by OEKO-TEX\`, \`GOTS certified\`, \`USDA organic\`, \`Energy Star\`

- **Marketing phrases**:
  - \`Adapti-Flex Color Lock Technology™\` — nobody searches this
  - \`Military-Grade\` — vague marketing term

- **Technical specs**:
  - \`DWR technology\`, \`IPX4\`, \`CP65\`, \`RoHS\`, \`REACH\` — too technical

### Decision Framework:
| Question | YES → | NO → |
|----------|-------|------|
| Is this used by MULTIPLE brands? | Continue | → sub_brands (if brand-specific) |
| Would shoppers search WITHOUT brand name? | INCLUDE | EXCLUDE |

### Examples:
| Term | Category | Result |
|------|----------|--------|
| \`Gore-Tex\` | Licensed material, people search it | ✓ searchable_standards |
| \`Dolby Atmos\` | Licensed audio tech, people search it | ✓ searchable_standards |
| \`ENFit\` | ISO standard, universal in category | ✗ EXCLUDE |
| \`USB-C\`, \`Bluetooth\` | Generic tech, everyone has it | ✗ EXCLUDE |
| \`MagSafe\` | Too generic now | ✗ EXCLUDE |
| \`OMNI-HEAT\` | Columbia trademark | → sub_brands |
| \`TrueFX\` | Mattel trademark | → sub_brands |
| \`Cocoon® Cloud®\` | Brand trademark | → sub_brands |
| \`Air Jordan\` | Nike trademark | → sub_brands |
| \`OEKO-TEX\` | Eco-cert, nobody searches | ✗ EXCLUDE |
| \`Military-Grade\` | Marketing fluff | ✗ EXCLUDE |

### When in doubt, return \`[]\`
Most products have NO universal searchable standards. Empty array is the correct default.

---

## FIELD 3: manufacturer

Company that manufactures the product, **IF different from brand**.

### RULE: manufacturer = brand → return \`null\`

Compare input \`manufacturer\` to \`brand_name\` (case-insensitive):
- \`brand_name: "JBL"\`, \`manufacturer: "JBL"\` → \`null\`
- \`brand_name: "Cisily"\`, \`manufacturer: "Cisily"\` → \`null\`
- \`brand_name: "Antarctic Star"\`, \`manufacturer: "Antarctic Star"\` → \`null\`
- \`brand_name: "Jikasho"\`, \`manufacturer: "Jikasho"\` → \`null\`
- \`brand_name: "REVLON"\`, \`manufacturer: "Revlon"\` → \`null\` (case-insensitive)
- \`brand_name: "Truly Indian"\`, \`manufacturer: "Truly Indian Foods LLC"\` → \`null\` (contains brand)

### RULE: Different manufacturer → return object

\`\`\`json
{
  "name": "Full Manufacturer Name",
  "short": "Short Name",
  "searchable": true/false
}
\`\`\`

### searchable = true:
Known company that consumers might search for:
- \`Hasbro\` — major toy company
- \`BlenderBottle\` — known bottle brand

### searchable = false:
OEM/unknown manufacturer that nobody searches for:
- \`Town & Country Living\`
- \`Resolve Designs\`

---

## Examples

### Example 1: JBL Earbuds
\`\`\`
brand_name: "JBL"
manufacturer: "JBL"
title: "JBL Vibe Beam - True Wireless JBL Deep Bass Sound Earbuds"
bullet_points: "...VoiceAware lets you balance how much of your own voice you hear..."
\`\`\`

**Analysis:**
- \`Vibe Beam\` = sub-brand (named product family)
- \`VoiceAware\` = NOT searchable (brand-specific, nobody searches "VoiceAware earbuds")
- \`Deep Bass Sound\` = NOT searchable (marketing phrase)
- manufacturer = brand → null

\`\`\`json
{
  "sub_brands": ["Vibe Beam"],
  "searchable_standards": [],
  "manufacturer": null
}
\`\`\`

### Example 2: Owala Bottle
\`\`\`
brand_name: "Owala"
manufacturer: "BlenderBottle"
title: "Owala FreeSip Insulated Stainless Steel Water Bottle"
bullet_points: "Patented FreeSip spout..."
\`\`\`

**Analysis:**
- \`FreeSip\` = sub-brand (patented, named product line)
- No searchable standards
- BlenderBottle ≠ Owala, known company → searchable: true

\`\`\`json
{
  "sub_brands": ["FreeSip"],
  "searchable_standards": [],
  "manufacturer": {
    "name": "BlenderBottle",
    "short": "BlenderBottle",
    "searchable": true
  }
}
\`\`\`

### Example 3: Revlon Eyeliner
\`\`\`
brand_name: "REVLON"
manufacturer: "Revlon"
title: "Revlon ColorStay Pencil Waterproof Eyeliner"
description: "Formulated with ColorStay Adapti-Flex Color Lock Technology™"
\`\`\`

**Analysis:**
- \`ColorStay\` = sub-brand (Revlon product line)
- \`Adapti-Flex Color Lock Technology™\` = NOT searchable (nobody searches this)
- manufacturer = brand (case-insensitive) → null

\`\`\`json
{
  "sub_brands": ["ColorStay"],
  "searchable_standards": [],
  "manufacturer": null
}
\`\`\`

### Example 4: KitchenAid Mitt (OEM)
\`\`\`
brand_name: "KitchenAid"
manufacturer: "Town & Country Living"
title: "KITCHENAID Ribbed Soft Silicone Oven Mitt"
\`\`\`

**Analysis:**
- No named sub-brand
- No searchable standards
- Town & Country Living = OEM, nobody searches this

\`\`\`json
{
  "sub_brands": [],
  "searchable_standards": [],
  "manufacturer": {
    "name": "Town & Country Living",
    "short": "Town & Country",
    "searchable": false
  }
}
\`\`\`

### Example 5: Transformers Toy
\`\`\`
brand_name: "Transformers"
manufacturer: "Hasbro"
title: "Transformers Toys Heroic Optimus Prime Action Figure"
bullet_points: "...Cyber Commander Series figure..."
\`\`\`

**Analysis:**
- \`Cyber Commander Series\` = sub-brand (named series)
- No searchable standards
- Hasbro = major toy company, very searchable

\`\`\`json
{
  "sub_brands": ["Cyber Commander Series"],
  "searchable_standards": [],
  "manufacturer": {
    "name": "Hasbro",
    "short": "Hasbro",
    "searchable": true
  }
}
\`\`\`

### Example 6: Pioneer Camp Jacket
\`\`\`
brand_name: "Pioneer Camp"
manufacturer: null
title: "Pioneer Camp Mens Lightweight Packable Puffer Jacket"
bullet_points: "...DWR technology with a waterproof rating..."
\`\`\`

**Analysis:**
- No named sub-brand
- \`DWR technology\` = NOT searchable (consumers search "waterproof jacket", not "DWR jacket")
- No manufacturer provided

\`\`\`json
{
  "sub_brands": [],
  "searchable_standards": [],
  "manufacturer": null
}
\`\`\`

### Example 7: Medical Syringe with ENFit
\`\`\`
brand_name: "Rx Crush"
manufacturer: "Vesco Medical"
title: "ENFit® Syringe - 20ml - QTY 10"
bullet_points: "ENFit\\nStandard ENFit Tip..."
\`\`\`

**Analysis:**
- No named sub-brand
- \`ENFit\` = ISO 80369-3 universal standard, NOT searchable (like USB-C, it's now universal for enteral syringes)
- Vesco Medical ≠ Rx Crush, OEM → searchable: false

\`\`\`json
{
  "sub_brands": [],
  "searchable_standards": [],
  "manufacturer": {
    "name": "Vesco Medical",
    "short": "Vesco",
    "searchable": false
  }
}
\`\`\`

---

## PRE-OUTPUT VALIDATION CHECKLIST

Before outputting, verify:

□ **manufacturer**: Did you check if manufacturer = brand_name (case-insensitive)?
  - If they match or one contains the other → MUST return \`null\`

□ **searchable_standards**: For each item, ask: "Would a shopper type this in Amazon search?"
  - If NO or UNLIKELY → remove it
  - When in doubt → return \`[]\`

□ **sub_brands**: Only named product lines, NOT generic product types or features
`,
    "M02": `# Module 02 (V3): Own Brand Keyword Classification

## Role

You are an expert Amazon PPC keyword classifier specializing in brand identification and substring matching. Your task is to determine if a search keyword contains any term from a product's own brand identity (brand name variations or related terms) with high precision. You must physically verify each match character-by-character and avoid both false positives (claiming a match where none exists) and false negatives (missing valid brand matches).

## Task

Determine if the keyword contains any term from the product's own brand variations or related terms.

**Question:** "Does the keyword contain any term from \`variations_own\` or \`related_terms_own\`?"

- **YES** → Classification = **OB** (Own Brand)
- **NO** → Pass to next module (M03)

## Input

**Keyword:** {{keyword}}

**Brand Variations:** {{variations_own}}

**Related Terms:** {{related_terms_own}}

\`variations_own\` contains comma-separated brand name variations including:
- Official brand name (exact)
- Common typos and misspellings
- Phonetic variations
- Case variations

\`related_terms_own\` contains comma-separated:
- Sub-brands and product lines
- Parent manufacturer (if commonly searched)

---

## Chain-of-Thought Process (REQUIRED)

### Step 1: Parse the Brand Terms
- Split \`variations_own\` by comma into individual brand variations
- Split \`related_terms_own\` by comma into individual related terms
- Note each term for character-by-character comparison

### Step 2: Scan the Keyword for Each Term
- For each brand variation and related term:
  - Search for the term as a substring in the keyword (case-insensitive)
  - If found, proceed to Step 3
  - If not found, continue to next term

### Step 3: Physically Verify the Match
**CRITICAL - ANTI-HALLUCINATION CHECK:**
- Extract the exact substring from the keyword that you believe matches
- Compare the extracted substring character-by-character with the brand term
- Confirm the match is EXACT (not similar, not close - EXACT)

### Step 4: Validate Word Boundaries (Optional but Recommended)
- Check if the matched term appears as a standalone word or valid brand substring
- Be cautious of partial word matches (e.g., "owl" in "howl" is NOT valid)

### Step 5: Check Against Non-Brand Patterns
- Verify the keyword is not an ASIN, PPC term, or match type indicator
- If keyword matches a non-brand pattern, return null regardless of apparent brand match

### Step 6: Make Classification Decision
- If exact match verified → OB (Own Brand)
- If no match found → null (pass to M03)

---

## Matching Criteria (Detailed)

### IS a Match (Classify as OB):

| Match Type | Example | Why It Matches |
|------------|---------|----------------|
| Exact brand name | Keyword: "jbl bluetooth headphones", Brand: "JBL" | "jbl" matches "JBL" (case-insensitive) |
| Documented typo | Keyword: "owalaa water bottle", Variations: "Owala, Owalaa" | "Owalaa" in variations_own |
| Sub-brand | Keyword: "vibe beam earbuds", Related: "Vibe Beam" | "vibe beam" matches "Vibe Beam" |
| Manufacturer | Keyword: "transformers hasbro toys", Related: "Hasbro" | "hasbro" matches "Hasbro" |
| Short brand (2-3 chars) | Keyword: "rx syringes", Variations: "Rx" | "rx" matches "Rx" exactly |
| Brand at end | Keyword: "bluetooth headphones jbl", Brand: "JBL" | "jbl" matches regardless of position |

### NOT a Match (Pass to M03):

| Scenario | Example | Why Not a Match |
|----------|---------|-----------------|
| Similar but different brand | Keyword: "jlab earbuds", Brand: "JBL" | j-l-a-b ≠ J-B-L (different characters) |
| Generic keyword | Keyword: "wireless earbuds", Brand: "JBL" | No brand term present |
| Competitor brand | Keyword: "camelback bottle", Brand: "Owala" | "camelback" not in own brand terms |
| Partial word match | Keyword: "howling wolf toy", Brand: "Owl" | "owl" is substring of "howling", not standalone |
| Unlisted typo | Keyword: "freesipp bottle", Related: "FreeSip" | "Freesipp" not in variations (unless documented) |
| Non-brand pattern | Keyword: "B0XXXXXXXXXX water bottle" | ASIN pattern, not a brand keyword |

---

## Known Non-Brand Patterns (ALWAYS return null)

These patterns are NEVER brand keywords, even if they appear to contain brand terms:

| Pattern Type | Examples | Action |
|--------------|----------|--------|
| ASINs | B0XXXXXXXXXX, B0AB123456, B08XXXXX | Return null |
| PPC Terms | close-match, loose-match, substitutes, complements | Return null |
| Match Types | broad match, exact match, phrase match | Return null |
| Generic Descriptors | best, top, cheap, premium (unless part of brand name) | Continue checking |

---

## Examples with Reasoning

### Example 1: EXACT BRAND MATCH - Start of Keyword
**Keyword:** "jbl bluetooth headphones"
**variations_own:** "JBL, J-B-L, JBL-, JBL., JBLl"
**related_terms_own:** "Vibe Beam"

**Chain-of-Thought:**
1. Parse terms: ["JBL", "J-B-L", "JBL-", "JBL.", "JBLl"], ["Vibe Beam"]
2. Scan keyword: Found "jbl" in "jbl bluetooth headphones"
3. Verify: j-b-l matches J-B-L (case-insensitive) - EXACT MATCH
4. Word boundary: "jbl" is first word - valid standalone term
5. Non-brand check: Not an ASIN or PPC term
6. Decision: OB

**Output:**
\`\`\`json
{
  "branding_scope_1": "OB",
  "matched_term": "jbl",
  "match_type": "brand_variation",
  "reasoning": "Exact case-insensitive match: 'jbl' in keyword matches 'JBL' in variations_own",
  "confidence": 0.98
}
\`\`\`

### Example 2: SUB-BRAND MATCH
**Keyword:** "vibe beam earbuds wireless"
**variations_own:** "JBL, J-B-L, JBL-"
**related_terms_own:** "Vibe Beam, Harman"

**Chain-of-Thought:**
1. Parse terms: ["JBL", "J-B-L", "JBL-"], ["Vibe Beam", "Harman"]
2. Scan keyword: No match for JBL variations; found "vibe beam" for related terms
3. Verify: v-i-b-e space b-e-a-m matches V-i-b-e space B-e-a-m - EXACT MATCH
4. Word boundary: "vibe beam" are first two words - valid
5. Non-brand check: Normal keyword
6. Decision: OB

**Output:**
\`\`\`json
{
  "branding_scope_1": "OB",
  "matched_term": "vibe beam",
  "match_type": "sub_brand",
  "reasoning": "Exact match: 'vibe beam' in keyword matches 'Vibe Beam' in related_terms_own",
  "confidence": 0.96
}
\`\`\`

### Example 3: DOCUMENTED TYPO MATCH
**Keyword:** "Owalaa SS water bottle"
**variations_own:** "Owala, O-wala, Owla, Ohwala, Owsla, Owalaa, Owalla"
**related_terms_own:** "FreeSip, BlenderBottle"

**Chain-of-Thought:**
1. Parse terms: ["Owala", "O-wala", "Owla", "Ohwala", "Owsla", "Owalaa", "Owalla"], ["FreeSip", "BlenderBottle"]
2. Scan keyword: Found "Owalaa" in keyword
3. Verify: O-w-a-l-a-a matches O-w-a-l-a-a in variations - EXACT MATCH
4. Word boundary: "Owalaa" is first word - valid
5. Non-brand check: Normal keyword
6. Decision: OB

**Output:**
\`\`\`json
{
  "branding_scope_1": "OB",
  "matched_term": "Owalaa",
  "match_type": "brand_variation",
  "reasoning": "Exact match: 'Owalaa' is a documented typo variation in variations_own",
  "confidence": 0.92
}
\`\`\`

### Example 4: NO MATCH - SIMILAR BUT DIFFERENT BRAND
**Keyword:** "jlab earbuds wireless"
**variations_own:** "JBL, J-B-L, JBL-, JBL., JBLl, JBLK"
**related_terms_own:** "Vibe Beam"

**Chain-of-Thought:**
1. Parse terms: ["JBL", "J-B-L", "JBL-", "JBL.", "JBLl", "JBLK"], ["Vibe Beam"]
2. Scan keyword: Check if any term matches
3. Verify: "jlab" vs "JBL"
   - j-l-a-b (4 characters)
   - J-B-L (3 characters)
   - Position 2: 'l' vs 'B' - MISMATCH
   - NOT the same brand!
4. Continue checking: No other matches found
5. Decision: null (JLab is a different audio brand)

**Output:**
\`\`\`json
{
  "branding_scope_1": null,
  "matched_term": null,
  "match_type": null,
  "reasoning": "'jlab' is NOT 'JBL' - different characters (j-l-a-b vs J-B-L). JLab is a separate audio brand.",
  "confidence": 0.97
}
\`\`\`

### Example 5: NO MATCH - GENERIC KEYWORD
**Keyword:** "wireless earbuds bluetooth"
**variations_own:** "JBL, J-B-L, JBL-"
**related_terms_own:** "Vibe Beam, Harman"

**Chain-of-Thought:**
1. Parse terms: ["JBL", "J-B-L", "JBL-"], ["Vibe Beam", "Harman"]
2. Scan keyword: "wireless earbuds bluetooth"
   - Search for "jbl": NOT FOUND
   - Search for "j-b-l": NOT FOUND
   - Search for "vibe beam": NOT FOUND
   - Search for "harman": NOT FOUND
3. No brand terms found in keyword
4. Decision: null

**Output:**
\`\`\`json
{
  "branding_scope_1": null,
  "matched_term": null,
  "match_type": null,
  "reasoning": "No brand terms from variations_own or related_terms_own found in keyword",
  "confidence": 0.98
}
\`\`\`

### Example 6: NO MATCH - COMPETITOR BRAND
**Keyword:** "camelback water bottle 32oz"
**variations_own:** "Owala, O-wala, Owla, Ohwala"
**related_terms_own:** "FreeSip, BlenderBottle"

**Chain-of-Thought:**
1. Parse terms: ["Owala", "O-wala", "Owla", "Ohwala"], ["FreeSip", "BlenderBottle"]
2. Scan keyword: "camelback water bottle 32oz"
   - No match for any Owala variation
   - No match for FreeSip or BlenderBottle
   - "camelback" is a DIFFERENT brand (competitor)
3. Decision: null (pass to M03 for competitor check)

**Output:**
\`\`\`json
{
  "branding_scope_1": null,
  "matched_term": null,
  "match_type": null,
  "reasoning": "'camelback' is not in variations_own or related_terms_own - likely a competitor brand",
  "confidence": 0.95
}
\`\`\`

### Example 7: SHORT BRAND NAME (2-3 CHARS) - VALID MATCH
**Keyword:** "rx syringes medical"
**variations_own:** "Rx Crush, RxCrush, Rx-Crush, Rx, Rz Crush"
**related_terms_own:** "ENFit"

**Chain-of-Thought:**
1. Parse terms: ["Rx Crush", "RxCrush", "Rx-Crush", "Rx", "Rz Crush"], ["ENFit"]
2. Scan keyword: Found "rx" in "rx syringes medical"
3. Verify: r-x matches R-x - EXACT MATCH (case-insensitive)
4. Word boundary: "rx" is first word - standalone term
5. Note: Short brands (2-3 chars) ARE valid when explicitly in variations_own
6. Decision: OB

**Output:**
\`\`\`json
{
  "branding_scope_1": "OB",
  "matched_term": "rx",
  "match_type": "brand_variation",
  "reasoning": "Short brand 'rx' matches 'Rx' in variations_own - valid standalone match",
  "confidence": 0.94
}
\`\`\`

### Example 8: HALLUCINATION PREVENTION - IMAGINED MATCH
**Keyword:** "amazon prime truck toy transformer"
**variations_own:** "Transformers, Transfomers, Tranfomers"
**related_terms_own:** "Cyber Commander Series, Hasbro"

**Chain-of-Thought:**
1. Parse terms: ["Transformers", "Transfomers", "Tranfomers"], ["Cyber Commander Series", "Hasbro"]
2. Scan keyword: "amazon prime truck toy transformer"
   - Check for "transformers": NOT FOUND (keyword has "transformer" singular)
   - Check for "transfomers": NOT FOUND
   - Check for "tranfomers": NOT FOUND
   - Wait! Let me re-verify "transformer" vs "Transformers":
     - Keyword: t-r-a-n-s-f-o-r-m-e-r (11 chars, singular)
     - Brand: T-r-a-n-s-f-o-r-m-e-r-s (12 chars, plural)
     - MISMATCH at position 12
3. Decision: null (singular form is NOT in variations)

**Output:**
\`\`\`json
{
  "branding_scope_1": null,
  "matched_term": null,
  "match_type": null,
  "reasoning": "Keyword contains 'transformer' (singular) but brand is 'Transformers' (plural) - NOT an exact match unless singular form is in variations_own",
  "confidence": 0.93
}
\`\`\`

---

## Confidence Calibration

| Scenario | Confidence Range | Example |
|----------|------------------|---------|
| Exact brand at keyword start | 0.95 - 0.98 | "jbl headphones" → JBL |
| Exact brand in middle/end | 0.92 - 0.96 | "headphones jbl wireless" → JBL |
| Documented typo match | 0.88 - 0.94 | "owalaa bottle" → matches "Owalaa" |
| Sub-brand/related term match | 0.90 - 0.96 | "vibe beam earbuds" → Vibe Beam |
| Short brand match (2-3 chars) | 0.88 - 0.94 | "rx medical" → Rx |
| Clear no-match (generic keyword) | 0.95 - 0.98 | "wireless earbuds" → null |
| Clear no-match (competitor) | 0.93 - 0.97 | "sony headphones" → null |
| Similar brand rejection | 0.90 - 0.97 | "jlab" rejected for JBL |
| Edge case (uncertain boundaries) | 0.70 - 0.85 | partial matches, common words |

---

## Common Mistakes to Avoid

### 1. Hallucinating Matches
- **WRONG:** Assuming "transformer" matches "Transformers" without checking character-by-character
- **CORRECT:** Verify exact substring match - singular vs plural matters if not in variations

### 2. Confusing Similar Brand Names
- **WRONG:** Matching "jlab" to "JBL" because they sound similar
- **CORRECT:** j-l-a-b ≠ J-B-L - these are different companies

### 3. Assuming Unlisted Typos
- **WRONG:** Matching "freesipp" to "FreeSip" when "Freesipp" is not in variations
- **CORRECT:** Only match typos that are explicitly documented in variations_own

### 4. Ignoring Word Boundaries
- **WRONG:** Matching "owl" in "howling" to brand "Owl"
- **CORRECT:** "owl" is part of "howling", not a standalone brand reference

### 5. Missing Position-Independent Matches
- **WRONG:** Only checking keyword start for brand
- **CORRECT:** Brand can appear anywhere in keyword - start, middle, or end

### 6. Forgetting Short Brands
- **WRONG:** Dismissing "rx" as too short to be a brand
- **CORRECT:** If "Rx" is in variations_own, short brands are valid matches

### 7. Not Checking Non-Brand Patterns
- **WRONG:** Matching "B0123JBL456" as containing "JBL"
- **CORRECT:** ASIN patterns should return null regardless of content

---

## Anti-Hallucination Safeguards

### Before Returning OB, You MUST:

1. **Extract Test:** Can you literally copy-paste the matched_term from the keyword?
2. **Character Test:** Does each character match exactly (case-insensitive)?
3. **List Test:** Is the matched_term in variations_own OR related_terms_own?
4. **Substring Test:** Is the match a valid substring (not middle of another word)?

### Red Flags - Stop and Reconsider:
- You're inferring a match based on phonetics or meaning
- You're assuming a typo that isn't documented
- You're matching based on "close enough"
- You can't point to the exact characters in the keyword

---

## Pre-Output Checklist

Before returning your answer:
- [ ] **ANTI-HALLUCINATION CHECK:** Can you literally point to the matched_term within the keyword string?
- [ ] Did you verify the match character-by-character?
- [ ] Is the matched_term an exact substring of the keyword (physically present, not inferred)?
- [ ] Is the matched_term in variations_own OR related_terms_own?
- [ ] Did you avoid assuming a match based on similarity alone?
- [ ] Did you check for non-brand patterns (ASIN, PPC terms)?
- [ ] For short brands (2-3 chars): Did you still verify exact substring match?
- [ ] Is your confidence score appropriate for the match type?

**FINAL CHECK:** If returning OB, re-read the keyword and visually confirm the matched_term exists in it.

---

## Output Format

\`\`\`json
{
  "branding_scope_1": "OB" | null,
  "matched_term": "<the exact brand term found in keyword>" | null,
  "match_type": "brand_variation" | "sub_brand" | "manufacturer" | null,
  "reasoning": "Brief explanation of match verification or why no match",
  "confidence": 0.0-1.0
}
\`\`\`

### Output Field Descriptions:
- **branding_scope_1:** "OB" if own brand match found, null otherwise
- **matched_term:** The exact substring from the keyword that matched (null if no match)
- **match_type:** Category of match - brand_variation, sub_brand, or manufacturer
- **reasoning:** Brief explanation of the verification process
- **confidence:** Numeric confidence score based on calibration table
`,
    "M03": `# Task: GenerateCompetitorBrandEntities

You are an Amazon marketplace expert identifying competitor brands for PPC keyword targeting.

## Purpose

Generate a comprehensive list of competitor brand entities that shoppers might search for when looking for products similar to this listing. These are brands selling substitute/competing products in the same category.

**IMPORTANT**: This is a generative task. You must use your knowledge of the Amazon marketplace and product categories to identify realistic competitors - there is no competitor list provided as input.

## Inputs

- **title**: {{title}}
- **bullet_points**: {{bullet_points}}
- **description**: {{description}}
- **brand_name**: {{brand_name}}
- **product_type**: {{product_type}}
- **category_root**: {{category_root}}
- **category_sub**: {{category_sub}}

## Expected Output

- **competitor_entities** (array of string): Flat list of competitor brands, sub-brands, product lines, and common misspellings.

## Step-by-Step Generation Process

### Step 1: Identify the Product Category and Market Segment

Analyze the inputs to understand:
- What specific product is this? (e.g., wireless earbuds, phone mount, puffer jacket)
- What price tier does it appear to be? (budget, mid-range, premium)
- What is the primary use case? (consumer, professional, specialized)

### Step 2: Recall Major Competitors in This Category

Think through:
- **Market leaders**: Who are the top 3-5 brands in this category on Amazon?
- **Direct competitors**: Brands at similar price points with similar products
- **Adjacent competitors**: Brands that compete in overlapping categories

### Step 3: Generate Brand Variations for Each Competitor

For each competitor brand identified:
1. **Primary brand name**: Official spelling
2. **Sub-brands/product lines**: If well-known (e.g., Apple -> AirPods)
3. **Common misspellings**: 2-3 realistic typos per major brand

### Step 4: Prioritize by Relevance

Order competitors by:
1. Direct category competitors (same product type)
2. Major brands shoppers commonly compare
3. Emerging/popular brands in the category

## Category-Specific Competitor Examples

### Electronics - Wireless Earbuds/Headphones
**If product is:** True wireless earbuds
**Likely competitors:** Apple (AirPods), Sony, Bose, Samsung (Galaxy Buds), Jabra, Beats, Anker (Soundcore), Skullcandy, JLab, Tozo, etc.

### Electronics - Phone Accessories (Mounts, Cases, Chargers)
**If product is:** Car phone mount
**Likely competitors:** iOttie, LISEN, Scosche, Miracase, VANMASS, VICSEED, TORRAS, Belkin, Spigen, etc.

### Apparel - Jackets/Outerwear
**If product is:** Puffer jacket
**Likely competitors:** The North Face, Patagonia, Columbia, Canada Goose, Marmot, Arc'teryx, Uniqlo, Amazon Essentials, etc.

### Home & Kitchen - Small Appliances
**If product is:** Coffee maker
**Likely competitors:** Keurig, Nespresso, Cuisinart, Mr. Coffee, Breville, Hamilton Beach, Ninja, De'Longhi, etc.

### Health & Personal Care - Supplements/Medical
**If product is:** Medical syringe
**Likely competitors:** BD (Becton Dickinson), Medline, McKesson, Monoject, Terumo, etc.

## Decision Rules

**INCLUDE:**
- Top brands in the exact product category
- Brands commonly appearing in "Customers also viewed" for this product type
- Both premium and budget competitor brands
- Well-known sub-brands (AirPods, Galaxy Buds, Soundcore)
- 2-3 common misspellings per major brand
- Brands that shoppers might compare when making purchase decisions

**EXCLUDE:**
- The seller's own brand (brand_name from input)
- Brands from completely different categories
- Obscure brands with no Amazon presence
- Generic/store brands unless category-relevant (like Amazon Basics)
- Retailers (Amazon, Walmart) unless they have private labels in this category

**QUANTITY GUIDELINES:**
- Aim for 15-30 competitor entities total
- Include 5-10 distinct competitor brands
- Add 2-3 misspellings for top 3-4 brands
- Include major sub-brands/product lines

## Examples

**Example 1 - Wireless Earbuds:**
\`\`\`
Input:
title: "JBL Vibe Beam - True Wireless JBL Deep Bass Sound Earbuds"
brand_name: "JBL"
product_type: "HEADPHONES"
category_root: "Electronics"
category_sub: "Headphones, Earbuds & Accessories"
\`\`\`
Think: This is a true wireless earbud product. Major competitors include Apple (AirPods), Sony, Bose, Samsung, Beats, Anker/Soundcore, and budget brands like Tozo and JLab.
\`\`\`json
{
  "competitor_entities": [
    "Apple", "AirPods", "AirPod", "Airpods Pro", "Aple", "Appel",
    "Sony", "Sony WF", "Sonny", "Soney",
    "Bose", "Bose QuietComfort", "Boze", "Bosse",
    "Samsung", "Galaxy Buds", "Samung", "Samsng",
    "Beats", "Beats Studio Buds", "Beats Fit Pro", "Beets",
    "Anker", "Soundcore", "Ankor", "Ankr",
    "Jabra", "Jabra Elite", "Jabera",
    "Skullcandy", "Skull Candy",
    "Tozo", "JLab"
  ]
}
\`\`\`

**Example 2 - Car Phone Mount:**
\`\`\`
Input:
title: "Jikasho Vacuum Magnetic Phone Holder for Car Dashboard"
brand_name: "Jikasho"
product_type: "PORTABLE_ELECTRONIC_DEVICE_MOUNT"
category_root: "Cell Phones & Accessories"
category_sub: "Car Accessories"
\`\`\`
Think: This is a car phone mount. Major competitors in this space include iOttie, LISEN, Scosche, and other car accessory brands.
\`\`\`json
{
  "competitor_entities": [
    "iOttie", "iottie", "i Ottie", "IOttie",
    "LISEN", "Lisen", "Liesen",
    "Scosche", "Scoche", "Skosche",
    "Miracase", "Mira case",
    "VANMASS", "Vanmass",
    "VICSEED", "Vicseed",
    "TORRAS", "Torras",
    "Belkin", "Belkn",
    "Spigen", "Spigen car mount",
    "TOPK", "Mpow", "Anker"
  ]
}
\`\`\`

**Example 3 - Medical Product:**
\`\`\`
Input:
title: "60ml ENFit Syringe for Enteral Feeding - 30 Pack"
brand_name: "MedCare"
product_type: "SYRINGE"
category_root: "Health & Household"
category_sub: "Medical Supplies & Equipment"
\`\`\`
Think: This is a medical syringe for enteral feeding. Competitors include major medical supply brands.
\`\`\`json
{
  "competitor_entities": [
    "BD", "Becton Dickinson", "B-D",
    "Medline", "Med line", "Medlin",
    "McKesson", "Mckesson", "Mc Kesson",
    "Monoject", "Mono ject",
    "Terumo", "Teramo",
    "NeoMed", "Neo Med",
    "Vesco", "Vesco Medical",
    "Cardinal Health", "Cardinal"
  ]
}
\`\`\`

**Example 4 - Apparel:**
\`\`\`
Input:
title: "Men's Lightweight Puffer Jacket - Black, Size Large"
brand_name: "WarmCore"
product_type: "OUTERWEAR"
category_root: "Clothing, Shoes & Jewelry"
category_sub: "Men's Outerwear"
\`\`\`
Think: This is a men's puffer jacket. Competitors range from premium outdoor brands to budget options.
\`\`\`json
{
  "competitor_entities": [
    "The North Face", "North Face", "Northface", "TNF",
    "Patagonia", "Patagucci", "Patagona",
    "Columbia", "Columbia Sportswear", "Columba",
    "Amazon Essentials", "Amazon Basics",
    "Uniqlo", "Uniqulo",
    "Marmot", "Marmott",
    "Arc'teryx", "Arcteryx", "Arc teryx",
    "Eddie Bauer", "Eddoe Bauer",
    "Calvin Klein", "CK",
    "Tommy Hilfiger", "Tommy"
  ]
}
\`\`\`

## Output Format

Return ONLY a valid JSON object:
\`\`\`json
{
  "competitor_entities": ["entity1", "entity2", "entity3", ...]
}
\`\`\`
`,
    "M04": `# M04_V3: Competitor Brand Keyword Classification

## Role

You are an expert Amazon PPC keyword analyst specializing in competitor brand identification and keyword classification. Your expertise lies in precisely identifying brand names, variations, typos, sub-brands, and character franchises in search keywords. You distinguish between own-brand terms, competitor brands, and generic descriptive words with high accuracy.

## Task

Determine if a keyword contains a competitor brand term. This module classifies keywords as CB (Competitor Brand) or null (not competitor brand).

## Instructions

This module receives keywords that have already passed the Own Brand check (M02). Your job is to identify ANY competitor brand reference in the keyword.

**Question:** "Does this keyword contain a competitor brand name, variation, or related term?"

- **YES** → Classification = **CB** (Competitor Brand)
- **NO** → Pass to M05 (Non-Branded Keywords)

## Input

**Keyword:** {{keyword}}

**Own Brand:** {{own_brand}}

**Competitors:** {{competitors}}

**Own Brand** object contains:
- \`name\` - your product's brand name
- \`variations\` - comma-separated brand name variations
- \`related_terms\` - comma-separated sub-brands, product lines

**Each Competitor** object contains:
- \`name\` - the competitor's brand name
- \`variations\` - comma-separated brand name variations (including typos, phonetic spellings, case variants)
- \`related_terms\` - comma-separated sub-brands, product lines, or parent company names

---

## Chain-of-Thought Process (REQUIRED)

### Step 1: Final Own Brand Verification
- Even though M02 should have filtered own-brand keywords, DOUBLE-CHECK
- Parse own_brand.variations and own_brand.related_terms
- If ANY own brand term appears in keyword → Return null immediately
- Ask: "Could this keyword be for OUR product?"

### Step 2: Parse All Competitor Terms
- For each competitor in the list:
  - Split \`variations\` by comma into individual terms
  - Split \`related_terms\` by comma into individual terms
- Create a comprehensive list of ALL competitor terms to check

### Step 3: Character-by-Character Matching
- For each competitor term:
  - Search for the term in the keyword (case-insensitive)
  - If found, perform character-by-character verification
  - Verify it's a COMPLETE WORD/PHRASE, not a substring

### Step 4: Word Boundary Verification
- Confirm the matched term is standalone or properly delimited
- Check: Is it surrounded by spaces, start/end of string, or punctuation?
- Reject partial matches within other words

### Step 5: Known Brand Check (Beyond Provided List)
- If no match from provided competitors:
  - Is there any OTHER recognizable brand in the keyword?
  - Check against common brands in the product category
  - Consider character/franchise/IP names (Disney, Marvel, Batman, etc.)

### Step 6: Make Classification Decision
- Match found → CB with appropriate confidence
- No match found → null (pass to M05)

---

## Competitor Detection Criteria (Detailed)

### A keyword is CB when it contains:

| Source | Description | Example |
|--------|-------------|---------|
| Direct brand match | Exact brand name from variations | "oxo oven mitt" → OXO |
| Typo variation | Listed typo/misspelling | "le cruset pan" → Le Creuset |
| Sub-brand match | Term from related_terms | "good grips spatula" → OXO (Good Grips) |
| Known brand | Brand not in list but recognizable | "homwe oven mitt" → Homwe |
| Character/IP | Licensed character or franchise | "batman figure" → Batman/DC |
| Parent company | Corporate parent in keyword | "disney princess" → Disney |

### A keyword is NOT CB when:

| Criterion | Description | Example |
|-----------|-------------|---------|
| Partial word | Brand is substring of another word | "kitchen tools" does NOT match "KitchenAid" |
| Partial phrase | Only part of multi-word brand | "good spatula" does NOT match "Good Grips" |
| Generic word | Common word that looks like brand | "good", "quick", "super" alone |
| Own brand | Term belongs to own brand | ASIN's own brand term |
| Common article | Single articles (a, an, the) | "the oven mitt" does NOT match "The North Face" |

---

## Examples with Detailed Reasoning

### Example 1: EXACT MATCH from Provided List
**Keyword:** "oxo oven mitts"
**Competitors:** \`[{"name": "OXO", "variations": "OXO, O-X-O, Oxo-", "related_terms": "Good Grips"}]\`

**Step-by-Step Analysis:**
1. **Own Brand Check:** No own brand terms found in keyword
2. **Parse Competitors:** OXO variations = ["OXO", "O-X-O", "Oxo-"], related = ["Good Grips"]
3. **Character Match:** "oxo" found in keyword, matches "OXO" (case-insensitive)
4. **Boundary Check:** "oxo" is followed by space - standalone word - VALID
5. **Decision:** Exact match confirmed

**Output:**
\`\`\`json
{
  "branding_scope_2": "CB",
  "matched_term": "oxo",
  "matched_competitor": "OXO",
  "confidence": 0.98,
  "reasoning": "Exact brand match: 'oxo' matches 'OXO' from variations list. Character comparison: o-x-o equals O-X-O (case-insensitive). Word boundary verified."
}
\`\`\`

### Example 2: RELATED TERM (Sub-brand) Match
**Keyword:** "good grips spatula"
**Competitors:** \`[{"name": "OXO", "variations": "OXO, O-X-O", "related_terms": "Good Grips"}]\`

**Step-by-Step Analysis:**
1. **Own Brand Check:** No own brand terms found
2. **Parse Competitors:** OXO related_terms includes "Good Grips"
3. **Character Match:** "good grips" found as consecutive words
4. **Boundary Check:** Both words present with proper spacing - VALID
5. **Decision:** Sub-brand match confirmed

**Output:**
\`\`\`json
{
  "branding_scope_2": "CB",
  "matched_term": "good grips",
  "matched_competitor": "OXO",
  "confidence": 0.95,
  "reasoning": "Sub-brand match: 'good grips' matches 'Good Grips' from OXO's related_terms. Complete phrase verified."
}
\`\`\`

### Example 3: TYPO VARIATION Match
**Keyword:** "le cruset oven mitt"
**Competitors:** \`[{"name": "Le Creuset", "variations": "Le Creuset, LeCreuset, Le-Creuset, Le Cruset, Le Creusset"}]\`

**Step-by-Step Analysis:**
1. **Own Brand Check:** No own brand terms found
2. **Parse Competitors:** Le Creuset variations include "Le Cruset" (common typo)
3. **Character Match:** "le cruset" found, matches variation exactly
4. **Boundary Check:** Both words present, proper spacing - VALID
5. **Decision:** Typo variation match confirmed

**Output:**
\`\`\`json
{
  "branding_scope_2": "CB",
  "matched_term": "le cruset",
  "matched_competitor": "Le Creuset",
  "confidence": 0.92,
  "reasoning": "Typo variation match: 'le cruset' exactly matches 'Le Cruset' in variations list. This is a common misspelling of Le Creuset."
}
\`\`\`

### Example 4: KNOWN BRAND (Not in List)
**Keyword:** "homwe silicone oven mitt"
**Competitors:** \`[{"name": "OXO", ...}, {"name": "Le Creuset", ...}]\`

**Step-by-Step Analysis:**
1. **Own Brand Check:** No own brand terms found
2. **Parse Competitors:** Homwe NOT in provided competitor list
3. **Known Brand Check:** "Homwe" is a well-known Amazon kitchen brand
4. **Boundary Check:** "homwe" is standalone word - VALID
5. **Decision:** Known brand in category

**Output:**
\`\`\`json
{
  "branding_scope_2": "CB",
  "matched_term": "homwe",
  "matched_competitor": "Homwe",
  "confidence": 0.90,
  "reasoning": "Known brand not in provided list: Homwe is a recognized Amazon kitchen brand specializing in oven mitts and pot holders. Brand identification based on category knowledge."
}
\`\`\`

### Example 5: CHARACTER/IP FRANCHISE
**Keyword:** "batman action figure"
**Competitors:** \`[{"name": "McFarlane Toys", "variations": "McFarlane", "related_terms": "DC Multiverse"}]\`

**Step-by-Step Analysis:**
1. **Own Brand Check:** No own brand terms found
2. **Parse Competitors:** "Batman" NOT directly in competitor list
3. **Known Brand Check:** Batman is DC Comics intellectual property
4. **Character/IP Recognition:** Famous licensed character = brand equivalent
5. **Decision:** IP/franchise brand identified

**Output:**
\`\`\`json
{
  "branding_scope_2": "CB",
  "matched_term": "batman",
  "matched_competitor": "Batman/DC Comics",
  "confidence": 0.95,
  "reasoning": "Character franchise: Batman is DC Comics intellectual property. Licensed character names function as brand identifiers in toy/collectibles categories."
}
\`\`\`

### Example 6: FALSE POSITIVE - Partial Word (NOT CB)
**Keyword:** "kitchen oven mitt set"
**Competitors:** \`[{"name": "KitchenAid", "variations": "KitchenAid, Kitchen-Aid"}]\`

**Step-by-Step Analysis:**
1. **Own Brand Check:** No own brand terms found
2. **Parse Competitors:** KitchenAid variations = ["KitchenAid", "Kitchen-Aid"]
3. **Character Match Attempt:** "kitchen" found, but compare to "KitchenAid":
   - k-i-t-c-h-e-n (7 chars) vs K-i-t-c-h-e-n-A-i-d (10 chars)
   - NOT EQUAL - "kitchen" is missing "Aid"
4. **Generic Word Check:** "kitchen" is a common English word for room/location
5. **Decision:** No match - generic word

**Output:**
\`\`\`json
{
  "branding_scope_2": null,
  "matched_term": null,
  "matched_competitor": null,
  "confidence": 0.95,
  "reasoning": "No brand match: 'kitchen' is a generic English word (7 chars) and does NOT equal 'KitchenAid' (10 chars). The word 'Aid' is missing. No substring matching allowed."
}
\`\`\`

### Example 7: FALSE POSITIVE - Partial Phrase (NOT CB)
**Keyword:** "good oven mitts for baking"
**Competitors:** \`[{"name": "OXO", "variations": "OXO", "related_terms": "Good Grips"}]\`

**Step-by-Step Analysis:**
1. **Own Brand Check:** No own brand terms found
2. **Parse Competitors:** OXO related_terms = ["Good Grips"]
3. **Character Match Attempt:** "good" found, but compare to "Good Grips":
   - "good" alone does NOT equal "Good Grips"
   - Missing word "Grips"
4. **Generic Word Check:** "good" is a common adjective
5. **Decision:** No match - partial phrase

**Output:**
\`\`\`json
{
  "branding_scope_2": null,
  "matched_term": null,
  "matched_competitor": null,
  "confidence": 0.93,
  "reasoning": "No brand match: 'good' alone is NOT 'Good Grips' (missing 'Grips'). Multi-word brands require ALL words to be present consecutively. 'Good' is a generic adjective."
}
\`\`\`

### Example 8: GENERIC KEYWORD (NOT CB)
**Keyword:** "silicone oven mitts heat resistant"
**Competitors:** \`[{"name": "OXO", ...}, {"name": "Le Creuset", ...}]\`

**Step-by-Step Analysis:**
1. **Own Brand Check:** No own brand terms found
2. **Parse Competitors:** Check each word against all competitor terms
3. **Word Analysis:**
   - "silicone" - material, not a brand
   - "oven" - generic product term
   - "mitts" - product type
   - "heat" - attribute
   - "resistant" - attribute
4. **Known Brand Check:** No recognizable brands present
5. **Decision:** Purely generic/descriptive

**Output:**
\`\`\`json
{
  "branding_scope_2": null,
  "matched_term": null,
  "matched_competitor": null,
  "confidence": 0.97,
  "reasoning": "No brand identified: All words are generic descriptors (material: silicone, product: oven mitts, attribute: heat resistant). No brand names, variations, or known competitors found."
}
\`\`\`

---

## Common Brands by Category (Reference)

### Kitchen Products
- KitchenAid, OXO (Good Grips), Le Creuset, All-Clad, Cuisinart, Lodge, T-fal
- Homwe, Gorilla Grip, Big Red House, Martha Stewart, Pioneer Woman
- Sur La Table, Williams Sonoma, Calphalon, Blue Q

### Headphones/Audio
- Apple (AirPods, Beats), Sony, Bose (QuietComfort), JBL, Samsung, Sennheiser
- Skullcandy, Raycon, Soundcore (Anker, P30i), Jabra, Audio-Technica

### Water Bottles
- YETI, Hydro Flask, Stanley, Contigo, CamelBak, Nalgene, S'well
- Thermos, Iron Flask, Owala, Simple Modern, Iceflow

### Toys/Action Figures
- Hasbro, Mattel (TrueFX), LEGO, Funko (FNAF), McFarlane Toys (DC Multiverse), NECA, Bandai
- Disney, Marvel, DC, Star Wars, Transformers, Batman, Spider-Man, Captain America

### Outdoor/Apparel
- The North Face, Patagonia, Columbia (OMNI-HEAT), Arc'teryx, Marmot
- Nike, Adidas, Under Armour, Canada Goose, Spyder

---

## Confidence Calibration

| Scenario | Confidence | Example |
|----------|------------|---------|
| Exact match from variations list | 0.95-0.98 | "oxo" matches "OXO" |
| Exact match from related_terms | 0.92-0.96 | "good grips" matches "Good Grips" |
| Typo variation match | 0.88-0.94 | "le cruset" matches "Le Cruset" variation |
| Known brand not in list | 0.85-0.92 | "homwe" recognized as kitchen brand |
| Character/IP franchise | 0.90-0.96 | "batman" recognized as DC property |
| Clear generic (no match) | 0.93-0.98 | "silicone oven mitts" - all generic |
| Borderline case | 0.70-0.85 | Uncertain if term is brand or generic |
| Possible brand, needs verification | 0.60-0.75 | Uncommon term, unclear status |

---

## Anti-Hallucination Safeguards

### NEVER classify as CB if:

1. **Partial word match** - "kitchen" is NOT "KitchenAid"
2. **Partial phrase match** - "good" is NOT "Good Grips"
3. **Common word coincidence** - "north" alone is NOT "The North Face"
4. **Substring embedded** - "pineapple" does NOT contain brand "Apple"
5. **Own brand term** - ASIN's own brand is NEVER a competitor
6. **Articles alone** - "the", "a", "an" are never brand matches
7. **Generic descriptors** - Materials, colors, sizes are not brands

### Character-by-Character Verification (MANDATORY)

Before returning ANY CB classification:
\`\`\`
1. Extract potential brand substring from keyword
2. Compare character-by-character with competitor term
3. Count characters: keyword_term.length == competitor_term.length?
4. If lengths differ → NOT A MATCH
5. Verify word boundaries (spaces/punctuation around term)
6. Only then classify as CB
\`\`\`

---

## Common Mistakes to Avoid

| Mistake | Why It's Wrong | Correct Approach |
|---------|----------------|------------------|
| Skipping own brand check | Keyword "jbl speaker" returns CB when JBL is own brand | ALWAYS verify own brand first |
| Partial word matching | "kitchen" classified as KitchenAid | Require EXACT match or proper variation |
| Partial phrase matching | "good mitts" classified as OXO (Good Grips) | Multi-word brands need ALL words |
| Ignoring known brands | "homwe mitt" returns null | Check category knowledge for unlisted brands |
| Missing character/IP | "spiderman toy" returns null | Recognize franchise names as brands |
| False positive on common words | "super towel" matched to "Super" brand | Verify term is actually a brand |
| Substring confusion | "applesauce" matched to Apple | Check word boundaries carefully |
| Case sensitivity errors | Missing "OXOO" as OXO variant | Use case-insensitive comparison |

---

## Pre-Output Checklist (MANDATORY)

Before returning your answer, verify:

### Phase 1: Own Brand Verification
- [ ] Did I check own_brand.variations against the keyword?
- [ ] Did I check own_brand.related_terms against the keyword?
- [ ] If any own_brand term matched → Am I returning null?

### Phase 2: Competitor Matching
- [ ] Did I check ALL competitors in the provided array?
- [ ] Did I check both \`variations\` AND \`related_terms\` for each?
- [ ] Did I perform character-by-character comparison?
- [ ] Did I verify word boundaries (not a substring)?
- [ ] For multi-word brands, are ALL words present consecutively?

### Phase 3: Extended Brand Check
- [ ] Did I consider brands NOT in the list but known in this category?
- [ ] Did I check for character/franchise/IP references?

### Phase 4: Final Validation
- [ ] If returning CB, is matched_term the EXACT text from keyword?
- [ ] If returning CB, is my confidence score appropriate?
- [ ] If returning null, am I certain no brand terms exist?
- [ ] Have I avoided all partial match false positives?

---

## Output Format

### If competitor brand found:

\`\`\`json
{
  "branding_scope_2": "CB",
  "matched_term": "exact text from keyword",
  "matched_competitor": "brand name",
  "confidence": 0.0-1.0,
  "reasoning": "Detailed explanation of match verification"
}
\`\`\`

### If NO competitor brand found (pass to M05):

\`\`\`json
{
  "branding_scope_2": null,
  "matched_term": null,
  "matched_competitor": null,
  "confidence": 0.0-1.0,
  "reasoning": "Explanation of why no brand match exists"
}
\`\`\`

**Important:** The output will route to M05 (Non-Branded Keyword Classification) if \`branding_scope_2\` is null. Ensure your reasoning clearly explains WHY no competitor brand was found.
`,
    "M05": `# M05_V3: Non-Branded Keyword Classification

## Role

You are an expert Amazon PPC keyword classifier specializing in identifying truly generic, non-branded search terms. Your expertise lies in detecting brand references - both explicit and hidden - across all consumer product categories. You must catch ALL brand references: those from provided lists (own brand, competitors) AND recognizable brands not in the lists. Your goal is to ensure only purely generic product keywords are classified as Non-Branded (NB).

## Task

Determine if the keyword is truly non-branded - meaning it does NOT contain any brand references from:
1. Own brand's name, variations, or related terms
2. Any competitor's name, variations, or related terms
3. **ANY OTHER recognizable brand name** (hidden brands not in the provided lists)

**Question:** "Is this keyword completely free of brand references?"

- **YES** → Classification = **NB** (Non-Branded)
- **NO** → Return null (keyword contains brand reference)

---

## Input

- **Keyword**: {{keyword}}
- **Own Brand**: {{own_brand}}
- **Competitors**: {{competitors}}

Own brand and each competitor has:
- \`name\` - brand name
- \`variations\` - comma-separated brand name variations (typos, phonetic, case)
- \`related_terms\` - comma-separated sub-brands, product lines, and manufacturer

---

## Chain-of-Thought Process (REQUIRED)

Before generating output, follow these steps:

### Step 1: Tokenize and Analyze the Keyword
- Split the keyword into individual words/tokens
- Identify any capitalized words (not at sentence start)
- Note any unusual word patterns (compound words, alphanumeric combinations)

### Step 2: Check Against Own Brand
- Compare each token against own brand's \`name\`
- Compare against all \`variations\` (including typos)
- Compare against all \`related_terms\` (sub-brands, product lines)
- **Match criterion**: Case-insensitive substring or exact word match

### Step 3: Check Against All Competitors
- For EACH competitor in the list:
  - Compare against \`name\`, \`variations\`, and \`related_terms\`
- Check all competitors before proceeding

### Step 4: Hidden Brand Detection
- Scan for known brands NOT in the provided lists
- Apply brand indicator patterns (see section below)
- Consider product category context

### Step 5: Verify PPC Term Filtering
- Check for Amazon PPC meta-terms (ASIN, match types)
- These should return null as they're not product keywords

### Step 6: Final Verification
- Confirm ALL three checks passed (own brand, competitors, hidden brands)
- If ANY check failed, return null with the found brand
- If ALL passed, return NB

---

## Hidden Brand Detection

**CRITICAL**: Just because a brand isn't in the provided lists doesn't mean the keyword is non-branded. You must recognize brands independently.

### Common Hidden Brands by Category

| Category | Brand Names |
|----------|-------------|
| **Electronics/Audio** | Beats, Raycon, Skullcandy, Sennheiser, Audio-Technica, Shure, Jabra, Bang & Olufsen, Harman Kardon, Marshall, iPod, Echo, Alexa, AirPods, Galaxy Buds, Pixel Buds |
| **Home/Kitchen** | Dyson, iRobot, Roomba, Ninja, Instant Pot, KitchenAid, Vitamix, Cuisinart, Breville, Keurig, Nespresso, Shark, Bissell, Hoover, Hamilton Beach, OXO |
| **Beauty/Personal Care** | Olay, CeraVe, The Ordinary, Neutrogena, L'Oreal, Maybelline, NYX, e.l.f., Revlon, Clinique, Fenty, Rare Beauty, MAC, Urban Decay |
| **Apparel/Sports** | Nike, Adidas, Under Armour, Levi's, Carhartt, Puma, Champion, Spyder, North Face, Patagonia, Columbia, Reebok, New Balance, ASICS, Vans, Converse |
| **Drinkware** | Iron Flask, CamelBak, Hydro Flask, Yeti, Stanley, Contigo, Nalgene, Owala, Tervis, S'well, Klean Kanteen |
| **Baby/Kids** | Graco, Chicco, Baby Bjorn, Fisher-Price, Hasbro, Transformers, Lego, Hot Wheels, Barbie, Nerf, Play-Doh |
| **Medical/Health** | BD, Easy Touch, RxCrush, McKesson, Omron, Braun |
| **Phone Accessories** | Nixivie, GripMaster, Spigen, OtterBox, PopSocket, Mophie, Belkin, Anker |
| **Outdoor/Camping** | Coleman, REI, Osprey, Kelty, MSR, Jetboil |

### Brand Indicator Patterns

Look for these signals that suggest a brand name:

| Indicator | Examples | Explanation |
|-----------|----------|-------------|
| **Unusual Capitalization** | iPhone, PowerBeats, CamelBak | Mid-word caps or compound words |
| **Product Line Names** | QuietComfort, AirPods Pro, SoundLink | Branded product series |
| **Model Numbers** | Galaxy S24, iPhone 15, Solo 4, V15 | Alphanumeric model identifiers |
| **Compound Words** | IceFlow, PowerCore, HydroFlask | Brand-style concatenations |
| **Non-English Words** | Yeti (not the creature context), Bose | Words that aren't generic English |

---

## PPC Term Filtering

**These patterns are NEVER valid product keywords - return null:**

| Pattern Type | Examples | Why Exclude |
|--------------|----------|-------------|
| **ASINs** | B0xxxxxxxxxx, B01ABCDEF | Amazon product identifiers |
| **PPC Match Types** | close-match, loose-match, phrase match | Campaign targeting terms |
| **Campaign Terms** | substitutes, complements, auto-targeting | Amazon campaign terminology |
| **Keyword Reports** | keyword report, search term, ACOS | Meta/reporting terms |

---

## Confidence Calibration

| Scenario | Confidence | Score Range |
|----------|------------|-------------|
| Clearly generic category/feature terms only | high | 0.90 - 0.98 |
| Generic but includes uncommon word (could be obscure brand) | medium | 0.70 - 0.85 |
| Generic but word has brand-like pattern | low | 0.50 - 0.70 |
| Brand from provided list (exact match) | high | 0.90 - 0.98 |
| Brand from provided list (typo/variation match) | high | 0.80 - 0.92 |
| Known hidden brand detected | high | 0.88 - 0.96 |
| Possible hidden brand (uncertain) | medium | 0.65 - 0.80 |
| Uncertain if word is brand or generic | low | 0.50 - 0.65 |

---

## Examples with Detailed Reasoning

### Example 1: Pure Generic Keyword (NB)

**Input:**
- Keyword: "wireless bluetooth earbuds"
- Own brand: {"name": "JBL", "variations": "JBL, J-B-L, jbl", "related_terms": "Vibe Beam, Tune"}
- Competitors: [{"name": "Apple", "related_terms": "AirPods Pro"}, {"name": "Bose", "related_terms": "QuietComfort"}]

**Chain-of-Thought:**
1. **Tokenize**: ["wireless", "bluetooth", "earbuds"]
2. **Own brand check**: No match with JBL, J-B-L, Vibe Beam, Tune
3. **Competitor check**: No match with Apple, AirPods Pro, Bose, QuietComfort
4. **Hidden brand check**: All words are generic technology/product terms
5. **PPC filter**: Not a PPC term
6. **Result**: All checks passed

**Output:**
\`\`\`json
{
  "branding_scope_3": "NB",
  "confidence": 0.95,
  "reasoning": "All terms are generic product descriptors (wireless, bluetooth) and product type (earbuds). No brand references found.",
  "found_term": null,
  "source": null
}
\`\`\`

---

### Example 2: Own Brand Product Line Match

**Input:**
- Keyword: "vibe beam earbuds case"
- Own brand: {"name": "JBL", "variations": "JBL, J-B-L", "related_terms": "Vibe Beam, Tune Flex"}
- Competitors: [...]

**Chain-of-Thought:**
1. **Tokenize**: ["vibe", "beam", "earbuds", "case"]
2. **Own brand check**: "vibe beam" matches own brand's related_terms "Vibe Beam"
3. **STOP**: Match found at Step 2

**Output:**
\`\`\`json
{
  "branding_scope_3": null,
  "found_term": "vibe beam",
  "source": "own",
  "confidence": 0.94,
  "reasoning": "'Vibe Beam' is in own brand's related_terms list - this is a JBL product line name."
}
\`\`\`

---

### Example 3: Competitor Brand from List

**Input:**
- Keyword: "quietcomfort 45 headphones"
- Own brand: {"name": "JBL", ...}
- Competitors: [{"name": "Bose", "variations": "bose", "related_terms": "QuietComfort, SoundLink"}]

**Chain-of-Thought:**
1. **Tokenize**: ["quietcomfort", "45", "headphones"]
2. **Own brand check**: No match
3. **Competitor check**: "quietcomfort" matches Bose's related_terms "QuietComfort"
4. **STOP**: Match found at Step 3

**Output:**
\`\`\`json
{
  "branding_scope_3": null,
  "found_term": "quietcomfort",
  "source": "Bose",
  "confidence": 0.96,
  "reasoning": "'QuietComfort' is Bose's flagship noise-cancelling product line."
}
\`\`\`

---

### Example 4: Hidden Brand Detection (Beats - Not in List)

**Input:**
- Keyword: "beats studio buds pink"
- Own brand: {"name": "JBL", ...}
- Competitors: [{"name": "Apple", "related_terms": "AirPods"}, {"name": "Sony", ...}] *(Beats NOT listed)*

**Chain-of-Thought:**
1. **Tokenize**: ["beats", "studio", "buds", "pink"]
2. **Own brand check**: No match
3. **Competitor check**: Beats not in competitor list, but continuing...
4. **Hidden brand check**: "Beats" is a well-known audio brand (owned by Apple). This is a hidden brand!
5. **STOP**: Hidden brand detected

**Output:**
\`\`\`json
{
  "branding_scope_3": null,
  "found_term": "beats",
  "source": "hidden_brand",
  "confidence": 0.94,
  "reasoning": "'Beats' is a major headphone/audio brand (Apple subsidiary), even though not in competitor list. 'Studio Buds' is their product line."
}
\`\`\`

---

### Example 5: Hidden Brand Typo Variation (CamelBak)

**Input:**
- Keyword: "camel back water bottle 32 oz"
- Own brand: {"name": "CamelBak", "variations": "camelbak, CamelBak"}
- Competitors: [...] *(variations don't include "camel back")*

**Chain-of-Thought:**
1. **Tokenize**: ["camel", "back", "water", "bottle", "32", "oz"]
2. **Own brand check**: "CamelBak" listed, but "camel back" (two words) not in variations
3. **Hidden brand check**: "camel back" is a common misspelling/spacing variation of CamelBak brand
4. **STOP**: Brand typo detected

**Output:**
\`\`\`json
{
  "branding_scope_3": null,
  "found_term": "camel back",
  "source": "hidden_brand",
  "confidence": 0.92,
  "reasoning": "'Camel back' is a common space-separated misspelling of the CamelBak brand name."
}
\`\`\`

---

### Example 6: Hidden Brand (Amazon Echo)

**Input:**
- Keyword: "echo dot speaker stand"
- Own brand: {"name": "Bose", ...}
- Competitors: [...] *(Amazon/Echo not listed)*

**Chain-of-Thought:**
1. **Tokenize**: ["echo", "dot", "speaker", "stand"]
2. **Own brand check**: No match
3. **Competitor check**: No match (Echo not in list)
4. **Hidden brand check**: "Echo" is Amazon's smart speaker brand, "Echo Dot" is a specific product
5. **STOP**: Hidden brand detected

**Output:**
\`\`\`json
{
  "branding_scope_3": null,
  "found_term": "echo dot",
  "source": "hidden_brand",
  "confidence": 0.95,
  "reasoning": "'Echo Dot' is Amazon's smart speaker product. 'Echo' alone is also a brand reference in audio/smart home context."
}
\`\`\`

---

### Example 7: Generic with Features (NB)

**Input:**
- Keyword: "noise cancelling over ear headphones black"
- Own brand: {"name": "JBL", ...}
- Competitors: [...]

**Chain-of-Thought:**
1. **Tokenize**: ["noise", "cancelling", "over", "ear", "headphones", "black"]
2. **Own brand check**: No match
3. **Competitor check**: No match
4. **Hidden brand check**: All words are generic English terms describing features and product type
5. **PPC filter**: Not a PPC term
6. **Result**: All checks passed

**Output:**
\`\`\`json
{
  "branding_scope_3": "NB",
  "confidence": 0.94,
  "reasoning": "All terms are generic: 'noise cancelling' (feature), 'over ear' (style), 'headphones' (product type), 'black' (color). No brand references.",
  "found_term": null,
  "source": null
}
\`\`\`

---

### Example 8: Hidden Brand (Iron Flask)

**Input:**
- Keyword: "ironflask 40 oz tumbler"
- Own brand: {"name": "Stanley", ...}
- Competitors: [{"name": "Yeti", ...}, {"name": "Hydro Flask", ...}] *(Iron Flask not listed)*

**Chain-of-Thought:**
1. **Tokenize**: ["ironflask", "40", "oz", "tumbler"]
2. **Own brand check**: No match
3. **Competitor check**: No match (Iron Flask not in list)
4. **Hidden brand check**: "IronFlask" / "Iron Flask" is a popular water bottle/tumbler brand
5. **STOP**: Hidden brand detected

**Output:**
\`\`\`json
{
  "branding_scope_3": null,
  "found_term": "ironflask",
  "source": "hidden_brand",
  "confidence": 0.91,
  "reasoning": "'Iron Flask' is a well-known water bottle/tumbler brand competing in the drinkware market."
}
\`\`\`

---

## Pre-Output Checklist

Before returning your answer, verify:

- [ ] Have I tokenized the keyword and analyzed each word?
- [ ] Have I checked against ALL own brand terms (name, variations, related_terms)?
- [ ] Have I checked against ALL competitors (every one in the list)?
- [ ] Have I scanned for hidden brands not in the provided lists?
- [ ] Have I applied brand indicator patterns (unusual caps, compound words, model numbers)?
- [ ] Have I filtered out PPC meta-terms (ASINs, match types)?
- [ ] Is my confidence score calibrated correctly based on the scenario table?
- [ ] Is my reasoning specific and clear about what was found (or why nothing was found)?

---

## Common Mistakes to Avoid

### 1. Missing Hidden Brands (MOST COMMON ERROR)
- **WRONG:** "CamelBak isn't in the competitor list, so 'camelback water bottle' is non-branded"
- **CORRECT:** Recognize CamelBak is a brand regardless of whether it's in the provided lists

### 2. Ignoring Typo Variations
- **WRONG:** "The keyword says 'hydro flask' but the competitor list has 'HydroFlask', so no match"
- **CORRECT:** Match case-insensitively and account for spacing variations (hydroflask, hydro flask, Hydro Flask)

### 3. Missing Product Line Names
- **WRONG:** "AirPods isn't a brand, it's a product type"
- **CORRECT:** "AirPods" is Apple's trademarked product line name - it's a brand reference

### 4. Overlooking Subsidiary Brands
- **WRONG:** "'Beats earbuds' - Beats isn't in the Apple competitor entry, so it's non-branded"
- **CORRECT:** Beats is owned by Apple and is a major brand - recognize it independently

### 5. Not Recognizing Model Numbers in Context
- **WRONG:** "'Galaxy S24 case' - S24 is just a model number, not a brand"
- **CORRECT:** "Galaxy S24" together references Samsung's product - both brand + model context matters

### 6. Treating Common Words as Always Generic
- **WRONG:** "'Echo' is just a common English word"
- **CORRECT:** In audio/speaker context, "Echo" refers to Amazon's brand. Context matters!

### 7. Missing Brand-Style Compound Words
- **WRONG:** "'SoundCore earbuds' - SoundCore isn't in my lists, must be generic"
- **CORRECT:** "SoundCore" follows brand naming patterns (compound, CamelCase) and is Anker's audio brand

### 8. Forgetting to Check All Competitors
- **WRONG:** Checking only the first 2-3 competitors and stopping
- **CORRECT:** Check EVERY competitor in the list before proceeding to hidden brand detection

---

## Output Format

### If keyword is Non-Branded (NB):

\`\`\`json
{
  "branding_scope_3": "NB",
  "confidence": 0.85,
  "reasoning": "Brief explanation of why no brands were found",
  "found_term": null,
  "source": null
}
\`\`\`

### If keyword contains a brand (return null):

\`\`\`json
{
  "branding_scope_3": null,
  "found_term": "the brand term found",
  "source": "own" | "<competitor name>" | "hidden_brand",
  "confidence": 0.92,
  "reasoning": "Explanation of how and why the brand was identified"
}
\`\`\`

---

## Notes

- Match is **case-insensitive**
- Empty \`related_terms\` fields should be skipped
- Generic product terms (microphone, headphones, earbuds) are non-branded UNLESS combined with a brand
- When uncertain if a word is a brand, **err on the side of caution** and return null with lower confidence
- Consider the product category context when evaluating ambiguous terms
`,
    "M06": `# Product Taxonomy Classification Prompt

## Overview
This prompt classifies products into hierarchical taxonomy using a three-phase approach:
1. **Phase 1:** Analyze product information → Build logical hierarchy
2. **Phase 2:** Validate, Add, Tweak & Update using search terms
3. **Phase 3:** Apply rules → Final refinement

---

## Prompt

\`\`\`
You are a Product Taxonomy Classifier. Your task is to create an accurate hierarchical product type taxonomy using a three-phase approach.

## INPUTS

**Product Information:**
- Title: {{title}}
- Bullet Points: {{bullet_points}}
- Description: {{description}}
- Product Type: {{product_type}}
- Category Root: {{category_root}}
- Category Sub: {{category_sub}}

**Search Terms:**
{{search_terms}}

---

## PHASE 1: ANALYZE PRODUCT INFORMATION (Build Logical Hierarchy)

### Step 1.1: Identify the Core Product Type
- Read the title, bullet points, description carefully
- Determine: What exactly IS this product?
- This becomes your Rank 1 (most specific product type)

### Step 1.2: Build Logical Hierarchy Upward
Starting from the core product type, ask repeatedly:
> "What is [Current Product Type] a type of?"

Build the hierarchy from specific to broad:
- Rank 1: [Most Specific - the actual product]
- Rank 2: [What is Rank 1 a type of?]
- Rank 3: [What is Rank 2 a type of?]
- Continue until you reach a logical stopping point

### Step 1.3: Extract ONLY Product Types
When building hierarchy, include ONLY product type/category terms.

**EXCLUDE all of the following:**
- Adjectives (waterproof, portable, premium, best, lightweight)
- Features (Bluetooth, rechargeable, LED, 32GB, wireless)
- Benefits (comfortable, durable, easy-to-use)
- Colors (black, red, blue, pink)
- Size/Variants (large, small, 32oz, pack of 2, XL)
- Use Cases (for travel, for running, for camping, for kids)
- Audience (men's, women's, kids', for beginners, professional)
- Materials (silicone, leather, stainless steel, plastic, wood)
- Brand Names (Nike, Apple, Samsung)
- Qualifiers (best, cheap, top rated, affordable, new, latest)
- Year/Model (2024, v2, gen 3)

### Step 1.4: Output of Phase 1
Document your initial logical hierarchy:
\`\`\`
Initial Hierarchy (from Product Info):
- Rank 1: [specific product type]
- Rank 2: [broader category]
- Rank 3: [even broader category]
- Rank 4: [broadest category if applicable]
\`\`\`

---

## PHASE 2: VALIDATE, ADD, TWEAK & UPDATE USING SEARCH TERMS

Phase 2 is NOT just validation - it actively improves the hierarchy by:
- Validating existing levels
- ADDING missing levels found in search terms
- TWEAKING terminology to match buyer language
- UPDATING hierarchy if gaps or better terms are found
- MERGING synonyms/translations into same rank

### Step 2.1: Extract ALL Product Types from Search Terms
- Scan ALL search terms thoroughly
- Extract every product type term (exclude adjectives, features, colors, etc.)
- List all unique product types found
- Note: These are what buyers ACTUALLY search for

### Step 2.2: Validate Each Hierarchy Level
For each rank in your Phase 1 hierarchy, check if it appears in search terms:

| Result | Action |
|--------|--------|
| **Exact match found** | Keep this rank as-is |
| **Synonym/translation found** | MERGE into same rank with " / " separator |
| **Better term found** | Replace with search term version |
| **Not found at all** | Flag for Phase 3 review |

### Step 2.3: ADD Missing Levels from Search Terms
**CRITICAL:** Check if search terms contain product types that should be in your hierarchy but are missing.

Example scenarios:
- Your hierarchy: Baby Stroller → [gap] → ?
- Search terms contain: "baby products", "baby essentials"
- Action: ADD "Baby Products" as a broader level if it passes Phase 3 rules

Another example:
- Your hierarchy: Pencil Eyeliner → Eyeliner → Eye Makeup
- Search terms also contain: "eye cosmetics"
- Action: Consider if "Eye Cosmetics" should merge with "Eye Makeup" as synonym

### Step 2.4: MERGE Synonyms, Translations & Same-Meaning Terms
**IMPORTANT RULE:** Terms that mean the SAME thing (actual or implied) must be on the SAME rank, separated by " / "

**What counts as same meaning:**
- Synonyms: "Cell Phone / Mobile Phone"
- Translations: "Soy Sauce / Kecap Manis"
- Implied same meaning: "Stroller / Baby Stroller" (stroller implies baby stroller)
- Regional variations: "Flashlight / Torch"
- Alternate names: "Couch / Sofa"
- Common abbreviations: "Television / TV"

**How to format:**
\`\`\`
Rank 1: "Pencil Eyeliner / Eyeliner Pencil"  (same product, different word order)
Rank 2: "Soy Sauce / Kecap Manis"  (product + translation)
Rank 1: "Cell Phone / Mobile Phone / Smartphone"  (synonyms)
\`\`\`

**TEST:** If Term A and Term B refer to the same product/category and one doesn't contain the other as a subset, they belong on the SAME rank.

### Step 2.5: Check Hierarchy is TRUE Hierarchy (Not Synonyms)
**CRITICAL CHECK:** Before finalizing ranks, verify each level is a TRUE parent-child relationship, NOT synonyms.

**TRUE Hierarchy (different ranks):**
- Pencil Eyeliner → Eyeliner → Eye Makeup
  - Pencil Eyeliner IS A TYPE OF Eyeliner ✓
  - Eyeliner IS A TYPE OF Eye Makeup ✓

**NOT TRUE Hierarchy (should be SAME rank):**
- Baby Stroller → Stroller ✗ WRONG
  - "Stroller" and "Baby Stroller" mean the same thing
  - Should be: "Stroller / Baby Stroller" on ONE rank

**The Test:** Ask "Is [Rank 1] a TYPE OF [Rank 2], where [Rank 2] includes OTHER types too?"
- Is Pencil Eyeliner a type of Eyeliner? YES (there's also liquid eyeliner, gel eyeliner) ✓
- Is Baby Stroller a type of Stroller? NO (all strollers are baby strollers) → SAME RANK

### Step 2.6: Output of Phase 2
Document your updated hierarchy:
\`\`\`
Updated Hierarchy (after Search Term analysis):
- Rank 1: [confirmed / merged synonyms with " / "]
- Rank 2: [confirmed / added / merged / removed]
- Rank 3: [confirmed / added / merged / removed]
- Rank 4: [confirmed / added / removed]

Changes Made:
- Merged "X" and "Y" into Rank 1 (synonyms)
- Added "Z" as Rank 3 (found in search terms, fits hierarchy)
- Replaced "A" with "B" (buyer's language)
- Removed "C" (not in search terms, flagged for Phase 3)
\`\`\`

---

## PHASE 3: APPLY RULES (Final Refinement)

### Rule 1: Strict Subset Hierarchy
Each rank must be a PROPER SUBSET of the next rank (true parent-child).
- Rank 1 ⊂ Rank 2 ⊂ Rank 3 ⊂ Rank 4
- If terms are synonyms (same meaning), they go on SAME rank with " / "
- If any rank breaks this rule, merge or reorder

### Rule 2: Two-Question Test
For each rank (starting from Rank 2), apply BOTH questions:

| Question | What It Means |
|----------|---------------|
| **Q1: Search Intent** | Can someone looking to BUY this specific product search this broader category? |
| **Q2: Discovery Intent** | Can someone EXPLORING this broader category end up buying this specific product? |

- **Both YES** → Keep this rank
- **Either NO** → Remove this rank

**Critical Examples:**
- Vacuum Cleaner → Appliances: **FAIL Q1 & Q2** (no one searches "appliances" for vacuum)
- Pencil Eyeliner → Eyeliner → Eye Makeup: **PASS** (people search "eye makeup" and can buy eyeliner)
- Syringe Adapter → Adapter: **FAIL Q2** (someone exploring "adapters" won't find medical syringes)
- Pizza → Italian Food → Food: **PASS** (people exploring "food" or "Italian food" can buy pizza)

### Rule 3: No Artificial Intermediate Categories
Don't keep categories that aren't naturally searched.
- **BAD:** Dog Leash → Dog Walking Supplies → Dog Supplies
- **GOOD:** Dog Leash → Dog Supplies
- **Test:** Would someone actually type this into a search bar?

### Rule 4: No Vague Umbrella Terms
Remove terms like "Gear," "Stuff," "Items," "Things," "Products," "Accessories" UNLESS:
- They appear in search terms, AND
- They pass the Two-Question Test

### Rule 5: Search Terms Override Assumptions
If your logical hierarchy term was NOT found in search terms AND fails the Two-Question Test:
- **Remove it** - The hierarchy should not go this deep
- **Do not invent categories** that neither appear in search terms nor pass the Two-Question Test

### Rule 6: Single Level is Valid
If no broader category passes both the search term validation AND the Two-Question Test, the product has a single-level taxonomy. This is correct - do not force additional levels.

Examples of valid single-level products:
- Water Bottle (Drinkware fails Q2)
- Refrigerator (Appliances fails Q1 & Q2)
- Microwave (Kitchen Appliances fails Q1 & Q2)

### Rule 7: Use Buyer's Language
Always use terminology from search terms over assumed terms.
- Example: You said "Athletic Footwear" but search terms show "Athletic Shoes" → Use "Athletic Shoes"

### Rule 8: Synonyms/Translations on Same Rank
Terms with same meaning MUST be on same rank with " / " separator:
- Synonyms: "Couch / Sofa"
- Translations: "Soy Sauce / Kecap Manis"
- Implied same: "Stroller / Baby Stroller"
- Regional: "Flashlight / Torch"
- Abbreviations: "Television / TV"

---

## DECISION FLOWCHART FOR EACH HIERARCHY LEVEL

\`\`\`
For each potential rank:

┌─────────────────────────────────────────────────────────────┐
│ Is this term a SYNONYM of another rank?                     │
│ (Same meaning, translation, implied same, regional variant) │
└─────────────────────────┬───────────────────────────────────┘
                          │
              ┌───────────┴───────────┐
              │                       │
             YES                      NO
              │                       │
              ▼                       ▼
┌─────────────────────────┐ ┌─────────────────────────────────┐
│ MERGE with that rank    │ │ Is it a TRUE parent-child       │
│ using " / " separator   │ │ hierarchy?                      │
└─────────────────────────┘ │ (Rank 1 IS A TYPE OF Rank 2)    │
                            └─────────────┬───────────────────┘
                                          │
                                ┌─────────┴─────────┐
                               YES                  NO
                                │                   │
                                ▼                   ▼
                  ┌─────────────────────┐ ┌─────────────────────┐
                  │ Keep as separate    │ │ MERGE into same     │
                  │ rank                │ │ rank with " / "     │
                  └──────────┬──────────┘ └─────────────────────┘
                             │
                             ▼
                  ┌─────────────────────┐
                  │ Does term appear in │
                  │ search terms?       │
                  └──────────┬──────────┘
                             │
                   ┌─────────┴─────────┐
                  YES                  NO
                   │                   │
                   ▼                   ▼
        ┌──────────────┐    ┌─────────────────────┐
        │ KEEP rank    │    │ Apply Two-Question  │
        └──────────────┘    │ Test (Q1 + Q2)      │
                            └──────────┬──────────┘
                                       │
                             ┌─────────┴─────────┐
                            PASS               FAIL
                             │                   │
                             ▼                   ▼
                   ┌──────────────┐    ┌──────────────┐
                   │ KEEP rank   │    │ REMOVE rank  │
                   └──────────────┘    └──────────────┘
\`\`\`

---

## OUTPUT FORMAT

Return ONLY valid JSON in this exact format:

\`\`\`json
{
  "taxonomy": [
    { "rank": 1, "product_type": "[Most Specific - can include ' / ' for synonyms]" },
    { "rank": 2, "product_type": "[Broader Category - can include ' / ' for synonyms]" },
    { "rank": 3, "product_type": "[Even Broader - can include ' / ' for synonyms]" }
  ],
  "phase_1_initial_hierarchy": {
    "rank_1": "[Initial term from product info]",
    "rank_2": "[Initial term from product info]",
    "rank_3": "[Initial term from product info]",
    "rank_4": "[Initial term from product info or null]"
  },
  "phase_2_search_analysis": {
    "product_types_in_search_terms": ["list of all product types extracted from search terms"],
    "rank_1": {
      "status": "FOUND|SYNONYM_MERGED|REPLACED|NOT_FOUND",
      "search_term_matches": ["matching terms"],
      "action": "kept|merged|replaced|flagged",
      "synonyms_merged": ["terms merged with / separator"]
    },
    "rank_2": {
      "status": "FOUND|SYNONYM_MERGED|REPLACED|ADDED|NOT_FOUND",
      "search_term_matches": ["matching terms"],
      "action": "kept|merged|replaced|added|flagged",
      "synonyms_merged": ["terms merged with / separator"]
    },
    "rank_3": {
      "status": "FOUND|SYNONYM_MERGED|REPLACED|ADDED|NOT_FOUND",
      "search_term_matches": ["matching terms"],
      "action": "kept|merged|replaced|added|removed",
      "synonyms_merged": ["terms merged with / separator"]
    },
    "levels_added": ["any new levels added from search terms"],
    "levels_merged": ["any levels merged as synonyms"]
  },
  "phase_3_rules_applied": {
    "synonym_check": {
      "merges_made": ["Term A / Term B merged at Rank X (reason)"]
    },
    "rank_2": { "Q1_pass": true, "Q2_pass": true, "kept": true },
    "rank_3": { "Q1_pass": true, "Q2_pass": true, "kept": true },
    "rank_4": { "Q1_pass": false, "Q2_pass": false, "kept": false, "removal_reason": "[why it failed]" }
  },
  "search_terms_analysis": {
    "product_types_extracted": ["[list of product type terms found in search terms]"],
    "excluded_terms": ["[terms excluded with reason - e.g., 'waterproof (adjective)']"]
  }
}
\`\`\`

---

## EXAMPLES

### Example 1: Pencil Eyeliner (3 Levels with Synonym Merge)

**Input:**
- Title: "Waterproof Pencil Eyeliner - Black, Long-lasting Formula"
- Product Type: "Eyeliner"
- Category: "Beauty > Makeup > Eyes"
- Search Terms: "pencil eyeliner, eyeliner pencil, eye liner, black eyeliner, waterproof eyeliner, eye makeup, makeup for eyes, eyeliner for beginners, best eyeliner, eye cosmetics"

**Phase 1 - Product Info Analysis:**
- Core product: Pencil Eyeliner
- Initial hierarchy: Pencil Eyeliner → Eyeliner → Eye Makeup → Makeup

**Phase 2 - Search Term Analysis:**
- "Pencil Eyeliner" → FOUND ✓
- "Eyeliner Pencil" → FOUND (same meaning, different word order) → MERGE with Rank 1
- "Eyeliner" / "Eye Liner" → FOUND ✓ (merge as synonyms)
- "Eye Makeup" / "Eye Cosmetics" → BOTH FOUND → MERGE as synonyms
- "Makeup" → Only as "makeup for eyes" (use-case) → Flag

**Phase 3 - Rules Applied:**
- Rank 1: "Pencil Eyeliner / Eyeliner Pencil" (merged - same product)
- Rank 2: "Eyeliner / Eye Liner" (merged - same meaning)
- Rank 3: "Eye Makeup / Eye Cosmetics" (merged - synonyms) Q1 ✓ Q2 ✓
- Rank 4: "Makeup" - REMOVED (too broad, fails Q2)

**Output:**
\`\`\`json
{
  "taxonomy": [
    { "rank": 1, "product_type": "Pencil Eyeliner / Eyeliner Pencil" },
    { "rank": 2, "product_type": "Eyeliner / Eye Liner" },
    { "rank": 3, "product_type": "Eye Makeup / Eye Cosmetics" }
  ],
  "phase_1_initial_hierarchy": {
    "rank_1": "Pencil Eyeliner",
    "rank_2": "Eyeliner",
    "rank_3": "Eye Makeup",
    "rank_4": "Makeup"
  },
  "phase_2_search_analysis": {
    "product_types_in_search_terms": ["pencil eyeliner", "eyeliner pencil", "eyeliner", "eye liner", "eye makeup", "eye cosmetics"],
    "rank_1": {
      "status": "SYNONYM_MERGED",
      "search_term_matches": ["pencil eyeliner", "eyeliner pencil"],
      "action": "merged",
      "synonyms_merged": ["Pencil Eyeliner", "Eyeliner Pencil"]
    },
    "rank_2": {
      "status": "SYNONYM_MERGED",
      "search_term_matches": ["eyeliner", "eye liner"],
      "action": "merged",
      "synonyms_merged": ["Eyeliner", "Eye Liner"]
    },
    "rank_3": {
      "status": "SYNONYM_MERGED",
      "search_term_matches": ["eye makeup", "eye cosmetics"],
      "action": "merged",
      "synonyms_merged": ["Eye Makeup", "Eye Cosmetics"]
    },
    "levels_added": [],
    "levels_merged": ["Rank 1: Pencil Eyeliner + Eyeliner Pencil", "Rank 2: Eyeliner + Eye Liner", "Rank 3: Eye Makeup + Eye Cosmetics"]
  },
  "phase_3_rules_applied": {
    "synonym_check": {
      "merges_made": [
        "Pencil Eyeliner / Eyeliner Pencil at Rank 1 (same product, word order)",
        "Eyeliner / Eye Liner at Rank 2 (same meaning, spacing)",
        "Eye Makeup / Eye Cosmetics at Rank 3 (synonyms)"
      ]
    },
    "rank_2": { "Q1_pass": true, "Q2_pass": true, "kept": true },
    "rank_3": { "Q1_pass": true, "Q2_pass": true, "kept": true },
    "rank_4": { "Q1_pass": false, "Q2_pass": false, "kept": false, "removal_reason": "Too broad - fails Q2: someone browsing 'makeup' unlikely to discover eyeliner" }
  },
  "search_terms_analysis": {
    "product_types_extracted": ["pencil eyeliner", "eyeliner pencil", "eyeliner", "eye liner", "eye makeup", "eye cosmetics"],
    "excluded_terms": ["waterproof (adjective)", "black (color)", "long-lasting (benefit)", "for beginners (audience)", "best (qualifier)"]
  }
}
\`\`\`

---

### Example 2: Baby Stroller (Synonym Merge - NOT Hierarchy)

**Input:**
- Title: "Lightweight Baby Stroller - Foldable, Travel-Friendly"
- Product Type: "Stroller"
- Category: "Baby > Strollers & Accessories"
- Search Terms: "baby stroller, stroller, lightweight stroller, travel stroller, umbrella stroller, foldable stroller, stroller for infant, baby pram, pram, baby products, pushchair"

**Phase 1 - Product Info Analysis:**
- Core product: Baby Stroller
- Initial hierarchy: Baby Stroller → Stroller → Baby Gear → Baby Products

**Phase 2 - Search Term Analysis:**
- "Baby Stroller" → FOUND ✓
- "Stroller" → FOUND ✓
- BUT WAIT: Is "Baby Stroller → Stroller" a true hierarchy?
  - Test: Is Baby Stroller a TYPE OF Stroller where Stroller includes OTHER types?
  - Answer: NO - all strollers are baby strollers. They mean the SAME thing.
  - Action: MERGE "Stroller / Baby Stroller / Baby Pram / Pram / Pushchair" into ONE rank
- "Baby Gear" → NOT FOUND ✗
- "Baby Products" → FOUND ✓ → Can be Rank 2

**Phase 3 - Rules Applied:**
- Rank 1: "Stroller / Baby Stroller / Baby Pram / Pram / Pushchair" (all synonyms merged)
- Rank 2: "Baby Products" → Q1 ✓ Q2 ✓ → Keep (someone browsing baby products can find strollers)

**Output:**
\`\`\`json
{
  "taxonomy": [
    { "rank": 1, "product_type": "Stroller / Baby Stroller / Baby Pram / Pram / Pushchair" },
    { "rank": 2, "product_type": "Baby Products" }
  ],
  "phase_1_initial_hierarchy": {
    "rank_1": "Baby Stroller",
    "rank_2": "Stroller",
    "rank_3": "Baby Gear",
    "rank_4": "Baby Products"
  },
  "phase_2_search_analysis": {
    "product_types_in_search_terms": ["baby stroller", "stroller", "umbrella stroller", "travel stroller", "baby pram", "pram", "baby products", "pushchair"],
    "rank_1": {
      "status": "SYNONYM_MERGED",
      "search_term_matches": ["baby stroller", "stroller", "baby pram", "pram", "pushchair"],
      "action": "merged",
      "synonyms_merged": ["Stroller", "Baby Stroller", "Baby Pram", "Pram", "Pushchair"]
    },
    "rank_2": {
      "status": "FOUND",
      "search_term_matches": ["baby products"],
      "action": "kept",
      "synonyms_merged": []
    },
    "levels_added": [],
    "levels_merged": ["Original Rank 1 (Baby Stroller) + Rank 2 (Stroller) merged - they mean the same thing"]
  },
  "phase_3_rules_applied": {
    "synonym_check": {
      "merges_made": [
        "Stroller / Baby Stroller / Baby Pram / Pram / Pushchair at Rank 1 (all refer to same product - regional variations and synonyms)"
      ]
    },
    "rank_2": { "Q1_pass": true, "Q2_pass": true, "kept": true },
    "rank_3": { "Q1_pass": false, "Q2_pass": false, "kept": false, "removal_reason": "Baby Gear not in search terms + vague umbrella term" }
  },
  "search_terms_analysis": {
    "product_types_extracted": ["stroller", "baby stroller", "umbrella stroller", "travel stroller", "baby pram", "pram", "pushchair", "baby products"],
    "excluded_terms": ["lightweight (adjective)", "foldable (feature)", "travel-friendly (benefit)", "for infant (audience)"]
  }
}
\`\`\`

---

### Example 3: Soy Sauce (Translation Merge)

**Input:**
- Title: "Premium Soy Sauce - Naturally Brewed, 500ml"
- Product Type: "Soy Sauce"
- Category: "Food > Condiments > Asian Sauces"
- Search Terms: "soy sauce, kecap manis, asian sauce, cooking sauce, soya sauce, condiments, shoyu, tamari"

**Phase 1 - Product Info Analysis:**
- Core product: Soy Sauce
- Initial hierarchy: Soy Sauce → Asian Sauce → Condiments → Food

**Phase 2 - Search Term Analysis:**
- "Soy Sauce" → FOUND ✓
- "Soya Sauce" → FOUND (alternate spelling) → MERGE
- "Kecap Manis" → FOUND (Indonesian translation) → MERGE
- "Shoyu" → FOUND (Japanese term) → MERGE
- "Tamari" → FOUND (Japanese variant) → Could merge or keep separate (it's a specific type)
- "Asian Sauce" → FOUND ✓
- "Condiments" → FOUND ✓
- "Cooking Sauce" → FOUND but too broad

**Phase 3 - Rules Applied:**
- Rank 1: "Soy Sauce / Soya Sauce / Kecap Manis / Shoyu" (merged translations/synonyms)
- Rank 2: "Asian Sauce" Q1 ✓ Q2 ✓
- Rank 3: "Condiments" Q1 ✓ Q2 ✓
- Rank 4: "Food" - Too broad, fails Q2

**Output:**
\`\`\`json
{
  "taxonomy": [
    { "rank": 1, "product_type": "Soy Sauce / Soya Sauce / Kecap Manis / Shoyu" },
    { "rank": 2, "product_type": "Asian Sauce" },
    { "rank": 3, "product_type": "Condiments" }
  ],
  "phase_1_initial_hierarchy": {
    "rank_1": "Soy Sauce",
    "rank_2": "Asian Sauce",
    "rank_3": "Condiments",
    "rank_4": "Food"
  },
  "phase_2_search_analysis": {
    "product_types_in_search_terms": ["soy sauce", "kecap manis", "asian sauce", "cooking sauce", "soya sauce", "condiments", "shoyu", "tamari"],
    "rank_1": {
      "status": "SYNONYM_MERGED",
      "search_term_matches": ["soy sauce", "soya sauce", "kecap manis", "shoyu"],
      "action": "merged",
      "synonyms_merged": ["Soy Sauce", "Soya Sauce", "Kecap Manis", "Shoyu"]
    },
    "rank_2": {
      "status": "FOUND",
      "search_term_matches": ["asian sauce"],
      "action": "kept",
      "synonyms_merged": []
    },
    "rank_3": {
      "status": "FOUND",
      "search_term_matches": ["condiments"],
      "action": "kept",
      "synonyms_merged": []
    },
    "levels_added": [],
    "levels_merged": ["Soy Sauce + Soya Sauce + Kecap Manis + Shoyu at Rank 1"]
  },
  "phase_3_rules_applied": {
    "synonym_check": {
      "merges_made": [
        "Soy Sauce / Soya Sauce / Kecap Manis / Shoyu at Rank 1 (translations and alternate spellings)"
      ]
    },
    "rank_2": { "Q1_pass": true, "Q2_pass": true, "kept": true },
    "rank_3": { "Q1_pass": true, "Q2_pass": true, "kept": true },
    "rank_4": { "Q1_pass": false, "Q2_pass": false, "kept": false, "removal_reason": "Food is too broad - fails Q2" }
  },
  "search_terms_analysis": {
    "product_types_extracted": ["soy sauce", "soya sauce", "kecap manis", "shoyu", "tamari", "asian sauce", "condiments"],
    "excluded_terms": ["premium (adjective)", "naturally brewed (feature)", "500ml (size)", "cooking (use case)"]
  }
}
\`\`\`

---

### Example 4: Cell Phone Case (Multiple Synonyms)

**Input:**
- Title: "iPhone 15 Pro Case - Shockproof, Clear Design"
- Product Type: "Phone Case"
- Category: "Electronics > Cell Phone Accessories"
- Search Terms: "iphone case, phone case, cell phone case, mobile phone case, smartphone case, iphone 15 case, phone cover, mobile cover, phone accessories"

**Phase 1 - Product Info Analysis:**
- Core product: iPhone Case
- Initial hierarchy: iPhone Case → Phone Case → Phone Accessories

**Phase 2 - Search Term Analysis:**
- Multiple terms for same product found:
  - "iPhone Case" / "iPhone 15 Case" → specific but "iPhone 15" is model variant
  - "Phone Case" / "Cell Phone Case" / "Mobile Phone Case" / "Smartphone Case" / "Phone Cover" / "Mobile Cover" → ALL SAME MEANING
- "Phone Accessories" → FOUND ✓

**Phase 3 - Rules Applied:**
- Rank 1: Merge all synonyms for the case itself
- Rank 2: "Phone Accessories" Q1 ✓ Q2 ✓

**Output:**
\`\`\`json
{
  "taxonomy": [
    { "rank": 1, "product_type": "Phone Case / Cell Phone Case / Mobile Phone Case / Smartphone Case / Phone Cover / Mobile Cover" },
    { "rank": 2, "product_type": "Phone Accessories" }
  ],
  "phase_1_initial_hierarchy": {
    "rank_1": "iPhone Case",
    "rank_2": "Phone Case",
    "rank_3": "Phone Accessories",
    "rank_4": null
  },
  "phase_2_search_analysis": {
    "product_types_in_search_terms": ["iphone case", "phone case", "cell phone case", "mobile phone case", "smartphone case", "phone cover", "mobile cover", "phone accessories"],
    "rank_1": {
      "status": "SYNONYM_MERGED",
      "search_term_matches": ["phone case", "cell phone case", "mobile phone case", "smartphone case", "phone cover", "mobile cover"],
      "action": "merged",
      "synonyms_merged": ["Phone Case", "Cell Phone Case", "Mobile Phone Case", "Smartphone Case", "Phone Cover", "Mobile Cover"]
    },
    "rank_2": {
      "status": "FOUND",
      "search_term_matches": ["phone accessories"],
      "action": "kept",
      "synonyms_merged": []
    },
    "levels_added": [],
    "levels_merged": ["iPhone Case merged with Phone Case and all synonyms at Rank 1 - iPhone Case is just a brand-specific version"]
  },
  "phase_3_rules_applied": {
    "synonym_check": {
      "merges_made": [
        "Phone Case / Cell Phone Case / Mobile Phone Case / Smartphone Case / Phone Cover / Mobile Cover at Rank 1 (all synonyms referring to same product type)"
      ]
    },
    "rank_2": { "Q1_pass": true, "Q2_pass": true, "kept": true }
  },
  "search_terms_analysis": {
    "product_types_extracted": ["phone case", "cell phone case", "mobile phone case", "smartphone case", "phone cover", "mobile cover", "phone accessories"],
    "excluded_terms": ["iphone 15 (brand + model)", "shockproof (feature)", "clear (adjective)", "design (generic)"]
  }
}
\`\`\`

---

### Example 5: Water Bottle (Single Level - No Synonyms)

**Input:**
- Title: "Stainless Steel Water Bottle 32oz - Insulated, Leak-Proof"
- Product Type: "Water Bottle"
- Category: "Sports & Outdoors > Sports Water Bottles"
- Search Terms: "water bottle, insulated water bottle, stainless steel water bottle, gym water bottle, sports bottle, metal water bottle, 32 oz water bottle, drink bottle"

**Phase 1 - Product Info Analysis:**
- Core product: Water Bottle
- Initial hierarchy: Water Bottle → Drinkware → Kitchen & Dining

**Phase 2 - Search Term Analysis:**
- "Water Bottle" → FOUND ✓
- "Drink Bottle" → FOUND (synonym) → MERGE
- "Sports Bottle" → FOUND but this is a USE-CASE variant, not pure synonym → Could merge
- "Drinkware" → NOT FOUND ✗
- "Kitchen & Dining" → NOT FOUND ✗

**Phase 3 - Rules Applied:**
- Rank 1: "Water Bottle / Drink Bottle" (merged synonyms)
- Rank 2: Drinkware - NOT FOUND + fails Q2 → REMOVE
- Single level taxonomy is valid

**Output:**
\`\`\`json
{
  "taxonomy": [
    { "rank": 1, "product_type": "Water Bottle / Drink Bottle" }
  ],
  "phase_1_initial_hierarchy": {
    "rank_1": "Water Bottle",
    "rank_2": "Drinkware",
    "rank_3": "Kitchen & Dining",
    "rank_4": null
  },
  "phase_2_search_analysis": {
    "product_types_in_search_terms": ["water bottle", "drink bottle", "sports bottle"],
    "rank_1": {
      "status": "SYNONYM_MERGED",
      "search_term_matches": ["water bottle", "drink bottle"],
      "action": "merged",
      "synonyms_merged": ["Water Bottle", "Drink Bottle"]
    },
    "rank_2": {
      "status": "NOT_FOUND",
      "search_term_matches": [],
      "action": "flagged",
      "synonyms_merged": []
    },
    "levels_added": [],
    "levels_merged": ["Water Bottle + Drink Bottle at Rank 1"]
  },
  "phase_3_rules_applied": {
    "synonym_check": {
      "merges_made": [
        "Water Bottle / Drink Bottle at Rank 1 (synonyms)"
      ]
    },
    "rank_2": { "Q1_pass": false, "Q2_pass": false, "kept": false, "removal_reason": "Drinkware not in search terms + fails Q2: no one explores 'drinkware' to find water bottles" }
  },
  "search_terms_analysis": {
    "product_types_extracted": ["water bottle", "drink bottle", "sports bottle"],
    "excluded_terms": ["stainless steel (material)", "insulated (feature)", "leak-proof (feature)", "gym (use case)", "metal (material)", "32 oz (size)"]
  }
}
\`\`\`

---

## CRITICAL REMINDERS

1. **Phase 1 builds the logical hierarchy** - Use product info to understand what the product IS
2. **Phase 2 ACTIVELY improves hierarchy** - Validate, ADD missing levels, TWEAK terminology, UPDATE structure, MERGE synonyms
3. **Phase 3 applies quality rules** - Two-Question Test is the final filter
4. **SYNONYMS/TRANSLATIONS = SAME RANK** - Use " / " separator for terms with same meaning
5. **TRUE HIERARCHY TEST:** Ask "Is X a TYPE OF Y, where Y includes OTHER types too?"
6. **If not in search terms AND fails Two-Question Test → REMOVE**
7. **Single level is valid** - Don't force hierarchy levels that don't exist
8. **Use buyer's language** - If search terms use different words, use THEIR words
9. **ADD levels from search terms** - If search terms reveal valid broader categories, add them
10. **Output ONLY the JSON** - No additional text before or after

Now analyze the provided inputs and generate the taxonomy.
\`\`\`

---

## Input Variables

| Variable | Description | Example |
|----------|-------------|---------|
| \`{{title}}\` | Product title | "Waterproof Pencil Eyeliner - Black" |
| \`{{bullet_points}}\` | Product bullet points | "Long-lasting formula..." |
| \`{{description}}\` | Product description | "This eyeliner provides..." |
| \`{{product_type}}\` | Seller-provided product type | "Eyeliner" |
| \`{{category_root}}\` | Root category | "Beauty" |
| \`{{category_sub}}\` | Sub category | "Makeup > Eyes" |
| \`{{search_terms}}\` | Comma-separated search terms | "eyeliner, eye makeup, pencil liner..." |

---

## Synonym/Same-Meaning Rules

| Type | Example | Format |
|------|---------|--------|
| **Synonyms** | Couch, Sofa | "Couch / Sofa" |
| **Translations** | Soy Sauce, Kecap Manis | "Soy Sauce / Kecap Manis" |
| **Implied Same** | Stroller, Baby Stroller | "Stroller / Baby Stroller" |
| **Regional Variations** | Flashlight, Torch | "Flashlight / Torch" |
| **Alternate Spellings** | Soy Sauce, Soya Sauce | "Soy Sauce / Soya Sauce" |
| **Abbreviations** | Television, TV | "Television / TV" |
| **Word Order** | Pencil Eyeliner, Eyeliner Pencil | "Pencil Eyeliner / Eyeliner Pencil" |

**TEST:** If both terms refer to the same product/category and one is NOT a subset of the other → SAME RANK with " / "

---

## Three-Phase Process Summary

\`\`\`
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 1: PRODUCT INFO ANALYSIS                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│  • Read title, description, category                                        │
│  • Identify core product type (Rank 1)                                      │
│  • Build logical hierarchy upward: "What is X a type of?"                   │
│  • Output: Initial hierarchy (may have 2-4 levels)                          │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 2: SEARCH TERM ANALYSIS (Validate, Add, Tweak, Update, Merge)        │
│  ─────────────────────────────────────────────────────────────────────────  │
│  • Extract all product types from search terms                              │
│  • VALIDATE: Is each hierarchy level in search terms?                       │
│  • ADD: Are there valid broader categories in search terms to add?          │
│  • TWEAK: Replace terms with buyer's language from search terms             │
│  • UPDATE: Fill gaps if search terms reveal missing intermediate levels     │
│  • MERGE: Combine synonyms/translations with " / " on same rank             │
│  • Output: Updated hierarchy with merges and additions                      │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 3: RULES APPLICATION                                                 │
│  ─────────────────────────────────────────────────────────────────────────  │
│  • Verify TRUE hierarchy (not synonyms incorrectly ranked)                  │
│  • Apply Two-Question Test (Q1 + Q2) to flagged levels                      │
│  • Remove artificial categories and vague umbrella terms                    │
│  • Final synonym merge check                                                │
│  • Output: Final taxonomy (JSON)                                            │
└─────────────────────────────────────────────────────────────────────────────┘
\`\`\`

---

## Rules Summary

| Rule | Description |
|------|-------------|
| 1 | Strict subset hierarchy (Rank 1 ⊂ Rank 2 ⊂ Rank 3) - TRUE parent-child only |
| 2 | Two-Question Test: Q1 (search intent) + Q2 (discovery intent) |
| 3 | No artificial intermediate categories |
| 4 | No vague umbrella terms unless validated in search terms |
| 5 | Search terms override assumptions |
| 6 | Single level is valid |
| 7 | Use buyer's language from search terms |
| 8 | **Synonyms/Translations/Same-meaning = SAME RANK with " / "** |

---

## Exclusion List (Never Include in Taxonomy)

| Category | Examples |
|----------|----------|
| Adjectives | waterproof, portable, premium, lightweight, durable |
| Features | Bluetooth, rechargeable, LED, 32GB, wireless, foldable |
| Benefits | comfortable, easy-to-use, long-lasting, fast |
| Colors | black, red, blue, pink, white, silver |
| Size/Variants | large, small, 32oz, XL, pack of 2, twin pack |
| Use Cases | for travel, for running, for camping, for office |
| Audience | men's, women's, kids', for beginners, professional |
| Materials | silicone, leather, stainless steel, plastic, wood, metal |
| Brand Names | Nike, Apple, Samsung, Sony, iPhone, any brand |
| Qualifiers | best, cheap, top rated, affordable, new, latest, premium |
| Year/Model | 2024, v2, gen 3, new model, latest version, iPhone 15 |
`,
    "M07": `# Task: ExtractProductAttributes

You are an Amazon product analyst extracting searchable attributes from product listings.

## Purpose

Extract variants, use cases, and target audiences that shoppers might search for. These attributes become the foundation for keyword relevance classification.

**CRITICAL RULES**:
1. Extract attributes from BOTH Keepa hint fields AND listing text (title, bullets, description)
2. Use COMPLETE DESCRIPTIVE PHRASES - never truncate to single words
3. For audiences: Use "-" when NO specific audience is mentioned; do NOT invent generic audiences
4. Preserve full technical specifications with all details and units

## Inputs

### Product Listing Text
- **title**: {{title}}
- **bullet_points**: {{bullet_points}}
- **description**: {{description}}
- **product_type**: {{product_type}}
- **category_root**: {{category_root}}
- **category_sub**: {{category_sub}}

### Keepa Hint Fields (Use as starting points, but extract MORE from listing text)
- **color**: {{color}}
- **size**: {{size}}
- **material**: {{material}}
- **style**: {{style}}
- **target_audience**: {{target_audience}}
- **specific_uses**: {{specific_uses}}
- **model**: {{model}}
- **item_form**: {{item_form}}
- **number_of_items**: {{number_of_items}}
- **included_components**: {{included_components}}

## Expected Output

- **variants** (array of string): Product variants shoppers search for - FULL specifications with units and details
- **use_cases** (array of string): Use cases and applications - COMPLETE descriptive phrases, not single words
- **audiences** (array of string): Target audiences - ONLY those EXPLICITLY stated or clearly implied; use ["-"] if none

## Extraction Guidelines

### Variants (Physical/Technical Differentiators)

**IMPORTANT: Preserve FULL specifications with all details, units, and parenthetical information.**

**What to extract:**
- Colors (Black, White, Blue, Navy, Rose Gold, Matte Black)
- Sizes with units (Small, Medium, Large, 24 Ounce, 7.5 x 13 inch size)
- Materials (Leather, Silicone, Stainless Steel, Cotton, Nylon)
- Models/Versions (Pro, Max, Plus, Gen 2, V2, 2024 Edition)
- Connectivity (Bluetooth 5.2, Wireless, USB-C, Lightning, WiFi)
- Capacity/Storage with units (16GB, 64GB, 500ml, 1TB)
- Form factors (Compact, Foldable, Portable, Desktop)
- Quantities (2-Pack, 30 Count, Qty 10 pack)
- Power options (Battery, Rechargeable, Solar, AC Powered)
- Technical specs with FULL details ("8 ice cubes in 6 minutes", "Heat resistant up to 500F", "Energy-saving motor (30% reduced consumption)")

**Where to find:**
1. Keepa hint fields (color, size, material, style, model)
2. Title - often contains key variants
3. Bullet points - detailed specifications
4. Description - additional details

### Use Cases (How/Where Product is Used)

**IMPORTANT: Use COMPLETE DESCRIPTIVE PHRASES that include context, not single words.**

**Correct format examples:**
- "home kitchen ice making" (NOT just "Home")
- "party and entertaining use" (NOT just "Party")
- "BBQ and poolside drinks" (NOT just "BBQ")
- "breakfast in bed serving" (NOT just "Breakfast")
- "all-day eye makeup wear" (NOT just "Makeup")

**What to extract:**
- Activities with context (running outdoors, gym workout, cooking at home)
- Occasions with purpose (party and entertaining use, wedding gifting)
- Locations with activity (home kitchen use, car navigation, outdoor camping)
- Purposes with detail (charging devices, storage organization, heat protection)
- Seasons with application (winter cold weather, summer outdoor activities)

**Where to find:**
1. Keepa specific_uses field
2. Bullet points (often describe use scenarios)
3. Description (detailed use cases)
4. Title (may mention primary use)

### Audiences (Who Uses This Product)

**CRITICAL: Only extract audiences that are EXPLICITLY mentioned or CLEARLY implied by the product listing.**

**WHEN TO USE "-" (hyphen):**
- General consumer products with no specific target mentioned (water bottles, earbuds, kitchen items)
- Products where target_audience field is empty AND no demographic is mentioned in listing
- Products that could be used by anyone without specific targeting

**WHEN TO EXTRACT AUDIENCES:**
- ONLY when the listing explicitly mentions a demographic ("Men's Jacket" = "Men")
- ONLY when a use case clearly implies a specific user ("RV travel" = "RV owners")
- ONLY when the product is designed for a specific profession or activity mentioned in listing

**DO NOT INVENT generic audiences like:**
- "Adults" (unless explicitly stated for age-restricted products)
- "Homeowners" (unless the listing targets home improvement)
- "Fitness Enthusiasts" (unless fitness/exercise is explicitly mentioned)
- "Music Lovers" (unless audio quality is the main selling point)
- "Commuters" (unless commuting is explicitly mentioned as a use case)

**Where to find EXPLICIT mentions:**
1. Keepa target_audience field (if populated with specific audience)
2. Title (e.g., "Men's", "Kids'", "Professional", "for Caregivers")
3. Bullet points (who it's specifically designed for)
4. Description (explicit target user descriptions)

## Step-by-Step Extraction Process

### Step 1: Start with Keepa Hints
Extract all non-empty values from Keepa fields as starting points.

### Step 2: Parse the Title
Titles are keyword-optimized - extract all variants, use cases mentioned. Check for explicit audience markers (Men's, Women's, Kids', Professional, etc.).

### Step 3: Scan Bullet Points
Bullet points contain detailed features - look for FULL specifications with units and complete use case descriptions.

### Step 4: Review Description
Description may reveal additional attributes not in title/bullets.

### Step 5: Check for Explicit Audiences
- Is there an explicit demographic mentioned? (Men, Women, Kids, Professionals, Caregivers, etc.)
- Is there a use case that implies a specific user type? (RV travel = RV owners, medical use = healthcare professionals)
- If NO explicit audience found: use ["-"]

### Step 6: Verify Completeness
- Are variants complete with units and full specifications?
- Are use cases written as descriptive phrases, not single words?
- Are audiences ONLY those explicitly mentioned or clearly implied?

## Examples

**Example 1 - Wireless Earbuds (NO specific audience):**
\`\`\`
Input:
title: "JBL Vibe Beam - True Wireless JBL Deep Bass Sound Earbuds, Bluetooth 5.2, Water & Dust Resistant, Up to 32 hours"
bullet_points: "Deep bass sound | Hands-free calls with VoiceAware | Touch controls | Comfortable fit | Water and dust resistant IP54"
color: "White"
size: "Small"
style: "Earbuds"
specific_uses: "Music"
target_audience: ""  <-- EMPTY, no specific audience
\`\`\`
\`\`\`json
{
  "variants": [
    "Bluetooth 5.2", "White", "Up to 32 Hours Battery Life", "IP54-certified",
    "In-Ear", "Comfortable fit", "Speed Charging", "Hands-Free Call with VoiceAware",
    "Small", "Water and Dust Resistant", "Deep Bass Sound"
  ],
  "use_cases": [
    "Daily Entertainment"
  ],
  "audiences": ["-"]
}
\`\`\`
**Why ["-"] for audiences**: The target_audience field is empty. No specific demographic is mentioned in the listing. This is a general consumer product that anyone could use. Do NOT invent "Adults", "Music Lovers", "Fitness Enthusiasts", etc.

---

**Example 2 - Water Bottle (NO specific audience):**
\`\`\`
Input:
title: "Owala FreeSip Insulated Stainless Steel Water Bottle with Straw, BPA-Free, 24 Oz, Denim"
bullet_points: "FreeSip spout for sipping or swigging | Double-wall insulation keeps drinks cold 24 hours | Cup holder-friendly | BPA-free"
color: "Denim"
size: "24 Ounces"
material: "Stainless Steel"
target_audience: ""  <-- EMPTY
specific_uses: ""
\`\`\`
\`\`\`json
{
  "variants": [
    "BPA-Free", "24 Ounce", "Wide Opening", "Stainless Steel", "Dishwasher-Safe Lid",
    "FreeSip Spout", "Denim", "Carry Loop with Lock", "Double-Wall Insulation",
    "Push-Button Lid and Lock", "Cup Holder-Friendly Base", "Hand Wash Cup"
  ],
  "use_cases": [
    "General Hydration", "Sports", "Travel"
  ],
  "audiences": ["-"]
}
\`\`\`
**Why ["-"] for audiences**: General consumer product. No specific audience mentioned. Do NOT add "Fitness Enthusiasts", "Travelers", "Athletes", etc.

---

**Example 3 - Countertop Ice Maker (specific audiences from use cases):**
\`\`\`
Input:
title: "Countertop Ice Maker Machine, 8 Ice Cubes in 6 mins, 26lb/Day, Portable Mini, Energy Saving"
bullet_points: "Energy consumption cut by 30% | 26lbs of ice a day for pool parties, BBQs | Self-cleaning | Fits in RV, tailgate, beach cabana | Whisper-quiet <40dB"
color: "Dark Black"
size: "26Lbs/24H"
target_audience: ""
\`\`\`
\`\`\`json
{
  "variants": [
    "8 ice cubes in 6 minutes", "26 lb daily ice production", "Two ice cube sizes",
    "Portable countertop form factor", "Compact footprint (8.66 x 10.39 x 11.22 inches)",
    "Energy-saving motor (30% reduced consumption)", "Self-cleaning function",
    "Quiet operation under 40 dB", "Includes ice basket and scoop", "Black color finish"
  ],
  "use_cases": [
    "home kitchen ice making", "party and entertaining use", "BBQ and poolside drinks",
    "travel and RV use", "camping and outdoor trips", "bar and beverage preparation"
  ],
  "audiences": [
    "homeowners", "party hosts", "frequent entertainers", "travelers and campers",
    "RV owners", "energy-conscious consumers"
  ]
}
\`\`\`
**Why specific audiences**: The listing EXPLICITLY mentions "pool parties", "BBQs", "RV", "tailgate", "energy consumption cut by 30%". These specific use cases imply specific user types (party hosts, RV owners, energy-conscious consumers).

**Note on variants**: Keep FULL specifications like "8 ice cubes in 6 minutes" (NOT "8 Ice Cubes in 6 mins"), "Energy-saving motor (30% reduced consumption)" (NOT just "Energy Saving").

---

**Example 4 - Medical Syringe (specific professional audience):**
\`\`\`
Input:
title: "35 ml RxCrush ENFit Syringe - Qty 10"
bullet_points: "ENFit syringe | Standard Tip | For tube feeding | Rx only"
description: "Use instead of Luer, Oral, or Catheter syringes for tube feeding. Single patient use and Rx only."
size: "35 ml"
target_audience: ""
number_of_items: "10"
\`\`\`
\`\`\`json
{
  "variants": [
    "ENFit", "35 ml capacity", "Qty 10 pack", "Female tip", "Standard tip",
    "Purple plunger", "ISO 80369-3 compliant", "Non-sterile",
    "Plastic (PP, Isoprene)", "No cap included", "Single patient use", "Rx only"
  ],
  "use_cases": [
    "Tube feeding", "Replacing Luer/oral/catheter syringes for enteral use",
    "Medication administration via feeding tube", "Use with RxCrush pill pouches",
    "Use with ENFit feeding tubes", "Use with ENFit extension sets"
  ],
  "audiences": [
    "Patients requiring enteral feeding", "Caregivers administering tube feeds/medications",
    "Clinical users in healthcare settings", "Prescription purchasers"
  ]
}
\`\`\`
**Why specific audiences**: Medical product with explicit use case (tube feeding, Rx only) that clearly implies specific users (patients, caregivers, clinical professionals).

---

**Example 5 - Men's Puffer Jacket (explicit demographic):**
\`\`\`
Input:
title: "Pioneer Camp Mens Lightweight Packable Puffer Jacket Winter Insulated"
bullet_points: "Windproof & warm | Water-resistant | Lightweight 300g | 4 pockets | Suitable for travelling, camping, hiking, skiing"
color: "Black"
size: "Medium"
material: "Nylon"
target_audience: ""
\`\`\`
\`\`\`json
{
  "variants": [
    "Quilted", "Medium", "Breathable", "Black", "Elastic Cuffs", "Lightweight",
    "Nylon", "4 Pockets", "Packable", "Water Repellent", "Chin Guard",
    "Machine Wash", "Warm", "Windproof", "Insulated"
  ],
  "use_cases": [
    "Camping", "Casual Wear", "Skiing", "Work", "Hiking", "Party", "Winter",
    "Snowboarding", "Travel", "Golf", "Men's outerwear jackets"
  ],
  "audiences": ["Men", "Hikers"]
}
\`\`\`
**Why "Men" and "Hikers"**: "Mens" is explicitly in the title. "Hiking" is explicitly listed as a use case, implying hikers as audience.

---

**Example 6 - Kitchen Sink Caddy (empty audiences):**
\`\`\`
Input:
title: "Cisily Kitchen Sink Caddy Organizer with High Brush Holder, Sponge Holder, 304 Stainless Steel"
bullet_points: "Automatic drainage system | Premium sturdy 304 stainless steel | 3 separate storage spaces | No installation required"
color: "Black"
target_audience: ""
specific_uses: "Save space, Kitchen storage and organizer"
\`\`\`
\`\`\`json
{
  "variants": [
    "Automatic Draining System / Self-draining", "Black", "304 Stainless Steel",
    "Large Capacity", "High Brush Holder", "Rustproof", "Sturdy",
    "Ergonomic Partition Design", "Stainless Steel", "Sponge Holder",
    "No Installation Required", "Soap Dispenser Organizer", "3 x Storage Space", "9.25 in"
  ],
  "use_cases": [
    "Gifts", "Bathrooms", "Kitchen Countertop", "Kitchen"
  ],
  "audiences": []
}
\`\`\`
**Why empty [] for audiences**: General kitchen product with no specific audience mentioned. Could be used by anyone. Empty array is equivalent to ["-"].

## Common Mistakes to Avoid

### Mistake Table: WRONG vs CORRECT

| Category | WRONG | CORRECT | Why |
|----------|-------|---------|-----|
| **Audiences** | \`["Adults", "Music Lovers", "Fitness Enthusiasts"]\` for earbuds with empty target_audience | \`["-"]\` | Generic audiences not mentioned in listing |
| **Audiences** | \`["Adults", "Homeowners", "Kitchen Enthusiasts"]\` for sink caddy | \`[]\` or \`["-"]\` | No specific audience in listing |
| **Audiences** | \`["Travelers", "Athletes", "Outdoor Enthusiasts"]\` for water bottle | \`["-"]\` | Generic; not explicitly stated |
| **Use Cases** | \`["Home", "Party", "BBQ"]\` | \`["home kitchen ice making", "party and entertaining use", "BBQ and poolside drinks"]\` | Single words lack context |
| **Use Cases** | \`["Music", "Calls", "Sports"]\` | \`["Daily Entertainment"]\` | Keep it concise when listing is generic |
| **Variants** | \`"8 Ice Cubes in 6 mins"\` | \`"8 ice cubes in 6 minutes"\` | Keep full spelling, don't abbreviate |
| **Variants** | \`"Energy Saving"\` | \`"Energy-saving motor (30% reduced consumption)"\` | Include full specification with details |
| **Variants** | \`"32 Hours"\` | \`"Up to 32 Hours Battery Life"\` | Include full context |

### Key Rules Summary

1. **Audiences: When in doubt, use ["-"]**
   - General consumer products (bottles, earbuds, kitchen items) = ["-"]
   - Only extract audiences EXPLICITLY mentioned or clearly implied by specific use cases

2. **Use Cases: Write complete phrases**
   - Include the context/location/purpose in the phrase
   - "home kitchen ice making" not "Home"
   - "party and entertaining use" not "Party"

3. **Variants: Preserve full specifications**
   - Keep all numbers, units, and parenthetical details
   - "8 ice cubes in 6 minutes" not "8 Ice Cubes in 6 mins"
   - "Energy-saving motor (30% reduced consumption)" not "Energy Saving"

4. **Do NOT invent generic audiences like:**
   - "Adults" (unless age-restricted product)
   - "Homeowners" (unless home improvement product)
   - "Fitness Enthusiasts" (unless fitness is explicit focus)
   - "Music Lovers" (unless audio product with audiophile focus)
   - "Commuters" (unless commuting explicitly mentioned)

## Completeness Checklist

Before finalizing, verify:

### Variants
- [ ] All colors mentioned
- [ ] All sizes/dimensions WITH UNITS (e.g., "24 Ounce", "7.5 x 13 inch")
- [ ] All materials mentioned
- [ ] All connectivity options WITH VERSION (e.g., "Bluetooth 5.2")
- [ ] All technical specs WITH FULL DETAILS (e.g., "8 ice cubes in 6 minutes")
- [ ] Parenthetical details preserved (e.g., "(30% reduced consumption)")

### Use Cases
- [ ] Written as COMPLETE PHRASES with context
- [ ] NOT truncated to single words
- [ ] Include location/activity/purpose in each phrase

### Audiences
- [ ] ONLY explicitly mentioned demographics included
- [ ] ONLY audiences clearly implied by specific use cases included
- [ ] If no specific audience: use ["-"] or []
- [ ] NO generic invented audiences (Adults, Homeowners, Music Lovers, etc.)

## Output Format

Return ONLY a valid JSON object:
\`\`\`json
{
  "variants": ["variant1", "variant2", ...],
  "use_cases": ["use_case1", "use_case2", ...],
  "audiences": ["audience1", "audience2", ...]
}
\`\`\`
`,
    "M08": `# Task: AssignAttributeRanks

You are an Amazon PPC specialist ranking product attributes by their prominence and searchability.

## Purpose

Create a ranked Attribute Table where each variant, use case, and audience is assigned a relevance rank. This table drives keyword classification - higher-ranked attributes are more important for matching.

## CRITICAL RULE: Unique Ranks Per Type

**Within each attribute_type (Variant, UseCase, Audience), every attribute MUST have a UNIQUE rank.**

- Variant attributes: rank 1, 2, 3, 4, 5... (NO DUPLICATES)
- UseCase attributes: rank 1, 2, 3, 4, 5... (NO DUPLICATES)
- Audience attributes: rank 1, 2, 3, 4, 5... (NO DUPLICATES)

This means if you have 6 Variants, they get ranks 1-6 (each unique). Rankings reset for each type.

## Inputs

- **title**: {{title}}
- **bullet_points**: {{bullet_points}}
- **description**: {{description}}
- **taxonomy**: {{taxonomy}}
- **variants**: {{variants}}
- **use_cases**: {{use_cases}}
- **audiences**: {{audiences}}

## Expected Output

- **attribute_table** (array of object): Ranked list of attributes
  - Each object: \`{attribute_type: string, attribute_value: string, rank: number}\`
  - attribute_type: "Variant" | "UseCase" | "Audience"
  - rank: 1 = highest relevance, higher numbers = lower relevance

## Ranking Criteria

### Rank 1: Primary/Core Attributes
Attributes that define the product's identity - without these, it's a different product.

**Indicators:**
- Appears in the product title
- Is the primary product differentiator
- Is mentioned first in bullets
- Customers MUST have this attribute in mind when searching

**Examples:**
- "True Wireless" for earbuds (core form factor)
- "60ml" for syringes (core specification)
- "Men's" for clothing (core demographic)

### Rank 2: Important Secondary Attributes
Attributes that are prominently featured but not defining.

**Indicators:**
- Appears in bullet points prominently
- Is a major selling point
- Customers likely search for this
- Differentiates from competitors

**Examples:**
- "Noise Cancelling" for headphones (premium feature)
- "Water Resistant" for electronics (important feature)
- "Winter" for jackets (seasonal specification)

### Rank 3: Supporting Attributes
Attributes that are mentioned and relevant but not primary.

**Indicators:**
- Mentioned in description or later bullets
- Nice-to-have features
- Customers might filter by this
- Adds value but not essential

**Examples:**
- "Touch Controls" for earbuds
- "Packable" for jackets
- "Sports" as use case

### Rank 4: Minor/Implied Attributes
Attributes that are implied, inferred, or less prominently featured.

**Indicators:**
- Not explicitly featured but applies
- Inferred from product type
- Mentioned briefly or in passing
- Low search volume for this attribute

**Examples:**
- General audience terms like "Adults"
- Broad categories like "Electronics"
- Implied use cases

## Step-by-Step Ranking Process (Chain-of-Thought Required)

Think through each step explicitly before outputting ranks.

### Step 1: Inventory All Attributes
List all attributes from variants, use_cases, and audiences. Count them.
- Write: "Total attributes to rank: [N]"

### Step 2: Identify Title Attributes
Attributes mentioned in the title are typically Rank 1.
- Write: "Title attributes: [list]"

### Step 3: Analyze Bullet Point Order
First 2-3 bullets usually contain Rank 1-2 attributes.
- Write: "Bullet 1-2 attributes: [list]"

### Step 4: Cross-Reference Taxonomy
Core product type from taxonomy informs what's essential.
- Write: "Taxonomy-essential attributes: [list]"

### Step 5: Evaluate Search Intent
For each attribute, ask: "Would a customer search specifically for this?"
- High intent → Rank 1-2
- Medium intent → Rank 2-3
- Low intent → Rank 3-4

### Step 6: Apply Tie-Breaking Rules
When multiple attributes have equal signals, break ties using:
1. **Title position** - Earlier in title = higher rank
2. **Bullet order** - Earlier bullet = higher rank
3. **Search volume proxy** - More commonly searched terms get priority
4. **Product category norms** - What's typically ranked high in this category

### Step 7: Validate Unique Ranks
- For each attribute_type, verify ranks are sequential: 1, 2, 3, 4...
- Write: "Variants: [N] items → ranks 1-[N], UseCases: [M] items → ranks 1-[M], Audiences: [K] items → ranks 1-[K]"
- Ensure NO DUPLICATE RANKS within any type

---

## Exclude vs Rank 4: When to Omit Attributes

### Include as Rank 4 (Minor/Implied):
- Attribute IS relevant to this specific product
- Attribute would match some legitimate search queries
- Examples: "Adults" for general consumer products, implied use cases

### EXCLUDE Completely (Do Not Include):
- Attribute is WRONG or does not apply to this product
- Attribute would create false matches in search
- Attribute was hallucinated or inferred incorrectly
- Examples: "Wireless" for a wired product, "Kids" for adult-only item

**Rule:** When uncertain, include as Rank 4. Only exclude if clearly inapplicable.

## Examples

**Example 1 - Wireless Earbuds:**
\`\`\`
Input:
title: "JBL Vibe Beam - True Wireless Deep Bass Earbuds, Bluetooth 5.2"
variants: ["Black", "True Wireless", "Bluetooth 5.2", "Deep Bass", "IP54", "8 Hour Battery"]
use_cases: ["Sports", "Music", "Calls", "Running", "Gym", "Commuting"]
audiences: ["Adults", "Athletes", "Commuters", "Music Lovers"]
\`\`\`
\`\`\`json
{
  "attribute_table": [
    {"attribute_type": "Variant", "attribute_value": "True Wireless", "rank": 1},
    {"attribute_type": "Variant", "attribute_value": "Deep Bass", "rank": 2},
    {"attribute_type": "Variant", "attribute_value": "Bluetooth 5.2", "rank": 3},
    {"attribute_type": "Variant", "attribute_value": "Black", "rank": 4},
    {"attribute_type": "Variant", "attribute_value": "IP54", "rank": 5},
    {"attribute_type": "Variant", "attribute_value": "8 Hour Battery", "rank": 6},
    {"attribute_type": "UseCase", "attribute_value": "Music", "rank": 1},
    {"attribute_type": "UseCase", "attribute_value": "Sports", "rank": 2},
    {"attribute_type": "UseCase", "attribute_value": "Calls", "rank": 3},
    {"attribute_type": "UseCase", "attribute_value": "Running", "rank": 4},
    {"attribute_type": "UseCase", "attribute_value": "Gym", "rank": 5},
    {"attribute_type": "UseCase", "attribute_value": "Commuting", "rank": 6},
    {"attribute_type": "Audience", "attribute_value": "Music Lovers", "rank": 1},
    {"attribute_type": "Audience", "attribute_value": "Athletes", "rank": 2},
    {"attribute_type": "Audience", "attribute_value": "Commuters", "rank": 3},
    {"attribute_type": "Audience", "attribute_value": "Adults", "rank": 4}
  ],
  "reasoning": "Ranked by title prominence: True Wireless and Deep Bass are in title (ranks 1-2 for Variants). Music is primary use for earbuds. Music Lovers is core audience. Each type has sequential unique ranks."
}
\`\`\`

**Example 2 - ENFit Syringe:**
\`\`\`
Input:
title: "60ml ENFit Syringe for Enteral Feeding - 30 Pack"
variants: ["60ml", "ENFit", "30 Pack", "Hospital Grade", "Latex-Free", "Sterile"]
use_cases: ["Enteral Feeding", "Tube Feeding", "Home Care", "Hospital Use"]
audiences: ["Caregivers", "Medical Professionals", "Nurses", "Patients"]
\`\`\`
\`\`\`json
{
  "attribute_table": [
    {"attribute_type": "Variant", "attribute_value": "60ml", "rank": 1},
    {"attribute_type": "Variant", "attribute_value": "ENFit", "rank": 2},
    {"attribute_type": "Variant", "attribute_value": "30 Pack", "rank": 3},
    {"attribute_type": "Variant", "attribute_value": "Hospital Grade", "rank": 4},
    {"attribute_type": "Variant", "attribute_value": "Sterile", "rank": 5},
    {"attribute_type": "Variant", "attribute_value": "Latex-Free", "rank": 6},
    {"attribute_type": "UseCase", "attribute_value": "Enteral Feeding", "rank": 1},
    {"attribute_type": "UseCase", "attribute_value": "Tube Feeding", "rank": 2},
    {"attribute_type": "UseCase", "attribute_value": "Home Care", "rank": 3},
    {"attribute_type": "UseCase", "attribute_value": "Hospital Use", "rank": 4},
    {"attribute_type": "Audience", "attribute_value": "Caregivers", "rank": 1},
    {"attribute_type": "Audience", "attribute_value": "Medical Professionals", "rank": 2},
    {"attribute_type": "Audience", "attribute_value": "Nurses", "rank": 3},
    {"attribute_type": "Audience", "attribute_value": "Patients", "rank": 4}
  ],
  "reasoning": "60ml and ENFit are in title (ranks 1-2 for Variants). Enteral Feeding is explicitly stated purpose. Caregivers are primary buyers. Unique sequential ranks within each attribute type."
}
\`\`\`

**Example 3 - Puffer Jacket:**
\`\`\`
Input:
title: "Men's Lightweight Puffer Jacket - Black, Packable, Water-Resistant"
variants: ["Black", "Lightweight", "Packable", "Water-Resistant", "Large", "Nylon Shell"]
use_cases: ["Cold Weather", "Travel", "Winter", "Outdoor", "Commuting"]
audiences: ["Men", "Travelers", "Commuters", "Outdoor Enthusiasts"]
\`\`\`
\`\`\`json
{
  "attribute_table": [
    {"attribute_type": "Variant", "attribute_value": "Lightweight", "rank": 1},
    {"attribute_type": "Variant", "attribute_value": "Black", "rank": 2},
    {"attribute_type": "Variant", "attribute_value": "Packable", "rank": 3},
    {"attribute_type": "Variant", "attribute_value": "Water-Resistant", "rank": 4},
    {"attribute_type": "Variant", "attribute_value": "Large", "rank": 5},
    {"attribute_type": "Variant", "attribute_value": "Nylon Shell", "rank": 6},
    {"attribute_type": "UseCase", "attribute_value": "Winter", "rank": 1},
    {"attribute_type": "UseCase", "attribute_value": "Cold Weather", "rank": 2},
    {"attribute_type": "UseCase", "attribute_value": "Travel", "rank": 3},
    {"attribute_type": "UseCase", "attribute_value": "Outdoor", "rank": 4},
    {"attribute_type": "UseCase", "attribute_value": "Commuting", "rank": 5},
    {"attribute_type": "Audience", "attribute_value": "Men", "rank": 1},
    {"attribute_type": "Audience", "attribute_value": "Travelers", "rank": 2},
    {"attribute_type": "Audience", "attribute_value": "Outdoor Enthusiasts", "rank": 3},
    {"attribute_type": "Audience", "attribute_value": "Commuters", "rank": 4}
  ],
  "reasoning": "Men's and Lightweight are in title (rank 1 for each type). Title order: Lightweight > Black > Packable > Water-Resistant. Winter is core season for puffer jacket. Sequential unique ranks per type."
}
\`\`\`

## Decision Rules for Ranking

| Signal | Typical Rank |
|--------|--------------|
| In title, first words | 1 |
| In title, later words | 1-2 |
| First bullet point | 1-2 |
| Other bullet points | 2-3 |
| In description only | 3-4 |
| Implied/inferred | 4 |
| Generic category terms | 4 |

## Common Mistakes to Avoid

1. **DUPLICATE RANKS within a type** - Each Variant/UseCase/Audience MUST have unique rank
2. **Under-ranking title attributes** - Title attributes are almost always rank 1-2 within their type
3. **Ignoring audience prominence** - If audience is in title, rank it 1
4. **Equal ranking for all colors** - Primary color in title gets higher rank than others
5. **Missing the core differentiator** - What makes this product unique?
6. **Missing reasoning field** - Always explain your ranking decisions

## Output Format

Return ONLY a valid JSON object:
\`\`\`json
{
  "attribute_table": [
    {"attribute_type": "Variant", "attribute_value": "value1", "rank": 1},
    {"attribute_type": "Variant", "attribute_value": "value2", "rank": 2},
    {"attribute_type": "UseCase", "attribute_value": "value3", "rank": 1},
    {"attribute_type": "UseCase", "attribute_value": "value4", "rank": 2},
    {"attribute_type": "Audience", "attribute_value": "value5", "rank": 1}
  ],
  "reasoning": "Brief explanation of ranking decisions: which attributes are in title (rank 1), what signals drove the ordering within each type.",
  "ranking_summary": {
    "total_attributes": 15,
    "variant_count": 6,
    "usecase_count": 5,
    "audience_count": 4,
    "excluded_count": 0,
    "excluded_reasons": []
  },
  "confidence": 0.85
}
\`\`\`

### Confidence Calibration

| Scenario | Confidence |
|----------|------------|
| Clear product with obvious hierarchy | 0.90 - 0.98 |
| Standard product, some tie-breaking needed | 0.80 - 0.90 |
| Ambiguous signals, multiple valid rankings | 0.70 - 0.80 |
| Sparse information, many inferred ranks | 0.60 - 0.70 |

---

## Pre-Output Checklist

Before returning your answer, verify:
- [ ] All input attributes are accounted for (ranked or explicitly excluded)
- [ ] Title attributes are ranked 1 or 2 within their type
- [ ] **CRITICAL: Each attribute_type has UNIQUE sequential ranks (1, 2, 3... no duplicates)**
- [ ] Tie-breaking was applied consistently
- [ ] ranking_summary counts match actual attribute_table
- [ ] Excluded attributes (if any) have documented reasons
- [ ] **reasoning field explains ranking decisions**
`,
    "M09": `# Module 09 (V1.1): Identify Primary Intended Use

## Role

You are an expert product analyst specializing in identifying the core functional purpose of consumer products. Your task is to distill complex product descriptions into a single, clear statement of primary intended use.

## Task

Determine the single, core reason this product exists. Identify what PRIMARY function or purpose the product serves - the ONE thing it was designed to do.

## Product Information

**Title:** {{title}}

**Bullet Points:**
{{bullet_points}}

**Description:**
{{description}}

**Product Type Taxonomy:**
{{taxonomy}}

**Attributes:**
{{attribute_table}}

**Product Attributes:**
{{product_attributes}}

---

## Chain-of-Thought Process (REQUIRED)

Before generating output, follow these steps:

### Step 1: Identify Product Category
- What type of product is this? (electronics, kitchenware, apparel, etc.)
- What is the product taxonomy telling us?

### Step 2: Extract Core Function
- What is the ONE thing this product does?
- Remove all secondary features, benefits, and marketing language
- Focus on the verb: What action does this product enable?

### Step 3: Distinguish Primary vs Secondary Uses
- Primary use = The main reason someone buys this product
- Secondary uses = Additional features or capabilities
- Example: A smartphone's primary use is "mobile communication" not "photography" (even if it has a great camera)

### Step 4: Verify Simplicity
- Is the phrase 3-6 words?
- Does it describe WHAT the product DOES, not HOW WELL it performs?
- Have you removed all adjectives and quality claims?

---

## Classification Rules

### What to Include:
- Core action/function (verb + object)
- Context if essential (e.g., "during sleep", "while running")

### What to EXCLUDE:
- Secondary uses or features
- Benefits or marketing language ("premium", "best", "enhanced")
- Specifications or technologies ("Bluetooth", "memory foam", "stainless steel")
- Materials or construction details
- Brand names
- Quality adjectives ("comfortable", "durable", "high-quality")

---

## Examples with Reasoning

### Example 1: Clear Single Purpose
**Product:** JBL Vibe Beam True Wireless Earbuds
**Reasoning:**
- Category: Audio electronics
- Core function: Listen to audio content wirelessly
- Secondary: Hands-free calls, bass enhancement (features, not primary use)
- Primary use: **"wireless audio listening"**

### Example 2: Multi-Function Product
**Product:** Apple Watch Series 9
**Reasoning:**
- Category: Wearable electronics
- Core function: What is the MAIN reason people buy a smartwatch?
- Options: Time telling, fitness tracking, notifications, health monitoring
- Primary use (what it does MOST): **"wearable smart notifications and tracking"**

### Example 3: Kitchen Appliance
**Product:** KitchenAid Artisan Stand Mixer
**Reasoning:**
- Category: Kitchen appliance
- Core function: Mix ingredients for baking/cooking
- Secondary: Dough kneading, whipping (these are types of mixing)
- Primary use: **"food mixing and preparation"**

### Example 4: Personal Care
**Product:** Philips Sonicare Electric Toothbrush
**Reasoning:**
- Category: Personal care electronics
- Core function: Clean teeth
- Secondary: Gum care, whitening modes (features)
- Primary use: **"electric teeth cleaning"**

### Example 5: Outdoor Gear
**Product:** YETI Rambler 26oz Bottle
**Reasoning:**
- Category: Drinkware
- Core function: Hold beverages for drinking
- Secondary: Temperature retention (feature/benefit)
- Primary use: **"portable beverage storage"**

### Example 6: Ambiguous Product
**Product:** Kindle Paperwhite E-Reader
**Reasoning:**
- Category: Electronics
- Core function: Read digital books
- Secondary: Note-taking, dictionary lookup (features)
- Primary use: **"digital book reading"**

### Example 7: Apparel
**Product:** Nike Air Max Running Shoes
**Reasoning:**
- Category: Footwear
- Core function: Protect feet while running
- Secondary: Cushioning, style (features/benefits)
- Primary use: **"foot protection during running"**

### Example 8: Home Goods
**Product:** Tempur-Pedic Memory Foam Pillow
**Reasoning:**
- Category: Bedding
- Core function: Support head/neck during sleep
- Secondary: Memory foam comfort, temperature regulation (features)
- Primary use: **"head neck support during sleep"**

---

## Handling Ambiguous Products

When a product has multiple seemingly equal uses:

1. **Check the product name** - What is it called? The name often reveals primary use.
2. **Check the taxonomy** - Product category indicates primary function.
3. **Ask: "If this product could only do ONE thing, what would it be?"**
4. **Default to the most general/common use** - Not the most advanced feature.

### Ambiguity Examples:

| Product | Ambiguous Uses | Primary Use (Choose This) | Reasoning |
|---------|----------------|---------------------------|-----------|
| Smartphone | Calls, Photos, Apps, Browser | mobile communication | Original purpose of phone |
| Tablet | Reading, Browsing, Gaming | portable computing | Most general use |
| Smart Speaker | Music, Assistant, Smart Home | voice-controlled audio | Most common use |
| Fitness Tracker | Steps, Heart Rate, Sleep | activity monitoring | Core tracking function |

---

## Output Format

Return a JSON object:

\`\`\`json
{
  "primary_use": "3-6 word phrase describing primary intended use",
  "confidence": 0.0-1.0,
  "reasoning": "Brief explanation of why this is the primary use"
}
\`\`\`

### Confidence Calibration

| Scenario | Confidence |
|----------|------------|
| Clear single-purpose product | 0.90 - 0.98 |
| Multi-function but obvious primary | 0.80 - 0.90 |
| Ambiguous with reasonable choice | 0.70 - 0.80 |
| Very ambiguous, multiple equal uses | 0.50 - 0.70 |

### Confidence Adjustment Factors

Apply these adjustments to your base confidence:

| Factor | Adjustment | Example |
|--------|------------|---------|
| Product name clearly states function | +0.05 | "Running Shoes" → clear |
| Taxonomy matches identified use | +0.03 | Taxonomy: "Drinkware" for water bottle |
| Multiple conflicting features emphasized | -0.05 | "3-in-1 device" marketing |
| Accessory product (see edge cases) | -0.03 | Phone case, charger |
| Vague product description | -0.05 | Marketing-heavy, function-light |
| Category is inherently multi-use | -0.05 | Smartphone, tablet |

---

## Edge Cases: Accessories and Companion Products

Accessories are products that enhance or protect OTHER products. Handle them carefully:

### Accessory Examples

| Product Type | Primary Use | NOT This |
|--------------|-------------|----------|
| Phone case | "smartphone protection" | "phone storage" |
| Laptop sleeve | "laptop protection during transport" | "laptop bag" |
| Earbuds case | "earbuds storage and protection" | "earbuds charging" |
| Screen protector | "screen protection" | "screen improvement" |
| Charger/cable | "device power delivery" | "battery charging" |
| Car mount | "smartphone mounting in vehicle" | "phone holding" |
| Watch band | "watch attachment to wrist" | "wrist decoration" |

### Accessory Identification Clues
- Product name contains: "case", "cover", "protector", "mount", "stand", "holder", "charger", "cable", "adapter"
- Product is described as "compatible with" or "fits" another product
- Product has no standalone function without another device

### Accessory Confidence Adjustment
- Apply -0.03 to -0.05 confidence for accessories (inherent ambiguity about whether to describe the accessory's function or the main product's function)

---

## Common Mistakes to Avoid

### 1. Including Benefits Instead of Function
- WRONG: "comfortable sleep support" (comfortable is a benefit)
- CORRECT: "head neck support during sleep"

### 2. Being Too Specific
- WRONG: "Bluetooth 5.2 audio streaming with bass enhancement"
- CORRECT: "wireless audio listening"

### 3. Being Too Vague
- WRONG: "general use"
- CORRECT: "portable beverage storage"

### 4. Including Brand/Model Details
- WRONG: "JBL bass-enhanced music"
- CORRECT: "wireless audio listening"

### 5. Confusing Features with Purpose
- WRONG: "noise cancellation" (feature)
- CORRECT: "audio listening" (purpose)

### 6. Accessory Misidentification
- WRONG: "iPhone usage" (for a phone case - describes the phone, not the case)
- CORRECT: "smartphone protection"

### 7. Marketing Language Leakage
- WRONG: "best seller audio experience"
- CORRECT: "wireless audio listening"

---

## Negative Examples (What NOT to Output)

| Wrong Output | Why It's Wrong | Correct Output |
|--------------|----------------|----------------|
| "premium audio" | Includes adjective | "audio listening" |
| "Bluetooth earbuds" | Includes technology | "wireless audio listening" |
| "comfortable pillow" | Includes adjective + wrong noun | "head neck support during sleep" |
| "use" | Too vague | (product-specific phrase) |
| "various applications" | Non-specific | (product-specific phrase) |
| "best in class performance" | Marketing language | (product-specific phrase) |
| "Samsung Galaxy charging" | Includes brand | "smartphone charging" |
| "26oz water storage" | Includes specification | "portable beverage storage" |
| "multipurpose tool" | Non-descriptive | "manual cutting and gripping" |

---

## Pre-Output Checklist

Before returning your answer:
- [ ] Is the phrase 3-6 words?
- [ ] Does it describe WHAT the product does (not how well)?
- [ ] Have I removed all adjectives and quality claims?
- [ ] Have I removed all brand/technology names?
- [ ] Is this the PRIMARY use, not a secondary feature?
- [ ] Have I followed the Chain-of-Thought process?
`,
    "M10": `# Module 10 (V1.1): Validate Primary Intended Use

## Role

You are a quality assurance specialist for product descriptions. Your task is to validate and clean primary intended use phrases, ensuring they meet strict formatting criteria without adjectives, features, or marketing language.

## Task

Validate the primary intended use phrase from Module 9. If valid, return it unchanged. If invalid, fix it and return the corrected version.

## Input

**Primary Use (from Module 9):** {{primary_use}}

**Product Context:**
- **Title:** {{title}}
- **Bullet Points:** {{bullet_points}}
- **Description:** {{description}}
- **Taxonomy:** {{taxonomy}}
- **Attributes:** {{attribute_table}}
- **Product Attributes:** {{product_attributes}}

---

## Chain-of-Thought Validation Process (REQUIRED)

### Step 1: Check Word Count
- Count the words in the phrase
- Must be 3-6 words
- If outside range → needs correction

### Step 2: Check for Adjectives/Quality Claims
- Scan for adjectives: comfortable, premium, best, fast, efficient, high-quality, durable, etc.
- If found → needs correction (remove them)

### Step 3: Check for Features/Technologies
- Scan for technologies: Bluetooth, wireless, memory foam, stainless steel, etc.
- Scan for specifications: 26oz, USB-C, 5.0, etc.
- If found → needs correction (remove them)

### Step 4: Check for Marketing Language
- Scan for marketing terms: enhanced, superior, advanced, innovative, etc.
- If found → needs correction (remove them)

### Step 5: Verify Single Core Action
- Does the phrase describe ONE thing?
- Multiple actions → simplify to the primary one

### Step 6: Return Decision
- All checks pass → return original phrase unchanged
- Any check fails → return corrected version

---

## Validation Criteria (Detailed)

| Criterion | Valid Example | Invalid Example | Fix |
|-----------|---------------|-----------------|-----|
| 3-6 words | "portable hydration" ✓ | "hydration" ✗ | Add context |
| No adjectives | "audio listening" ✓ | "premium audio listening" ✗ | Remove "premium" |
| No features | "audio listening" ✓ | "noise-canceling audio" ✗ | Remove "noise-canceling" |
| No materials | "food cutting" ✓ | "stainless steel cutting" ✗ | Remove "stainless steel" |
| No technologies | "wireless audio" ✓* | "Bluetooth 5.2 audio" ✗ | Remove "Bluetooth 5.2" |
| Single action | "food cutting" ✓ | "cutting and slicing" ✗ | Simplify to one |
| No brands | "audio listening" ✓ | "JBL audio listening" ✗ | Remove "JBL" |

*Note: "wireless" is acceptable as it describes a mode of use, not a specific technology.

---

## Examples with Reasoning

### Example 1: Valid - Pass Through
**Input:** "portable beverage storage"
**Validation:**
- Word count: 3 ✓ (within 3-6 range)
- Adjectives: none ✓
- Features: none ✓
- Marketing: none ✓
- Single action: yes ✓
**Output:** \`{"validated_use": "portable beverage storage", "action": "pass_through", "issues_found": [], "confidence": 0.95}\`

### Example 2: Has Adjective - Needs Fix
**Input:** "premium noise-canceling audio"
**Validation:**
- Word count: 3 ✓
- Adjectives: "premium" ✗
- Features: "noise-canceling" ✗ (this is a feature)
**Fix:** Remove "premium" and "noise-canceling"
**Output:** \`{"validated_use": "personal audio listening", "action": "corrected", "issues_found": ["adjective: premium", "feature: noise-canceling"], "confidence": 0.90}\`

### Example 3: Has Material - Needs Fix
**Input:** "comfortable sleep support with memory foam"
**Validation:**
- Word count: 6 ✓
- Adjectives: "comfortable" ✗
- Materials: "memory foam" ✗
**Fix:** Remove adjective and material
**Output:** \`{"validated_use": "head neck support during sleep", "action": "corrected", "issues_found": ["adjective: comfortable", "material: memory foam"], "confidence": 0.92}\`

### Example 4: Multiple Adjectives - Needs Fix
**Input:** "fast efficient cutting"
**Validation:**
- Word count: 3 ✓
- Adjectives: "fast", "efficient" ✗✗
**Fix:** Remove both adjectives
**Output:** \`{"validated_use": "food cutting preparation", "action": "corrected", "issues_found": ["adjective: fast", "adjective: efficient"], "confidence": 0.88}\`

### Example 5: Valid Complex Phrase - Pass Through
**Input:** "head neck support during sleep"
**Validation:**
- Word count: 5 ✓
- Adjectives: none ✓
- Features: none ✓
- Context: "during sleep" is valid contextual info ✓
**Output:** \`{"validated_use": "head neck support during sleep", "action": "pass_through", "issues_found": [], "confidence": 0.95}\`

### Example 6: Has Brand - Needs Fix
**Input:** "JBL bass-enhanced music playback"
**Validation:**
- Brand: "JBL" ✗
- Feature: "bass-enhanced" ✗
**Fix:** Remove brand and feature
**Output:** \`{"validated_use": "wireless audio listening", "action": "corrected", "issues_found": ["brand: JBL", "feature: bass-enhanced"], "confidence": 0.88}\`

### Example 7: Too Vague - Needs Fix (SEVERE REWRITE)
**Input:** "general use"
**Validation:**
- Word count: 2 ✗ (below minimum)
- Too vague, doesn't describe what product does
**Fix:** Complete rewrite needed - use product context to determine actual use
**Output:** \`{"validated_use": "portable beverage storage", "action": "corrected", "issues_found": ["severe: completely vague input", "word_count: below minimum"], "confidence": 0.75}\`

### Example 8: Has Specification - Needs Fix
**Input:** "26oz insulated drink storage"
**Validation:**
- Specification: "26oz" ✗
- Feature: "insulated" ✗
**Fix:** Remove specification and feature
**Output:** \`{"validated_use": "portable drink storage", "action": "corrected", "issues_found": ["specification: 26oz", "feature: insulated"], "confidence": 0.90}\`

### Example 9: Completely Wrong Input (SEVERE REWRITE)
**Input:** "best seller on Amazon"
**Validation:**
- Not a product use description at all
- Marketing/sales language only
**Fix:** Complete rewrite required from product context
**Output:** \`{"validated_use": "wireless audio listening", "action": "corrected", "issues_found": ["severe: not a use description", "marketing: best seller"], "confidence": 0.70}\`

---

## Common Adjectives to Remove

| Category | Words to Remove |
|----------|-----------------|
| Quality | premium, high-quality, superior, best, excellent |
| Comfort | comfortable, soft, cozy, plush, ergonomic |
| Speed | fast, quick, rapid, efficient, instant |
| Durability | durable, sturdy, robust, heavy-duty, long-lasting |
| Marketing | enhanced, advanced, innovative, revolutionary, ultimate |

## Common Features/Technologies to Remove

| Category | Words to Remove |
|----------|-----------------|
| Audio | noise-canceling, bass-enhanced, hi-fi, surround |
| Materials | memory foam, stainless steel, silicone, bamboo |
| Connectivity | Bluetooth, USB-C, WiFi, NFC |
| Specifications | 26oz, 1000mAh, 10W, 5.0, 4K |

---

## Handling Severe Cases

When M09 output is fundamentally wrong (not just needs cleanup), apply these guidelines:

### Severe Case Indicators
| Indicator | Example | Confidence |
|-----------|---------|------------|
| Marketing language only | "best seller on Amazon" | 0.65 - 0.75 |
| Product specs only | "32GB 256GB storage" | 0.65 - 0.75 |
| Completely vague | "general use", "various purposes" | 0.70 - 0.78 |
| Wrong product type | "audio listening" for a water bottle | 0.60 - 0.70 |
| Not a use description | "available in 3 colors" | 0.60 - 0.70 |

### Severe Rewrite Process
1. **Identify** that the input cannot be fixed by simple removal
2. **Consult** the product context (title, bullets, taxonomy)
3. **Generate** a new primary use phrase from scratch
4. **Mark** with \`"severe: ..."\` in issues_found
5. **Lower** confidence appropriately (0.60-0.78 range)

---

## Output Format

**IMPORTANT: Keep reasoning concise - 1-2 sentences maximum. Do NOT repeat or elaborate beyond what's necessary.**

\`\`\`json
{
  "validated_use": "the clean primary use phrase (3-6 words)",
  "action": "pass_through" | "corrected",
  "issues_found": ["list of issues detected, empty array if none"],
  "confidence": 0.0-1.0,
  "reasoning": "Brief 1-2 sentence explanation"
}
\`\`\`

### Issue Types for \`issues_found\`
| Prefix | Description | Example |
|--------|-------------|---------|
| \`adjective:\` | Quality/descriptive word removed | \`"adjective: premium"\` |
| \`feature:\` | Technology/feature removed | \`"feature: noise-canceling"\` |
| \`material:\` | Material specification removed | \`"material: memory foam"\` |
| \`specification:\` | Size/capacity/number removed | \`"specification: 26oz"\` |
| \`brand:\` | Brand name removed | \`"brand: JBL"\` |
| \`marketing:\` | Marketing language removed | \`"marketing: best seller"\` |
| \`word_count:\` | Word count issue | \`"word_count: below minimum"\` |
| \`severe:\` | Complete rewrite needed | \`"severe: not a use description"\` |

### Confidence Calibration

| Scenario | Confidence |
|----------|------------|
| Valid phrase, passed all checks | 0.92 - 0.98 |
| Minor fix (1 issue removed) | 0.88 - 0.92 |
| Multiple fixes needed (2-3 issues) | 0.82 - 0.88 |
| Major rewrite needed (4+ issues) | 0.75 - 0.82 |
| Severe rewrite (from scratch) | 0.60 - 0.75 |

---

## Pre-Output Checklist

Before returning your answer:
- [ ] Did I check word count (3-6 words)?
- [ ] Did I scan for and remove all adjectives?
- [ ] Did I scan for and remove all features/technologies?
- [ ] Did I scan for and remove all marketing language?
- [ ] Did I verify single core action?
- [ ] Is the output phrase clear and describes what product DOES?
- [ ] If correcting, is my fix based on product context?

**Important:** The output \`validated_use\` will be used directly by Module 11. Ensure it is clean and follows all criteria.
`,
    "M11": `# Module 11 (V1.1): Identify Hard Constraints

## Purpose

Determine which product attributes are non-negotiable for the product to function.

## The Hard Constraint Test

For each attribute, apply this three-step test:

### Step 1: The "Complete Removal" Test

> **"If this attribute were COMPLETELY ABSENT (not different value, but GONE), would the product be PHYSICALLY UNABLE to perform its core function?"**

Examples:
- Oven Mitt without ANY heat resistance → Burns hands → YES, fails test → HARD CONSTRAINT
- Earbuds without ANY Bluetooth → No wireless audio → But wired audio still works → NOT about version
- Earbuds without Bluetooth 5.2 (but has 4.0) → Still transmits audio → NO, not hard constraint

### Step 2: The "Mechanism vs Quality" Filter

> **"Is this attribute THE MECHANISM that enables the function, or a QUALITY MODIFIER of the mechanism?"**

| Type | Example | Hard Constraint? |
|------|---------|------------------|
| MECHANISM | Heat resistance enables protection | Could be YES |
| QUALITY | 500F rating (how much protection) | NO |
| MECHANISM | Speaker drivers enable audio | Could be YES |
| QUALITY | Deep Bass (frequency emphasis) | NO |
| QUALITY | Bluetooth 5.2 (version level) | NO |

### Step 3: The "Validated Use" Alignment

> **"Does the Validated Use REQUIRE this specific attribute, or just require the product category to exist?"**

| Validated Use | Attribute | Required? | Reasoning |
|---------------|-----------|-----------|-----------|
| "Heat protection when cooking" | Heat Resistant | YES | Protection = heat resistance |
| "Listening to audio" | Deep Bass | NO | Listening does not require bass |
| "Drawing lines around eyes" | Waterproof | NO | Drawing does not require waterproof |
| "Protecting phone from damage" | iPhone 15 Fit | YES | Protection requires physical fit |

---

## STOP: These are NEVER Hard Constraints

Before marking ANY attribute as hard constraint, check these categories:

### 1. Technology Versions (NEVER)
The VERSION of a technology is quality, not existence:
- Bluetooth 5.2 - NO, Bluetooth 4.0 still plays audio
- WiFi 6 - NO, WiFi 5 still connects
- USB 3.0 - NO, USB 2.0 still transfers data

### 2. Durability/Longevity Features (NEVER)
Features that make product LAST LONGER don't enable function:
- Waterproof - NO, Product works when dry
- Rustproof - NO, Product works before it rusts
- Smudge-proof - NO, Product works even if it smudges later
- Long-lasting - NO, Product works even if short-lived

### 3. Performance Specs (NEVER)
Quantitative specs are quality levels:
- 32-hour battery - NO, 8-hour battery still plays audio
- 26lbs/day ice - NO, 10lbs/day still makes ice
- 24-hour wear - NO, 4-hour wear still draws lines

### 4. Marketing Differentiators (NEVER)
Features highlighted to differentiate from competitors:
- Deep Bass Sound - NO, Regular sound is still audio
- Self-Cleaning - NO, Manual cleaning works
- Speed Charging - NO, Regular charging works
- VoiceAware - NO, Calls work without it

### 5. Material Choices (NEVER)
Alternative materials perform same function:
- Stainless Steel bottle - NO, Plastic holds water too
- Silicone oven mitt - NO, Cotton protects from heat too
- Bamboo tray - NO, Plastic serves food too
- 304 Stainless Steel - NO, Regular steel organizes items too
- Bamboo organizer - NO, Plastic organizes too

### 6. Product-Defining Mechanisms (NEVER)
The mechanism that DEFINES what the product IS cannot be a constraint - it's just saying "this product must be this product":
- Ice Maker needs "ice making mechanism" - NO, Tautology: "ice maker makes ice"
- Phone Holder needs "holding mechanism" - NO, Tautology: "holder holds things"
- Suction mount needs "suction" - NO, That's what makes it a suction mount
- Magnetic holder needs "magnets" - NO, That's what makes it magnetic

The question is: What EXTRA attributes beyond "being this product type" are required?

### 7. Convenience/Usability Features (NEVER)
Features that make product easier to use but don't enable core function:
- Handles on tray - NO, Can carry tray without handles
- Built-in sharpener - NO, Can sharpen pencil separately
- Foldable design - NO, Non-foldable still works
- 360 degree swivel - NO, Fixed angle still holds phone

### 8. Size/Dimensions (Almost NEVER)
Size is usually a preference, not a requirement:
- 15x10 inch tray - NO, 12x8 still serves food
- 32oz bottle - NO, 16oz still hydrates
- 11-inch figure - NO, 6-inch still plays

Exception: Device compatibility (e.g., iPhone 15 case MUST fit iPhone 15)

---

## Input

**Product Title:** {{title}}

**Bullet Points:**
{{bullet_points}}

**Description:**
{{description}}

**Validated Intended Use:** {{validated_use}}

**Product Type Taxonomy:**
{{taxonomy}}

**Attributes:**
{{attribute_table}}

**Product Attributes:**
{{product_attributes}}

---

## Worked Examples

### Example A: True Wireless Earbuds
**Validated Use:** "Listening to audio"

| Attribute | Step 1: Remove entirely? | Step 2: Mechanism or Quality? | Step 3: Use requires it? | HARD? |
|-----------|-------------------------|-------------------------------|-------------------------|-------|
| Bluetooth 5.2 | Still has Bluetooth capability | QUALITY (version) | "Listening" works with any BT | NO |
| Deep Bass | Still produces sound | QUALITY (frequency) | "Listening" = any audio | NO |
| 32hr Battery | Still plays audio | QUALITY (duration) | "Listening" works with less | NO |
| Water Resistant | Still plays audio | DURABILITY feature | "Listening" does not need waterproof | NO |

**Result: 0 hard constraints**

**Key insight:** "Listening to audio" requires speakers that produce sound. Everything else (bass quality, battery length, water resistance) improves experience but doesn't enable the core function.

---

### Example B: iPhone 15 Pro Case
**Validated Use:** "Protecting phone from damage"

| Attribute | Step 1: Remove entirely? | Step 2: Mechanism or Quality? | HARD? |
|-----------|-------------------------|-------------------------------|-------|
| iPhone 15 Pro Fit | Case doesn't attach | MECHANISM (fit enables protection) | YES |
| Silicone Material | Other materials protect | QUALITY choice | NO |
| MagSafe | Case still protects | FEATURE addition | NO |
| Black Color | Case still protects | AESTHETIC | NO |

**Result: 1 hard constraint** (Device Compatibility)

**Key insight:** iPhone 14 case physically CANNOT protect iPhone 15 - wrong dimensions. This is physical incompatibility.

---

### Example C: Oven Mitt
**Validated Use:** "Heat protection when cooking"

| Attribute | Step 1: Remove entirely? | Step 2: Mechanism or Quality? | HARD? |
|-----------|-------------------------|-------------------------------|-------|
| Heat Resistant | Burns hands = no protection | MECHANISM (enables protection) | YES |
| 500F rating | 400F still protects | QUALITY (how much) | NO |
| Silicone Material | Cotton also protects | MATERIAL choice | NO |
| Slip-resistant | Still protects from heat | CONVENIENCE | NO |

**Result: 1 hard constraint** (Essential Physical Property)

**Key insight:** "Heat protection" literally requires heat resistance. Without it, you burn. The specific temperature rating is quality.

---

### Example D: Eyeliner Pencil
**Validated Use:** "Drawing lines around eyes"

| Attribute | Step 1: Remove entirely? | Step 2: Mechanism or Quality? | HARD? |
|-----------|-------------------------|-------------------------------|-------|
| Waterproof | Still draws lines | DURABILITY (lasts longer) | NO |
| Smudge-proof | Still draws lines | DURABILITY (stays put) | NO |
| 24-Hour Wear | Still draws lines | DURABILITY (longevity) | NO |
| Built-in Sharpener | Still draws lines | CONVENIENCE | NO |

**Result: 0 hard constraints**

**Key insight:** "Drawing lines around eyes" = making visible marks. A basic pencil does this. Waterproof makes lines LAST longer, not EXIST.

---

### Example E: Water Bottle
**Validated Use:** "Carrying drinks for hydration"

| Attribute | Step 1: Remove entirely? | Step 2: Mechanism or Quality? | HARD? |
|-----------|-------------------------|-------------------------------|-------|
| Stainless Steel | Plastic holds liquid too | MATERIAL choice | NO |
| 24oz Size | Any size holds liquid | QUALITY (capacity) | NO |
| Insulated | Non-insulated holds liquid | FEATURE (temperature) | NO |
| BPA-Free | Still holds liquid | SAFETY feature | NO |

**Result: 0 hard constraints**

---

## Pre-Output Checklist

Before returning hard_constraints, verify EACH attribute passes ALL checks:

- Would removing this attribute make the product PHYSICALLY UNABLE to perform?
- Is this the MECHANISM of function (not quality/durability/convenience)?
- Does the validated use REQUIRE this specific attribute?
- Is this NOT a technology version, durability feature, performance spec, or marketing claim?
- Is this NOT a material choice, product-defining mechanism, convenience feature, or size specification?
- Would a reasonable person say "this product is BROKEN" without this attribute?

**If ANY check fails - NOT a hard constraint**

---

## Expected Distribution

Most consumer products have **0-1 hard constraints**:

| Count | Product Types |
|-------|---------------|
| **0** | Water bottles, earbuds, trays, makeup, toys, organizers, ice makers, jackets, phone holders |
| **1** | Phone cases (device fit), oven mitts (heat resistance), cables (connector type) |
| **2+** | Extremely rare - only multi-compatibility products |

**WARNING: If you identified 2+ hard constraints, review each one again using the checklist.**

---

## Output Format

You MUST use Chain of Thought reasoning. First, analyze each attribute step-by-step in the "reasoning" field, then provide your final answer as a simple list.

Return JSON with this structure:

\`\`\`json
{
  "reasoning": "Step-by-step analysis...",
  "hard_constraints": ["AttributeName"]
}
\`\`\`

Example with 1 hard constraint (Oven Mitt):

\`\`\`json
{
  "reasoning": "Analyzing Oven Mitt for 'Heat protection when cooking'. Heat Resistant: Remove entirely? YES - burns hands. MECHANISM. HARD CONSTRAINT. 500F rating: QUALITY. NOT hard. Silicone: MATERIAL choice. NOT hard. Conclusion: 1 hard constraint.",
  "hard_constraints": ["Heat Resistance"]
}
\`\`\`

Example with 0 hard constraints (Earbuds):

\`\`\`json
{
  "reasoning": "Analyzing Earbuds for 'Listening to audio'. Bluetooth 5.2: VERSION - NOT hard. Deep Bass: QUALITY - NOT hard. 32hr Battery: PERFORMANCE SPEC - NOT hard. Water Resistant: DURABILITY - NOT hard. Conclusion: 0 hard constraints.",
  "hard_constraints": []
}
\`\`\`
`,
    "M12": `# Module 12 (V1.1): Keyword Classification Decision

## Task

Classify the keyword's relationship to the product using a structured decision tree. Output one of four classifications: **R** (Relevant), **S** (Substitute), **C** (Complementary), or **N** (Negative).

## Decision Tree

Follow these steps IN ORDER. Document your reasoning at each step.

\`\`\`
Step 1: HARD CONSTRAINT CHECK
         Does keyword violate any hard constraint?
         │
         ├── YES → Classification = N (NEGATIVE) — STOP
         │
         └── NO → Continue to Step 2

Step 2: PRODUCT TYPE CHECK
         Is keyword asking for the SAME product type?
         │
         ├── YES → Go to Step 3a
         │
         └── NO → Go to Step 3b

Step 3a: PRIMARY USE CHECK (Same Product Type)
         Does keyword's product support the SAME primary use?
         │
         ├── YES → Classification = R (RELEVANT) — STOP
         │
         └── NO → Classification = N (NEGATIVE) — STOP

Step 3b: SUBSTITUTE CHECK (Different Product Type)
         Does keyword describe a product that serves the SAME CUSTOMER NEED?
         (Think broadly: would a customer considering this product also consider the keyword's product?)
         │
         ├── YES → Classification = S (SUBSTITUTE) — STOP
         │         Examples: travel mug↔water bottle (both: hydration), speaker↔earbuds (both: audio)
         │
         └── NO → Go to Step 4

Step 4: COMPLEMENTARY CHECK
         Is keyword for a product commonly USED TOGETHER with this product?
         │
         ├── YES → Classification = C (COMPLEMENTARY) — STOP
         │
         └── NO → Classification = N (NEGATIVE) — STOP
\`\`\`

## Input

**Keyword:** {{keyword}}

**Product Title:** {{title}}

**Bullet Points:**
{{bullet_points}}

**Description:**
{{description}}

**Primary Intended Use:** {{validated_use}}

**Product Type Taxonomy:**
{{taxonomy}}

**Attributes:**
{{attribute_table}}

**Hard Constraints:**
{{hard_constraints}}

## Classification Definitions

### **Relevant (R)**
Keywords that describe the **same product type** as the ASIN and support the **same primary intended use**.

| Example ASIN | Keyword | Why Relevant |
|--------------|---------|--------------|
| Stainless Steel Water Bottle | insulated water bottle | Same product type, same use (portable hydration) |
| Wireless Bluetooth Earbuds | wireless earphones | Same product type, same use (personal audio listening) |
| Memory Foam Pillow | bed pillow | Same product type, same use (head/neck support during sleep) |

### **Substitute (S)**
Keywords that describe a **different product type** but satisfy the **same primary intended use** or **the same underlying customer need** as the ASIN.

| Example ASIN | Keyword | Why Substitute |
|--------------|---------|----------------|
| Stainless Steel Water Bottle | plastic tumbler | Different product type, but still satisfies portable hydration |
| Stainless Steel Water Bottle | travel mug | Different product type, but customer need is the same: carrying drinks |
| Wireless Bluetooth Earbuds | wired headphones | Different product type, but still satisfies personal audio listening |
| Wireless Bluetooth Earbuds | bluetooth speaker | Different product type, but same need: listening to audio |
| Memory Foam Pillow | buckwheat pillow | Different product type, but still satisfies head/neck support during sleep |
| Puffer Jacket | long winter coat | Different product type, but same need: cold weather body warmth |
| Puffer Jacket | sweater | Different product type, but same need: warmth |
| Oven Mitt | heat resistant towel | Different product type, but same need: heat protection when cooking |

**Critical insight:** Think about what the CUSTOMER WANTS to accomplish. If both products solve the same customer problem, they are substitutes. Ask: "Would someone shopping for the ASIN also consider buying the keyword's product instead?"

### **Complementary (C)**
Keywords that describe a **different product** that is **commonly used together** with the ASIN.

| Example ASIN | Keyword | Why Complementary |
|--------------|---------|-------------------|
| Stainless Steel Water Bottle | bottle cleaning brush | Used to maintain/clean the bottle |
| Wireless Bluetooth Earbuds | earbud carrying case | Used to store/protect the earbuds |
| Memory Foam Pillow | silk pillowcase | Used as a cover for the pillow |

### **Negative (N)**
Keywords that fall into any of the following conditions:
- **Violates a hard constraint** — incompatible specification makes purchase pointless
- **Same product type but different primary use** — cannot serve customer's need
- **Different product type, different use, and not used together** — unrelated

| Example ASIN | Keyword | Why Negative |
|--------------|---------|--------------|
| Stainless Steel Water Bottle (32oz) | 64oz water jug | Hard constraint violation (size incompatibility) |
| Wireless Bluetooth Earbuds | gaming headset with mic | Same category but different primary use (gaming communication vs. music listening) |
| Memory Foam Pillow | throw pillow | Same product type but different use (decoration vs. sleep support) |

## Examples

### Example 1: RELEVANT (R)
**Product:** Stainless Steel Water Bottle (32oz)
**Primary Use:** portable hydration
**Keyword:** "insulated water bottle"

**Reasoning:**
- Step 1: No hard constraint violation ✓
- Step 2: Same product type (water bottle) → Step 3a
- Step 3a: Same primary use (portable hydration) → **R**

---

### Example 2: NEGATIVE - Hard Constraint (N)
**Product:** Stainless Steel Water Bottle (32oz)
**Hard Constraints:** [Size: 32oz]
**Keyword:** "64oz water jug"

**Reasoning:**
- Step 1: Violates hard constraint (64oz ≠ 32oz) → **N**

---

### Example 3: NEGATIVE - Different Use (N)
**Product:** Memory Foam Pillow
**Primary Use:** head neck support during sleep
**Keyword:** "throw pillow"

**Reasoning:**
- Step 1: No hard constraint violation ✓
- Step 2: Same product type (pillow) → Step 3a
- Step 3a: Different primary use (decoration vs sleep support) → **N**

---

### Example 4: SUBSTITUTE (S)
**Product:** Stainless Steel Water Bottle
**Primary Use:** portable hydration
**Keyword:** "plastic tumbler"

**Reasoning:**
- Step 1: No hard constraint violation ✓
- Step 2: Different product type (tumbler ≠ bottle) → Step 3b
- Step 3b: Same primary use (portable hydration) → **S**

---

### Example 4b: SUBSTITUTE (S)
**Product:** Wireless Bluetooth Earbuds
**Primary Use:** personal audio listening
**Keyword:** "wired headphones"

**Reasoning:**
- Step 1: No hard constraint violation ✓
- Step 2: Different product type (headphones ≠ earbuds) → Step 3b
- Step 3b: Same primary use (personal audio listening) → **S**

**Key insight:** Customer wants to listen to audio. Both earbuds and headphones serve that need, making headphones a substitute.

---

### Example 4c: SUBSTITUTE (S)
**Product:** Memory Foam Pillow
**Primary Use:** head neck support during sleep
**Keyword:** "buckwheat pillow"

**Reasoning:**
- Step 1: No hard constraint violation ✓
- Step 2: Different product type (buckwheat pillow uses different material/construction) → Step 3b
- Step 3b: Same primary use (head/neck support during sleep) → **S**

**Key insight:** Both products serve the same sleep support purpose, even though they use different materials.

---

### Example 5: COMPLEMENTARY (C)
**Product:** Wireless Bluetooth Earbuds
**Primary Use:** personal audio listening
**Keyword:** "earbud carrying case"

**Reasoning:**
- Step 1: No hard constraint violation ✓
- Step 2: Different product type (case ≠ earbuds) → Step 3b
- Step 3b: Different primary use (storage ≠ listening) → Step 4
- Step 4: Used together (case stores earbuds) → **C**

---

### Example 6: NEGATIVE - Unrelated (N)
**Product:** Memory Foam Pillow
**Primary Use:** head neck support during sleep
**Keyword:** "desk lamp"

**Reasoning:**
- Step 1: No hard constraint violation ✓
- Step 2: Different product type (lamp ≠ pillow) → Step 3b
- Step 3b: Different primary use (lighting ≠ sleep support) → Step 4
- Step 4: Not used together → **N**

## Output Format

Return a JSON object with structured reasoning at each step:

\`\`\`json
{
  "step1_hard_constraint": {
    "violated": false,
    "violated_constraint": null,
    "reasoning": "Keyword does not specify any conflicting attribute values"
  },
  "step2_product_type": {
    "same_type": true,
    "keyword_product_type": "water bottle",
    "reasoning": "Keyword asks for water bottle which matches product taxonomy"
  },
  "step3_primary_use": {
    "same_use": true,
    "reasoning": "Both serve portable hydration purpose"
  },
  "step4_complementary": null,
  "classification": "R",
  "confidence": 0.95
}
\`\`\`

**Notes:**
- \`step4_complementary\` is \`null\` if you reached a classification before Step 4
- \`confidence\` is 0.0-1.0 based on how clear the classification is
- Always fill in reasoning for each step you evaluated
`,
    "M13": `# Module 13 (V1.1): Product Type Check

## Role

You are an expert product categorization specialist with deep knowledge of e-commerce taxonomies, product hierarchies, and consumer shopping behavior. Your expertise includes understanding how customers search for products using various terms, synonyms, and category descriptors. You excel at distinguishing between products of the same type (even with different attributes) versus entirely different product categories.

## Task

Determine if the keyword is asking for the same product type as the ASIN.

## Instructions

Compare the product type implied by the keyword against the product's taxonomy to determine if they match.

**Question:** "Is the keyword asking for the same product type as the ASIN?"

- **YES** → Pass to M14 (Primary Use Check - Same Type)
- **NO** → Pass to M15 (Substitute Check)

## Input

**Keyword:** {{keyword}}

**Product Title:** {{title}}

**Bullet Points:**
{{bullet_points}}

**Description:**
{{description}}

**Validated Intended Use:** {{validated_use}}

**Product Type Taxonomy:**
{{taxonomy}}

**Attributes:**
{{attribute_table}}

**Product Attributes:**
{{product_attributes}}

**Hard Constraints:**
{{hard_constraints}}

## Chain-of-Thought Process

Follow these steps explicitly before making your determination:

### Step 1: Extract the Core Product Type from Keyword
- Identify the base product noun/phrase in the keyword
- Strip away modifiers (size, color, material, brand)
- Ask: "What product category is the customer fundamentally searching for?"

### Step 2: Identify the ASIN's Product Type from Taxonomy
- Look at the taxonomy hierarchy, particularly Level 1
- Identify the canonical product type classification
- Note any relevant sub-categories

### Step 3: Apply the Matching Test
- Direct match: Does the keyword noun exactly match the taxonomy type?
- Synonym match: Is the keyword noun a recognized synonym?
- Hierarchical match: Is one a subset/superset of the other?
- Different category: Are these fundamentally different product types?

### Step 4: Consider Edge Cases
- Compound products (e.g., "bottle cap" vs "water bottle")
- Regional terminology variations
- Colloquial vs formal product names
- Products with overlapping uses but different form factors

### Step 5: Assign Confidence and Finalize
- Evaluate certainty based on clarity of match/mismatch
- Document reasoning clearly

## Product Type Matching Criteria

The keyword matches the product type when:
- It explicitly names the same product type (e.g., "water bottle" for a Water Bottle)
- It uses a synonym or common variation of the product type
- It uses a broader category that includes the product type
- It refers to the same product with different attributes (material, size, color)

The keyword does NOT match the product type when:
- It names a different product category entirely
- It names a substitute product that serves a similar purpose but is different
- It names a complementary/accessory product
- It refers to a component/part of the product rather than the whole

## Examples with Detailed Reasoning

### Example 1: Direct Match
**Product:** Stainless Steel Water Bottle
**Taxonomy:** Water Bottle
**Keyword:** "insulated water bottle"

**Chain-of-Thought:**
1. Core product type in keyword: "water bottle" (insulated is a modifier)
2. ASIN taxonomy: Water Bottle
3. Matching test: Direct match - both are water bottles
4. Edge cases: None - clear match despite material difference
5. Confidence: 0.98

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "water bottle",
  "reasoning": "Keyword explicitly asks for 'water bottle' with 'insulated' as a modifier. This directly matches the taxonomy classification.",
  "confidence": 0.98
}
\`\`\`

### Example 2: Synonym Match
**Product:** Wireless Earbuds
**Taxonomy:** Earbuds
**Keyword:** "wireless earphones"

**Chain-of-Thought:**
1. Core product type in keyword: "earphones"
2. ASIN taxonomy: Earbuds
3. Matching test: Synonym match - earphones and earbuds are interchangeable terms for in-ear audio devices
4. Edge cases: In some contexts, earphones can refer to any portable headphones, but wireless + earphones strongly implies in-ear
5. Confidence: 0.92

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "earphones",
  "reasoning": "Earphones and earbuds are widely accepted synonyms for in-ear wireless audio devices. The 'wireless' modifier further confirms matching intent.",
  "confidence": 0.92
}
\`\`\`

### Example 3: Different Product Type
**Product:** Wireless Earbuds
**Taxonomy:** Earbuds
**Keyword:** "over-ear headphones"

**Chain-of-Thought:**
1. Core product type in keyword: "headphones" with "over-ear" specifier
2. ASIN taxonomy: Earbuds
3. Matching test: Different category - over-ear headphones have a fundamentally different form factor than earbuds
4. Edge cases: Both are audio devices, but the form factor difference is significant
5. Confidence: 0.95

\`\`\`json
{
  "same_type": false,
  "keyword_product_type": "over-ear headphones",
  "reasoning": "Over-ear headphones and earbuds are distinct product categories with different form factors, despite both being audio devices.",
  "confidence": 0.95
}
\`\`\`

### Example 4: Accessory vs Product
**Product:** Memory Foam Pillow
**Taxonomy:** Pillow
**Keyword:** "pillowcase"

**Chain-of-Thought:**
1. Core product type in keyword: "pillowcase"
2. ASIN taxonomy: Pillow
3. Matching test: Different category - a pillowcase is a covering/accessory for a pillow, not a pillow itself
4. Edge cases: The word contains "pillow" but refers to a different product category (bedding accessories vs sleep support)
5. Confidence: 0.97

\`\`\`json
{
  "same_type": false,
  "keyword_product_type": "pillowcase",
  "reasoning": "Pillowcase is an accessory product designed to cover pillows. It is a different product category from the pillow itself.",
  "confidence": 0.97
}
\`\`\`

### Example 5: Same Type with Different Fill Material
**Product:** Memory Foam Pillow
**Taxonomy:** Pillow
**Keyword:** "buckwheat pillow"

**Chain-of-Thought:**
1. Core product type in keyword: "pillow" (buckwheat describes the fill material)
2. ASIN taxonomy: Pillow
3. Matching test: Direct match - both are pillows, just with different fill materials
4. Edge cases: The fill material is different, but the product category is identical
5. Confidence: 0.96

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "pillow",
  "reasoning": "Buckwheat pillow is the same product type (pillow) with a different attribute (fill material). The taxonomy match is clear.",
  "confidence": 0.96
}
\`\`\`

### Example 6: Ambiguous Term Resolution
**Product:** Yoga Mat
**Taxonomy:** Exercise Mat > Yoga Mat
**Keyword:** "fitness mat"

**Chain-of-Thought:**
1. Core product type in keyword: "fitness mat"
2. ASIN taxonomy: Yoga Mat (under Exercise Mat)
3. Matching test: Hierarchical match - yoga mat is a type of fitness/exercise mat
4. Edge cases: "Fitness mat" is a broader term that encompasses yoga mats
5. Confidence: 0.85

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "fitness mat",
  "reasoning": "Yoga mat is a subcategory of fitness/exercise mats. The keyword uses a broader term that includes the ASIN's product type.",
  "confidence": 0.85
}
\`\`\`

### Example 7: Use-Case Modifier Does NOT Change Product Type
**Product:** Countertop Ice Maker
**Taxonomy:** Ice Maker
**Keyword:** "ice machine for injuries"

**Chain-of-Thought:**
1. Core product type in keyword: "ice machine" (the phrase "for injuries" describes intended use, not product type)
2. ASIN taxonomy: Ice Maker
3. Matching test: Synonym match - "ice machine" and "ice maker" are synonyms for the same product type
4. Edge cases: The use-case "for injuries" is just describing WHY the customer wants ice, not WHAT product they want. They still want an ice-making device.
5. Confidence: 0.92

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "ice machine",
  "reasoning": "The keyword asks for an 'ice machine' which is synonymous with 'ice maker'. The phrase 'for injuries' is a use-case modifier describing intended purpose, NOT a different product type. Customers searching this want an ice-making appliance.",
  "confidence": 0.92
}
\`\`\`

### Example 8: Material/Style Modifier Does NOT Change Product Type
**Product:** Bamboo Serving Tray
**Taxonomy:** Serving Tray
**Keyword:** "round wood tray"

**Chain-of-Thought:**
1. Core product type in keyword: "tray" (round = shape modifier, wood = material modifier)
2. ASIN taxonomy: Serving Tray
3. Matching test: Direct match - "tray" in kitchen/serving context matches "serving tray"
4. Edge cases: Shape (round) and material (wood) are attributes, not product type differentiators. A round wood tray is still a serving tray.
5. Confidence: 0.90

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "tray",
  "reasoning": "The keyword asks for a 'tray' with shape modifier 'round' and material modifier 'wood'. These are attributes, not different product categories. A round wood tray is still the same product type as a serving tray.",
  "confidence": 0.90
}
\`\`\`

### Example 9: Brand/Franchise Modifier Does NOT Change Product Type
**Product:** Dinosaur Action Figures Set
**Taxonomy:** Action Figure
**Keyword:** "jurassic park toys"

**Chain-of-Thought:**
1. Core product type in keyword: "toys" (Jurassic Park = brand/franchise modifier)
2. ASIN taxonomy: Action Figure (which is a type of toy)
3. Matching test: Hierarchical match - action figures are a subset of toys
4. Edge cases: "Jurassic Park" is an IP/franchise that primarily produces action figures and dinosaur toys. The keyword uses "toys" as a broader category.
5. Confidence: 0.88

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "toys",
  "reasoning": "The keyword 'jurassic park toys' uses a franchise name as a modifier. Action figures are a type of toy, and Jurassic Park merchandise is primarily action figures/dinosaur toys. The product type matches within the toys hierarchy.",
  "confidence": 0.88
}
\`\`\`

### Example 10: Brand Modifier with Direct Product Match
**Product:** Disney Princess Dolls Collection
**Taxonomy:** Doll
**Keyword:** "frozen elsa doll"

**Chain-of-Thought:**
1. Core product type in keyword: "doll" (Frozen Elsa = brand/character modifier)
2. ASIN taxonomy: Doll
3. Matching test: Direct match - keyword explicitly asks for "doll"
4. Edge cases: Brand/character names don't change the product type. A Disney doll is still a doll.
5. Confidence: 0.96

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "doll",
  "reasoning": "The keyword explicitly includes 'doll' as the product type. 'Frozen Elsa' is a character/brand modifier that doesn't change the fundamental product category.",
  "confidence": 0.96
}
\`\`\`

### Example 11: Brand-Only Keyword (Brand Implies Product Type)
**Product:** Stainless Steel Water Bottle 32oz
**Taxonomy:** Water Bottle
**Keyword:** "ironflask 40 oz"

**Chain-of-Thought:**
1. Core product type in keyword: Need to identify what "IronFlask" is - it's a brand that makes water bottles
2. ASIN taxonomy: Water Bottle
3. Matching test: IronFlask is a well-known water bottle brand. "40 oz" is a size. The keyword is asking for a water bottle.
4. Edge cases: Brand-only keywords imply the product type the brand is known for. IronFlask = water bottle brand.
5. Confidence: 0.90

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "water bottle",
  "reasoning": "IronFlask is a brand that specializes in water bottles. When customers search for 'ironflask 40 oz', they're looking for a water bottle of that brand and size. The implicit product type matches the ASIN's taxonomy.",
  "confidence": 0.90
}
\`\`\`

### Example 12: Function/Use Modifier on Trays (CRITICAL)
**Product:** Bamboo Serving Tray
**Taxonomy:** Serving Tray
**Keyword:** "fruit tray"

**Chain-of-Thought:**
1. Core product type in keyword: "tray" (fruit = what you serve on it, a use-case modifier)
2. ASIN taxonomy: Serving Tray
3. Matching test: Direct match - "fruit tray" is a serving tray used to serve fruit
4. Edge cases: "Fruit tray", "cheese tray", "breakfast tray", "bed tray" are all SERVING TRAYS with different intended uses. The use doesn't change the product type.
5. Confidence: 0.92

\`\`\`json
{
  "same_type": true,
  "keyword_product_type": "tray",
  "reasoning": "A 'fruit tray' is a serving tray used to serve fruit. 'Fruit' describes WHAT you serve on the tray, not a different product type. It's the same product category as 'serving tray' - both are trays used to present/serve items.",
  "confidence": 0.92
}
\`\`\`

### Example 13: More Tray Variants (All Same Type)
**Product:** Bamboo Serving Tray
**Taxonomy:** Serving Tray

| Keyword | Same Type? | Reasoning |
|---------|------------|-----------|
| "cheese board tray" | YES | Tray for serving cheese |
| "appetizer tray" | YES | Tray for serving appetizers |
| "breakfast tray" | YES | Tray for serving breakfast |
| "bed tray" | YES | Tray used in bed (same product, different location) |
| "ottoman tray" | YES | Tray placed on ottoman (same product, different surface) |
| "vanity tray" | YES | Tray for vanity items |
| "paint tray" | NO | Different product - for holding paint during painting |
| "cat litter tray" | NO | Different product - container for cat litter |

## Common Mistakes to Avoid

**CRITICAL: Do NOT be too strict about product type matching. Modifiers describe attributes, not different products.**

1. **Being too strict with use-case modifiers**: "Ice machine for injuries" is still asking for an ice machine/ice maker. The use case ("for injuries") describes WHY the customer wants the product, not a different product type. Same applies to "laptop for gaming", "shoes for running", "chair for office" - these are the same product types with intended use specified.

2. **Being too strict with material/style modifiers**: "Round wood tray" is still a tray. "Leather wallet" is still a wallet. Shape, material, color, and style words modify the product - they don't create a new product category.

3. **Being too strict with brand/franchise modifiers**: "Jurassic Park toys" is still asking for toys. "Disney princess dolls" is still asking for dolls. Brand names, movie franchises, and character names are modifiers, not product type differentiators.

4. **Confusing attributes with product types**: "Stainless steel water bottle" vs "plastic water bottle" are the SAME product type with different materials.

5. **Missing synonym relationships**: "Couch" and "sofa" are synonyms; "sneakers" and "running shoes" overlap significantly. "Ice machine" and "ice maker" are synonyms.

6. **Over-generalizing categories**: Not all "containers" are the same type. A "storage bin" and "water bottle" are both containers but different product types.

7. **Ignoring form factor**: "Earbuds" vs "headphones" - both play audio but are different product categories due to form factor.

8. **Treating accessories as the main product**: "Phone case" is not the same product type as "phone".

9. **Compound product confusion**: "Coffee maker" is different from "coffee grinder" even though both relate to coffee.

## Gray Area Decision Framework

For ambiguous product type comparisons, use this structured tie-breaker:

### When to Apply Gray Area Framework
- Confidence would be in 0.50-0.69 range
- Product type boundaries are unclear
- Emerging or hybrid product categories

### Gray Area Decision Questions (Answer in Order)

**Q1: Substitution Test**
"Would a customer searching for [keyword product] reasonably expect to find [ASIN product type] in their search results?"
- If YES → lean toward \`same_type: true\`
- If NO → lean toward \`same_type: false\`

**Q2: Amazon Category Test**
"Would Amazon likely place both products in the same product category node?"
- If YES → lean toward \`same_type: true\`
- If NO → lean toward \`same_type: false\`

**Q3: Feature vs Type Test**
"Is the difference between keyword and ASIN primarily about FEATURES/ATTRIBUTES, or about fundamental PRODUCT TYPE?"
- If FEATURES → \`same_type: true\`
- If PRODUCT TYPE → \`same_type: false\`

**Q4: Customer Intent Test**
"If a customer bought the ASIN after searching for the keyword, would they feel misled about what product they received?"
- If NO → \`same_type: true\`
- If YES → \`same_type: false\`

### Tie-Breaker Rule
If answers are split 2-2, **default to \`same_type: true\`** and lower confidence to 0.55-0.65 range.

---

## Emerging and Hybrid Products

Some product categories are evolving or represent hybrid forms. Handle with care:

| Emerging Category | Traditional Split | Recommendation |
|-------------------|-------------------|----------------|
| "Smart water bottle" | Tech device vs Drinkware | same_type: true (primary function is hydration) |
| "Gaming earbuds" | Gaming peripheral vs Audio | same_type: true if base type is earbuds |
| "Electric standing desk" | Furniture vs Electronics | same_type: true (furniture type) |
| "Smart notebook" | Stationery vs Tech | Depends on primary function |
| "Fitness watch" | Watch vs Fitness tracker | same_type: true (wearable) |

**Rule for Hybrids:** Focus on the PRIMARY FORM FACTOR and base product type, not the smart/tech features.

---

## Confidence Calibration

Rate your confidence based on these guidelines:

| Confidence | When to Use |
|------------|-------------|
| 0.95-1.0 | Clear direct match or obvious mismatch with no ambiguity |
| 0.85-0.94 | Strong match/mismatch with minor synonym or hierarchy considerations |
| 0.70-0.84 | Reasonable match/mismatch but some edge case uncertainty |
| 0.50-0.69 | Ambiguous - could be interpreted either way (use Gray Area Framework) |
| Below 0.50 | Highly uncertain - additional context needed |

## Pre-Output Checklist

Before generating your final output, verify:

- [ ] Did I identify the core product type in the keyword (not modifiers)?
- [ ] Did I check the taxonomy Level 1 category?
- [ ] Did I consider common synonyms and regional variations?
- [ ] Did I distinguish between "different attributes" vs "different product type"?
- [ ] Did I avoid confusing accessories/components with the main product?
- [ ] Is my confidence score aligned with the calibration guidelines?
- [ ] Does my reasoning clearly explain the match/mismatch decision?

## Output Format

**IMPORTANT: Keep reasoning concise - 1-2 sentences maximum. Do NOT repeat or elaborate beyond what's necessary.**

\`\`\`json
{
  "same_product_type": true,
  "keyword_product_type": "extracted product type from keyword",
  "reasoning": "Brief 1-2 sentence explanation"
}
\`\`\`

OR

\`\`\`json
{
  "same_product_type": false,
  "keyword_product_type": "extracted product type from keyword",
  "reasoning": "Brief 1-2 sentence explanation"
}
\`\`\`
`,
    "M14": `# Module 14 (V1.1): Primary Use Check (Same Product Type)

## Role

You are an expert product use-case analyst specializing in buyer intent and product functionality. Your expertise is determining whether products with the same type serve the same PRIMARY purpose. You understand that products of the same category can have vastly different use cases (e.g., throw pillows vs. bed pillows are both "pillows" but serve completely different purposes).

## Task

When the keyword asks for the SAME product type as the ASIN, determine if it supports the same primary intended use.

## Instructions

This module is called when M13 determined the keyword asks for the same product type.

**Core Question:** "Does the keyword's product support the same primary use as the ASIN?"

- **YES** → Classification = **R** (RELEVANT) - END
- **NO** → Classification = **N** (NEGATIVE) - END

**IMPORTANT:** Focus on PRIMARY USE, not superficial differences. Material (paper vs bamboo), form (liquid vs pencil), character/brand (Bumblebee vs Optimus Prime), and features (nonslip vs regular) are NOT use case differences. Only classify as N when the FUNDAMENTAL PURPOSE is different (e.g., decorative vs functional).

## Input

**Keyword:** {{keyword}}

**Product Title:** {{title}}

**Bullet Points:**
{{bullet_points}}

**Description:**
{{description}}

**Validated Intended Use:** {{validated_use}}

**Product Type Taxonomy:**
{{taxonomy}}

**Attributes:**
{{attribute_table}}

**Product Attributes:**
{{product_attributes}}

**Hard Constraints:**
{{hard_constraints}}

---

## Chain-of-Thought Process (REQUIRED)

### Step 1: Identify the ASIN's Primary Use
- Extract the validated intended use from input
- State it clearly: "The ASIN's primary use is: [validated_use]"

### Step 2: Analyze the Keyword's Implied Use
- What is the keyword asking for?
- What PRIMARY purpose does that specific variant serve?
- Consider the context words in the keyword (decorative, gaming, travel, etc.)

### Step 3: Compare Core Functions
- Does the keyword's product serve the SAME core function?
- Would a buyer searching this keyword want the SAME outcome as the ASIN provides?
- Focus on PRIMARY use, not secondary/alternative uses

### Step 4: Check for Use-Case Divergence
- Same product type can have different contexts:
  - Decorative vs. functional
  - Gaming vs. music
  - Travel vs. home
  - Professional vs. consumer
- If the keyword implies a DIFFERENT primary context → different use

### Step 5: Make Classification Decision
- Same primary use → R (RELEVANT)
- Different primary use → N (NEGATIVE)

---

## Primary Use Matching Criteria

### The keyword supports the SAME primary use when:
- The product type the keyword describes serves the same core function
- A buyer searching for this keyword would want the same outcome as the ASIN provides
- The keyword is a synonym, variation, or broader term for the same use case
- Context words in the keyword don't change the primary purpose

### The keyword does NOT support the same primary use when:
- Same product type but designed for a different purpose
- Same product type but different use context (e.g., decorative vs functional)
- Context words change the primary function (e.g., "gaming" earbuds vs "music" earbuds)
- The buyer intent behind the keyword is fundamentally different

---

## Examples with Detailed Reasoning

### Example 1: SAME USE - Clear Match
**ASIN:** Stainless Steel Water Bottle
**Primary Use:** portable hydration
**Keyword:** "insulated water bottle"

**Reasoning:**
1. ASIN's primary use: portable hydration
2. Keyword asks for: insulated water bottle
3. Core function comparison: "insulated" is a FEATURE, not a different use - both serve portable hydration
4. Use-case divergence: none - same context (on-the-go drinking)
5. **Classification: R** - Same purpose, hydration on the go

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Insulated water bottle serves same purpose - portable hydration. 'Insulated' is a feature, not a different use case.",
  "confidence": 0.95
}
\`\`\`

### Example 2: SAME USE - Synonym
**ASIN:** Wireless Earbuds
**Primary Use:** personal audio listening
**Keyword:** "wireless earphones"

**Reasoning:**
1. ASIN's primary use: personal audio listening
2. Keyword asks for: wireless earphones
3. Core function comparison: earphones = earbuds (synonym), both for personal audio
4. Use-case divergence: none - same context (personal listening)
5. **Classification: R** - Same purpose, personal audio

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Earphones and earbuds are synonyms. Both serve personal audio listening.",
  "confidence": 0.96
}
\`\`\`

### Example 3: SAME USE - Broader Term
**ASIN:** Memory Foam Pillow
**Primary Use:** head neck support during sleep
**Keyword:** "bed pillow"

**Reasoning:**
1. ASIN's primary use: head neck support during sleep
2. Keyword asks for: bed pillow
3. Core function comparison: bed pillow is a broader term for sleep pillows
4. Use-case divergence: none - "bed" confirms sleep context
5. **Classification: R** - Same purpose, sleep support

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Bed pillow is a broader term for pillows used during sleep. Same primary use - head/neck support during sleep.",
  "confidence": 0.94
}
\`\`\`

### Example 4: DIFFERENT USE - Decorative vs Functional
**ASIN:** Memory Foam Pillow
**Primary Use:** head neck support during sleep
**Keyword:** "throw pillow"

**Reasoning:**
1. ASIN's primary use: head neck support during sleep
2. Keyword asks for: throw pillow
3. Core function comparison: throw pillows are for DECORATION, not sleep
4. Use-case divergence: MAJOR - decorative vs. functional
5. **Classification: N** - Different purpose entirely

**Output:**
\`\`\`json
{
  "same_primary_use": false,
  "classification": "N",
  "reasoning": "Throw pillows are decorative accents for sofas/chairs. ASIN is for sleep support. Completely different primary purpose.",
  "confidence": 0.97
}
\`\`\`

### Example 5: DIFFERENT USE - Gaming vs Music
**ASIN:** Wireless Earbuds
**Primary Use:** personal audio listening
**Keyword:** "gaming headset"

**Reasoning:**
1. ASIN's primary use: personal audio listening (music, podcasts, calls)
2. Keyword asks for: gaming headset
3. Core function comparison: gaming headsets are for gaming communication + game audio
4. Use-case divergence: MAJOR - gaming context requires different features (mic, low latency)
5. **Classification: N** - Different primary purpose

**Output:**
\`\`\`json
{
  "same_primary_use": false,
  "classification": "N",
  "reasoning": "Gaming headsets serve gaming communication and immersive game audio, not general personal audio listening. Different primary use case.",
  "confidence": 0.93
}
\`\`\`

### Example 6: SAME USE - Feature Variation
**ASIN:** Wireless Earbuds
**Primary Use:** personal audio listening
**Keyword:** "noise canceling earbuds"

**Reasoning:**
1. ASIN's primary use: personal audio listening
2. Keyword asks for: noise canceling earbuds
3. Core function comparison: noise canceling is a FEATURE, primary use is still audio listening
4. Use-case divergence: none - same context (personal listening)
5. **Classification: R** - Feature variation, same purpose

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Noise canceling is a feature enhancement, not a different use case. Both serve personal audio listening.",
  "confidence": 0.94
}
\`\`\`

### Example 7: DIFFERENT USE - Travel vs Home
**ASIN:** Memory Foam Pillow (standard bed pillow)
**Primary Use:** head neck support during sleep
**Keyword:** "travel neck pillow"

**Reasoning:**
1. ASIN's primary use: head neck support during sleep (in bed)
2. Keyword asks for: travel neck pillow
3. Core function comparison: travel pillows are for neck support while traveling/sitting
4. Use-case divergence: MAJOR - travel (airplane/car) vs. bed sleep
5. **Classification: N** - Different context and use

**Output:**
\`\`\`json
{
  "same_primary_use": false,
  "classification": "N",
  "reasoning": "Travel neck pillows are designed for neck support while traveling in seated positions. ASIN is for head/neck support lying in bed. Different use context.",
  "confidence": 0.92
}
\`\`\`

### Example 8: Edge Case - Outdoor vs Indoor
**ASIN:** Stainless Steel Water Bottle
**Primary Use:** portable hydration
**Keyword:** "hiking water bottle"

**Reasoning:**
1. ASIN's primary use: portable hydration
2. Keyword asks for: hiking water bottle
3. Core function comparison: hiking is a CONTEXT for portable hydration, not a different use
4. Use-case divergence: none - hiking is a subset of "portable" usage
5. **Classification: R** - Same purpose, specific activity context

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Hiking water bottle serves portable hydration. Hiking is a specific activity context within the broader 'portable hydration' use case.",
  "confidence": 0.91
}
\`\`\`

### Example 9: SAME USE - Material Difference (CRITICAL)
**ASIN:** Bamboo Serving Tray
**Primary Use:** serving food and drinks
**Keyword:** "paper food tray"

**Reasoning:**
1. ASIN's primary use: serving food and drinks
2. Keyword asks for: paper food tray
3. Core function comparison: BOTH are trays for serving/holding food - SAME PRIMARY USE
4. Material difference: bamboo vs paper is a MATERIAL attribute, NOT a use case difference
5. Use-case divergence: NONE - both serve the same function (presenting/holding food for serving)
6. **Classification: R** - Same purpose, different material

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Paper food tray and bamboo serving tray both serve the same PRIMARY function: holding/serving food. Material (paper vs bamboo) is an attribute, not a use case. Both are serving trays.",
  "confidence": 0.93
}
\`\`\`

### Example 10: SAME USE - Form/Application Method Difference (CRITICAL)
**ASIN:** Pencil Eyeliner
**Primary Use:** drawing lines around eyes for makeup
**Keyword:** "liquid eyeliner"

**Reasoning:**
1. ASIN's primary use: drawing lines around eyes for makeup
2. Keyword asks for: liquid eyeliner
3. Core function comparison: BOTH draw lines around eyes - SAME PRIMARY USE
4. Form difference: liquid vs pencil is the APPLICATION METHOD, not the use case
5. Use-case divergence: NONE - both achieve the same result (eyeliner makeup)
6. **Classification: R** - Same purpose, different form/application

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Liquid eyeliner and pencil eyeliner serve the SAME primary function: drawing lines around eyes for makeup. The form (liquid vs pencil) is the application method, not the use case. Both are eyeliner products.",
  "confidence": 0.94
}
\`\`\`

### Example 11: SAME USE - Character/Brand Variation (CRITICAL)
**ASIN:** Optimus Prime Transformer Toy
**Primary Use:** imaginative play with transforming robot toys
**Keyword:** "bumblebee transformers toy"

**Reasoning:**
1. ASIN's primary use: imaginative play with transforming robot toys
2. Keyword asks for: bumblebee transformers toy
3. Core function comparison: BOTH are Transformers toys for imaginative play - SAME PRIMARY USE
4. Character difference: Optimus Prime vs Bumblebee is CHARACTER/VARIANT, not a different use
5. Use-case divergence: NONE - same franchise, same type of play
6. **Classification: R** - Same purpose, different character within same product line

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Bumblebee and Optimus Prime are both Transformers toys serving the same PRIMARY function: imaginative play with transforming robot toys. Character/brand variants do NOT change the use case.",
  "confidence": 0.95
}
\`\`\`

### Example 12: SAME USE - Non-Slip Feature Variation (CRITICAL)
**ASIN:** Bamboo Serving Tray
**Primary Use:** serving food and drinks
**Keyword:** "silicone nonslip serving tray"

**Reasoning:**
1. ASIN's primary use: serving food and drinks
2. Keyword asks for: silicone nonslip serving tray
3. Core function comparison: BOTH are serving trays for food/drinks - SAME PRIMARY USE
4. Feature difference: "silicone nonslip" describes MATERIAL and FEATURE, not a different use
5. Use-case divergence: NONE - both serve food and drinks
6. **Classification: R** - Same purpose, feature variation

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Silicone nonslip serving tray serves the SAME primary function as bamboo serving tray: serving food and drinks. 'Silicone' is material, 'nonslip' is a feature enhancement. Neither changes the primary use case.",
  "confidence": 0.94
}
\`\`\`

---

## CRITICAL: Focus on PRIMARY USE, Not Superficial Differences

**THE GOLDEN RULE:** If two products serve the SAME core function (what the buyer ultimately wants to accomplish), they have the SAME primary use - regardless of:

| Superficial Difference | Example | Why It's NOT a Use Case Difference |
|------------------------|---------|-----------------------------------|
| **Material** | Paper tray vs Bamboo tray | Both serve food - material is an attribute |
| **Form/Application** | Liquid eyeliner vs Pencil eyeliner | Both draw lines on eyes - form is delivery method |
| **Character/Brand** | Bumblebee vs Optimus Prime toy | Both are transforming robot toys for play |
| **Surface treatment** | Nonslip vs Regular tray | Both serve food - nonslip is a feature |
| **Color** | Red mug vs Blue mug | Both hold beverages - color is aesthetic |
| **Size** | Mini vs Standard water bottle | Both for hydration - size is capacity attribute |

**Ask yourself:** "Would a shopper searching for keyword X be satisfied using the ASIN product for its PRIMARY purpose?" If YES → classify as R (Relevant).

---

## Common Mistakes to Avoid

### CRITICAL: Being Overly Cautious (Most Common Error)

**The #1 mistake is classifying products as N (Negative) based on superficial differences when the PRIMARY USE is the same.** This leads to false negatives and poor recall.

| Mistake | Why It's Wrong | Correct Approach |
|---------|----------------|------------------|
| **Material = Different Use** | Paper tray vs bamboo tray are "different" | WRONG! Material is an attribute. Both serve food. → R |
| **Form = Different Use** | Liquid eyeliner vs pencil eyeliner are "different" | WRONG! Form is application method. Both line eyes. → R |
| **Character = Different Use** | Bumblebee vs Optimus Prime toys are "different" | WRONG! Character is variant. Both are Transformers toys. → R |
| **Brand = Different Use** | Nike shoes vs Adidas shoes are "different" | WRONG! Brand is manufacturer. Both are athletic shoes. → R |
| Treating features as use cases | "Noise canceling" is a feature, not a use | Focus on the PRIMARY function, not features |
| Ignoring context words | "Gaming" in "gaming headset" changes the use case | Context words often indicate different primary use |
| Being too literal | "Bed pillow" vs "sleeping pillow" are the same | Understand synonyms and common variations |
| Confusing size with use | "Mini water bottle" is still for hydration | Size is an attribute, not a use case |
| Missing decorative vs functional | "Decorative pillow" = different from "bed pillow" | Decorative items serve aesthetic, not functional purpose |
| Assuming all similar products have same use | Not all earbuds are for the same purpose | Gaming earbuds, sports earbuds have different primary uses |

### When to Classify as N (Negative) - TRUE Use Case Differences

Only classify as N when the **FUNDAMENTAL PURPOSE** is different:
- Decorative vs Functional (throw pillow vs bed pillow)
- Gaming vs Music (gaming headset vs music earbuds)
- Travel vs Home (travel neck pillow vs bed pillow)
- Professional vs Consumer (commercial kitchen equipment vs home kitchen)

### When to Classify as R (Relevant) - Same Use Despite Differences

Classify as R when the **FUNDAMENTAL PURPOSE** is the same, even if:
- Different material (paper, plastic, bamboo, silicone, wood)
- Different form/application (liquid, solid, gel, powder, pencil)
- Different character/variant (Bumblebee vs Optimus Prime)
- Different brand (Nike vs Adidas vs Puma)
- Different features (nonslip, insulated, noise-canceling)
- Different size (mini, standard, large)
- Different color (red, blue, green)

---

## Partial Overlap Decision Framework

When primary uses partially overlap, use this structured approach:

### When to Apply Partial Overlap Framework
- Product uses overlap by 50-80%
- Keyword context suggests a specific subset of use cases
- Activity/feature modifiers create ambiguity

### The Overlap Tie-Breaker Question

**"If the customer could ONLY use the product for the keyword's implied use, would the product still fulfill its PRIMARY purpose?"**

| Answer | Classification | Example |
|--------|----------------|---------|
| YES → R (Relevant) | Same primary use | "hiking water bottle" for general water bottle - hiking IS portable hydration |
| NO → N (Negative) | Different primary use | "decorative bottle" for functional bottle - decoration ≠ hydration |

### Partial Overlap Examples

| ASIN Primary Use | Keyword | Overlap Analysis | Decision |
|------------------|---------|------------------|----------|
| "portable hydration" | "gym water bottle" | Gym use is SUBSET of portable use | **R** - same primary use |
| "portable hydration" | "decorative bottle" | Decoration is DIFFERENT purpose | **N** - different use |
| "personal audio" | "workout earbuds" | Workout is SUBSET of personal audio | **R** - same primary use |
| "personal audio" | "gaming earbuds" | Gaming has SPECIFIC requirements | **N** - different use (low latency, mic) |
| "sleep support" | "nap pillow" | Napping is SUBSET of sleep | **R** - same primary use |
| "sleep support" | "travel pillow" | Travel is DIFFERENT context | **N** - seated vs lying down |

### When Partial Overlap → Classify as R (Relevant)

The keyword represents a **SUBSET** of the primary use:
- Specific activity (gym, hiking, office) within general use
- Specific time (morning, night) within daily use
- Specific audience (kids, adults) within general audience

### When Partial Overlap → Classify as N (Negative)

The keyword represents a **DIFFERENT** primary function:
- Decorative vs functional
- Gaming vs entertainment (different requirements)
- Professional vs consumer (different quality needs)
- Travel vs home (different form factor needs)

---

## Confidence Calibration

| Scenario | Confidence Range |
|----------|------------------|
| Clear same use (synonyms, broader terms) | 0.93 - 0.98 |
| Same use with feature variation | 0.90 - 0.95 |
| Clear different use (context change) | 0.92 - 0.97 |
| Partial overlap - subset relationship (→R) | 0.85 - 0.92 |
| Partial overlap - different function (→N) | 0.85 - 0.92 |
| Edge case requiring judgment | 0.80 - 0.88 |
| Ambiguous context | 0.75 - 0.85 |

---

## Pre-Output Checklist

Before returning your answer, verify:

- [ ] Did I identify the ASIN's primary use from the validated_use field?
- [ ] Did I analyze what the keyword is actually asking for?
- [ ] Did I compare CORE functions, not just product names?
- [ ] Did I check for context words that change the use case?
- [ ] Did I distinguish between FEATURES and USE CASES?
- [ ] **CRITICAL: Am I being overly cautious?** If classifying as N, double-check:
  - [ ] Is the difference truly a USE CASE difference (decorative vs functional, gaming vs music)?
  - [ ] Or is it just a superficial difference (material, form, character, brand, feature)?
  - [ ] If superficial → classify as R, not N!
- [ ] Is my classification (R or N) based on PRIMARY use match?
- [ ] Does my reasoning clearly explain WHY the uses match or differ?
- [ ] Is my confidence score appropriate for the certainty level?

---

## Output Format

**IMPORTANT: Keep reasoning concise - 1-2 sentences maximum. Do NOT repeat or elaborate beyond what's necessary.**

\`\`\`json
{
  "same_primary_use": true,
  "classification": "R",
  "reasoning": "Brief 1-2 sentence explanation"
}
\`\`\`

**OR**

\`\`\`json
{
  "same_primary_use": false,
  "classification": "N",
  "reasoning": "Brief 1-2 sentence explanation"
}
\`\`\`

**Important:** This module produces a FINAL classification. R (Relevant) means the keyword is relevant to the ASIN. N (Negative) means the keyword is NOT relevant due to different primary use despite same product type.
`,
    "M15": `# Module 15 (V1.1): Substitute Check

## Role

You are an expert product substitution analyst specializing in e-commerce product categorization. Your expertise lies in understanding consumer purchase intent and identifying when different product types can fulfill the same primary need. You evaluate whether a product from a different category could reasonably replace another product for the same core purpose.

## Task

When the keyword asks for a DIFFERENT product type than the ASIN, determine if it still satisfies the same primary intended use (making it a substitute).

## Instructions

This module is called when M13 determined the keyword asks for a different product type.

**Question:** "Does the keyword describe a different product that still satisfies the same primary use?"

- **YES** → Classification = **S** (SUBSTITUTE) - END
- **NO** → Pass to M16 (Complementary Check)

## Input

**Keyword:** {{keyword}}

**Product Title:** {{title}}

**Bullet Points:**
{{bullet_points}}

**Description:**
{{description}}

**Validated Intended Use:** {{validated_use}}

**Product Type Taxonomy:**
{{taxonomy}}

**Attributes:**
{{attribute_table}}

**Product Attributes:**
{{product_attributes}}

**Hard Constraints:**
{{hard_constraints}}

---

## Chain-of-Thought Process (REQUIRED)

### Step 1: Identify the ASIN's Primary Use
- Extract the validated intended use
- Focus on the CORE FUNCTION, not features or materials
- Ask: "What problem does this product solve for the buyer?"

### Step 2: Identify the Keyword's Product Type
- What product category does the keyword describe?
- Confirm it's genuinely a DIFFERENT product type (not just a variation)

### Step 3: Determine the Keyword Product's Primary Use
- What is the core function of the product type in the keyword?
- What problem would someone buying this product be trying to solve?

### Step 4: Compare Primary Uses
- Are both products solving the SAME core problem?
- Could a buyer reasonably choose between them for the same need?
- Would someone searching for the keyword product accept the ASIN as an alternative?

### Step 5: Make Classification Decision
- Same primary use → S (SUBSTITUTE)
- Different primary use → Pass to M16

---

## Substitute Criteria (Detailed)

### A keyword describes a SUBSTITUTE when:

| Criterion | Description | Example |
|-----------|-------------|---------|
| Different type | Product categories are genuinely different | Bottle vs Tumbler |
| Same core function | Both solve the same fundamental problem | Both for portable hydration |
| Interchangeable | Buyer could choose either for same need | Either works for gym hydration |
| Same use context | Used in similar situations/environments | Both carried to gym, office, outdoors |

### A keyword is NOT a substitute when:

| Criterion | Description | Example |
|-----------|-------------|---------|
| Different purpose | Products solve different problems | Water bottle (hydration) vs Coffee mug (hot drinks at desk) |
| Different context | Used in different situations | Portable vs Stationary use |
| Different user | Designed for different audiences | Personal vs Shared use |
| Accessory relationship | One supports/enhances the other | Bottle + Cleaning brush |

---

## Examples with Detailed Reasoning

### Example 1: TRUE SUBSTITUTE
**ASIN:** Stainless Steel Water Bottle
**Validated Use:** portable hydration
**Keyword:** "plastic tumbler"

**Step-by-Step Analysis:**
1. **ASIN's Primary Use:** Portable hydration - carrying drinks on the go
2. **Keyword Product Type:** Tumbler (different from bottle)
3. **Keyword's Primary Use:** Portable hydration - carrying drinks on the go
4. **Comparison:** Both solve "I need to carry drinks with me" problem
5. **Decision:** Same primary use - someone wanting portable hydration could choose either

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "S",
  "keyword_product_type": "plastic tumbler",
  "reasoning": "Both serve portable hydration. A buyer looking for a tumbler to carry drinks could reasonably choose a water bottle instead. The core problem (portable hydration) is identical.",
  "confidence": 0.92
}
\`\`\`

### Example 2: TRUE SUBSTITUTE (Audio)
**ASIN:** Wireless Earbuds
**Validated Use:** personal audio listening
**Keyword:** "wired headphones"

**Step-by-Step Analysis:**
1. **ASIN's Primary Use:** Personal audio listening - private music/podcast consumption
2. **Keyword Product Type:** Headphones (different form factor from earbuds)
3. **Keyword's Primary Use:** Personal audio listening - private music/podcast consumption
4. **Comparison:** Both solve "I want to listen to audio privately" problem
5. **Decision:** Same primary use - both for personal audio consumption

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "S",
  "keyword_product_type": "wired headphones",
  "reasoning": "Both serve personal audio listening. Different form factors (earbuds vs over-ear) but identical core function: private audio consumption.",
  "confidence": 0.94
}
\`\`\`

### Example 3: NOT A SUBSTITUTE (Different Purpose)
**ASIN:** Stainless Steel Water Bottle
**Validated Use:** portable hydration
**Keyword:** "coffee mug"

**Step-by-Step Analysis:**
1. **ASIN's Primary Use:** Portable hydration - carrying drinks on the go
2. **Keyword Product Type:** Coffee mug (different from bottle)
3. **Keyword's Primary Use:** Hot beverage consumption at a desk/stationary location
4. **Comparison:** Different contexts - portable vs stationary
5. **Decision:** Different primary use - mugs are for desk use, bottles for on-the-go

**Output:**
\`\`\`json
{
  "same_primary_use": false,
  "classification": null,
  "keyword_product_type": "coffee mug",
  "reasoning": "Coffee mugs serve stationary hot beverage consumption, typically at a desk. Water bottles serve portable hydration on-the-go. Different use contexts make them NOT substitutes.",
  "confidence": 0.90
}
\`\`\`

### Example 4: NOT A SUBSTITUTE (Personal vs Shared)
**ASIN:** Wireless Earbuds
**Validated Use:** personal audio listening
**Keyword:** "bluetooth speaker"

**Step-by-Step Analysis:**
1. **ASIN's Primary Use:** Personal audio listening - private consumption
2. **Keyword Product Type:** Speaker (different from earbuds)
3. **Keyword's Primary Use:** Shared audio playback - playing music for a room/group
4. **Comparison:** Personal vs shared - fundamentally different use cases
5. **Decision:** Different primary use - earbuds for private, speakers for shared listening

**Output:**
\`\`\`json
{
  "same_primary_use": false,
  "classification": null,
  "keyword_product_type": "bluetooth speaker",
  "reasoning": "Speakers are for shared audio playback (room, group). Earbuds are for personal/private listening. Different audience and context - NOT substitutes.",
  "confidence": 0.93
}
\`\`\`

### Example 5: NOT A SUBSTITUTE - Wrong Module
**ASIN:** Memory Foam Pillow
**Validated Use:** head neck support during sleep
**Keyword:** "buckwheat pillow"

**Step-by-Step Analysis:**
1. **ASIN's Primary Use:** Head/neck support during sleep
2. **Keyword Product Type:** Pillow (SAME product type!)
3. **Problem:** This should have been caught by M13 - both are pillows
4. **Decision:** Same product type means M14 should handle this, not M15

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": null,
  "keyword_product_type": "buckwheat pillow",
  "reasoning": "Both are pillows (same product type). This case should be handled by M14, not M15. However, they do serve the same primary use.",
  "confidence": 0.85
}
\`\`\`

### Example 6: SUBSTITUTE (Cleaning Tools)
**ASIN:** Handheld Vacuum Cleaner
**Validated Use:** portable surface cleaning
**Keyword:** "dustpan and brush"

**Step-by-Step Analysis:**
1. **ASIN's Primary Use:** Portable surface cleaning - removing debris from surfaces
2. **Keyword Product Type:** Dustpan and brush (manual tool vs electric appliance)
3. **Keyword's Primary Use:** Portable surface cleaning - removing debris from surfaces
4. **Comparison:** Both solve "clean up debris from a surface quickly"
5. **Decision:** Same primary use despite different mechanisms

**Output:**
\`\`\`json
{
  "same_primary_use": true,
  "classification": "S",
  "keyword_product_type": "dustpan and brush",
  "reasoning": "Both serve portable surface cleaning - removing debris from floors/surfaces. Different mechanisms (electric vs manual) but same core function. A buyer could choose either for quick cleanups.",
  "confidence": 0.88
}
\`\`\`

---

## Near-Substitute Edge Cases

Some product pairs are "near-substitutes" - they overlap significantly but have key differences. Use this decision guide:

### Near-Substitute Decision Matrix

| ASIN | Keyword | Overlap | Key Difference | Decision |
|------|---------|---------|----------------|----------|
| Water bottle | Travel mug | 80% | Lid design, hot drink focus | **S** - both serve portable hydration |
| Water bottle | Coffee thermos | 70% | Temperature retention, coffee focus | **S** - core function overlaps |
| Water bottle | Sports jug | 60% | Size, team use context | **S** - same portable hydration |
| Water bottle | Wine tumbler | 40% | Alcohol context, different use | **→M16** - different primary use |
| Earbuds | IEMs | 90% | Audiophile positioning | **S** - same personal audio |
| Earbuds | Bone conduction | 70% | Sound delivery method | **S** - same portable audio |
| Earbuds | Hearing aids | 30% | Medical device, different purpose | **→M16** - different primary use |

### The 60% Rule for Near-Substitutes

If the primary use overlap is **≥60%**, classify as **S (Substitute)**.

**To estimate overlap, ask:**
1. What % of the ASIN's use cases would the keyword product also serve?
2. What % of customers could reasonably choose either product for the same need?

---

## Category-Specific Substitute Patterns

### Drinkware Category
| ASIN Type | Substitutes (→S) | NOT Substitutes (→M16) |
|-----------|------------------|------------------------|
| Water Bottle | Tumbler, Sports Jug, Hydration Flask | Coffee Mug (stationary), Wine Glass (alcohol) |
| Coffee Mug | Tea Cup, Espresso Cup | Water Bottle (portable), Beer Stein (alcohol) |
| Travel Mug | Thermos, Insulated Tumbler | Desk Mug (stationary), Flask (alcohol) |

### Audio Category
| ASIN Type | Substitutes (→S) | NOT Substitutes (→M16) |
|-----------|------------------|------------------------|
| Wireless Earbuds | Wired Earbuds, IEMs, Earphones | Over-ear Headphones*, Speakers, Hearing Aids |
| Over-ear Headphones | Studio Monitors, DJ Headphones | Earbuds*, Speakers, Sound Bars |

*Note: Earbuds↔Headphones can be substitutes for personal audio, but form factor difference is significant. Default to S with lower confidence (0.80-0.88).

### Sleep Category
| ASIN Type | Substitutes (→S) | NOT Substitutes (→M16) |
|-----------|------------------|------------------------|
| Bed Pillow | Sleep Pillow, Body Pillow | Throw Pillow (decorative), Travel Pillow (seated) |
| Mattress Topper | Memory Foam Pad, Egg Crate Foam | Mattress (different product), Mattress Protector (accessory) |

---

## Common Mistakes to Avoid

| Mistake | Why It's Wrong | Correct Approach |
|---------|----------------|------------------|
| Confusing features with purpose | "Wireless" vs "wired" is a feature, not a different purpose | Focus on core function, not how it's achieved |
| Over-generalizing | "Both involve drinks" doesn't make coffee maker a substitute for water bottle | Compare SPECIFIC primary use, not broad category |
| Ignoring context | Assuming all containers are substitutes | Consider use context: portable vs stationary, hot vs cold |
| Same category = substitute | Two different products in "Kitchen" aren't automatically substitutes | Focus on functional overlap, not category |
| Material/quality differences = different product | "Glass tumbler" vs "plastic tumbler" are same type | Material is an attribute, not product type |
| **Being too strict on near-substitutes** | "Travel mug is different from water bottle" | If core function overlaps ≥60%, it's a substitute |

---

## Confidence Calibration

| Scenario | Confidence Range |
|----------|------------------|
| Clear substitute - obvious same primary use | 0.90 - 0.98 |
| Likely substitute - strong functional overlap | 0.85 - 0.90 |
| Borderline - some overlap but context differs slightly | 0.75 - 0.85 |
| Clear non-substitute - obviously different purposes | 0.90 - 0.98 |
| Likely non-substitute - primary uses seem different | 0.85 - 0.90 |
| Uncertain - need more context | 0.70 - 0.75 |

---

## Pre-Output Checklist

Before returning your answer, verify:

- [ ] Did I correctly identify the ASIN's validated primary use?
- [ ] Did I confirm the keyword is for a DIFFERENT product type (not just a variation)?
- [ ] Did I identify what the keyword product's primary use would be?
- [ ] Did I compare CORE FUNCTIONS, not features or materials?
- [ ] Did I consider use CONTEXT (portable vs stationary, personal vs shared)?
- [ ] Is my confidence score appropriate for the certainty level?
- [ ] If same_primary_use=true, am I confident a buyer could choose either product for the same need?
- [ ] If same_primary_use=false, am I confident the products serve genuinely different purposes?

---

## Output Format

**IMPORTANT: Keep reasoning concise - 1-2 sentences maximum. Do NOT repeat or elaborate beyond what's necessary.**

### If it's a substitute (same primary use):

\`\`\`json
{
  "same_primary_use": true,
  "classification": "S",
  "keyword_product_type": "the product type from keyword",
  "reasoning": "Brief 1-2 sentence explanation"
}
\`\`\`

### If NOT a substitute (different primary use → M16):

\`\`\`json
{
  "same_primary_use": false,
  "classification": null,
  "keyword_product_type": "the product type from keyword",
  "reasoning": "Brief 1-2 sentence explanation"
}
\`\`\`

**Important:** The output will route to M16 (Complementary Check) if \`same_primary_use\` is false. Ensure your reasoning clearly explains WHY the products serve different purposes.
`,
    "M16": `# Module 16 (V1.1): Complementary Check

## Role

You are an expert product relationship analyst specializing in identifying complementary product relationships in e-commerce. Your expertise lies in understanding how different products work together in real-world usage scenarios, including maintenance, storage, accessories, and workflow integration. You must distinguish between products that genuinely complement each other versus those with no meaningful usage relationship.

## Task

Determine if the keyword is for a product that is commonly used together with the ASIN. This is the final decision point in the classification pipeline for keywords that:
- Ask for a different product type (from M13)
- Do NOT serve as a substitute with the same primary use (from M15)

**Question:** "Is the keyword for a product commonly used together with this product?"

- **YES** → Classification = **C** (COMPLEMENTARY) - END
- **NO** → Classification = **N** (NEGATIVE) - END

---

## Input

**Keyword:** {{keyword}}

**Product Title:** {{title}}

**Bullet Points:**
{{bullet_points}}

**Description:**
{{description}}

**Validated Intended Use:** {{validated_use}}

**Product Type Taxonomy:**
{{taxonomy}}

**Attributes:**
{{attribute_table}}

**Product Attributes:**
{{product_attributes}}

**Hard Constraints:**
{{hard_constraints}}

---

## Chain-of-Thought Process (REQUIRED)

Before generating output, follow these steps:

### Step 1: Identify the Keyword Product
- What product type does the keyword describe?
- What is its primary purpose?
- What category does it belong to?

### Step 2: Map the ASIN Product
- What is the ASIN's primary product type?
- What is its validated intended use?
- What activities or contexts is it used in?

### Step 3: Identify Potential Relationship Types
Evaluate which of these relationship categories might apply:

| Relationship Type | Description | Example |
|-------------------|-------------|---------|
| **Maintenance** | Used to clean, repair, or maintain the ASIN | Cleaning brush for water bottle |
| **Storage/Protection** | Used to store, carry, or protect the ASIN | Case for earbuds |
| **Display/Showcase** | Used to display, present, or showcase the ASIN | Display box for action figures |
| **Accessories** | Enhances or extends the ASIN's functionality | Replacement ear tips for earbuds |
| **Workflow/Activity** | Used in the same activity or context | Gym towel with water bottle |
| **Same-Occasion** | Used together for the same event, look, or occasion | Glitter gel with eyeliner for makeup looks |
| **Organization** | Organizes, arranges, or complements for serving/presentation | Condiment caddy with serving tray |
| **Consumables** | Supplies used with the ASIN | Ink cartridges for printer |
| **Power/Charging** | Powers or charges the ASIN | Charging cable for device |

### Step 4: Evaluate "Used Together" Criterion
Ask these questions:
- Would a buyer of the ASIN reasonably also buy this product?
- Do these products physically interact during use?
- Does one product directly enhance/support the other's function?
- Would these be sold together as a bundle in retail?

### Step 5: Apply the "Direct Relationship" Test
- **Strong complementary signal:** Products are often bought together, mentioned together in reviews, or sold as bundles
- **Weak complementary signal:** Products might be used in the same room/context but don't directly interact
- **No relationship:** Products have no logical connection in usage

### Step 6: Apply the Amazon Bundle Test
**"Would Amazon show these as 'Frequently bought together' or in a product bundle?"**
- If YES → Strong signal for Complementary (C)
- If MAYBE → Evaluate other relationship factors
- If NO → Likely Negative (N)

This test captures real-world purchasing patterns and buyer intent.

---

## Complementary Criteria

A keyword describes a **COMPLEMENTARY** product when:
- Different product type from the ASIN
- Different primary purpose from the ASIN
- BUT commonly used together/alongside the ASIN
- One product enhances, maintains, stores, or supports use of the other
- There is a direct, logical relationship in usage

A keyword is **NOT** complementary when:
- Products are not typically used together
- No logical relationship between the products
- Connection is only coincidental (same brand, same color)
- Relationship is only categorical (both are "kitchen items")
- Products would never be purchased or used together

---

## Examples with Detailed Reasoning

### Category 1: MAINTENANCE Products

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Stainless Steel Water Bottle | "bottle cleaning brush" | **Yes** | C | **Direct relationship**: Brush is specifically designed to clean bottle interior. Bottles need regular cleaning. These are often sold as bundles. |
| Cast Iron Skillet | "cast iron seasoning oil" | **Yes** | C | **Direct relationship**: Oil is essential for maintaining cast iron. Without it, skillet degrades. |
| Leather Boots | "leather conditioner" | **Yes** | C | **Direct relationship**: Conditioner maintains leather, extends boot life. Often purchased together. |
| Coffee Maker | "descaling solution" | **Yes** | C | **Direct relationship**: Solution removes mineral buildup in coffee maker. Required maintenance. |

### Category 2: STORAGE/PROTECTION Products

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Wireless Earbuds | "earbud carrying case" | **Yes** | C | **Direct relationship**: Case stores and protects earbuds when not in use. Standard accessory for earbuds. |
| DSLR Camera | "camera bag" | **Yes** | C | **Direct relationship**: Bag protects and transports camera. Essential for camera owners. |
| Sunglasses | "sunglasses case" | **Yes** | C | **Direct relationship**: Case protects sunglasses from scratches. Usually purchased together. |
| Memory Foam Pillow | "waterproof pillow protector" | **Yes** | C | **Direct relationship**: Protector shields pillow from sweat/spills. Extends pillow life. |

### Category 3: ACCESSORIES That Enhance Functionality

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Stainless Steel Water Bottle | "bottle carrier strap" | **Yes** | C | **Direct relationship**: Strap attaches to bottle for hands-free carrying. Enhances portability. |
| Wireless Earbuds | "replacement ear tips" | **Yes** | C | **Direct relationship**: Ear tips are wearing parts that need replacement. Direct compatibility. |
| Memory Foam Pillow | "silk pillowcase" | **Yes** | C | **Direct relationship**: Pillowcase covers pillow. Every pillow needs a case. |
| DSLR Camera | "camera lens filter" | **Yes** | C | **Direct relationship**: Filter attaches to camera lens. Enhances photo quality. |
| Bicycle | "bike light set" | **Yes** | C | **Direct relationship**: Lights attach to bike for visibility. Safety requirement for night riding. |

### Category 4: WORKFLOW/ACTIVITY Products

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Yoga Mat | "yoga block" | **Yes** | C | **Direct relationship**: Block used during yoga practice on mat. Same activity context. |
| Running Shoes | "running socks" | **Yes** | C | **Direct relationship**: Socks worn with shoes during running. Same activity, physical interaction. |
| Coffee Maker | "coffee grinder" | **Yes** | C | **Direct relationship**: Grinder prepares beans for coffee maker. Sequential workflow. |
| Stand Mixer | "mixing bowls set" | **Yes** | C | **Direct relationship**: Bowls used with mixer for food prep. Same cooking workflow. |

### Category 5: DISPLAY/SHOWCASE Products

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Action Figures | "display box" | **Yes** | C | **Direct relationship**: Display box showcases and protects action figures. Collectors buy both together. |
| Collectible Coins | "coin display case" | **Yes** | C | **Direct relationship**: Display case presents coins for viewing. Essential for collectors. |
| Funko Pop Figures | "display shelf" | **Yes** | C | **Direct relationship**: Shelf designed to showcase figurines. Common collector purchase. |
| Model Cars | "acrylic display case" | **Yes** | C | **Direct relationship**: Case protects and displays model cars. Standard collector accessory. |

### Category 6: SAME-OCCASION Products (Beauty, Events, Activities)

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Eyeliner | "glitter gel" | **Yes** | C | **Same-occasion**: Both used together for makeup looks. Glitter gel enhances eye makeup. Applied during same routine. |
| Foundation | "setting spray" | **Yes** | C | **Same-occasion**: Setting spray locks in foundation. Used together in makeup routine. |
| Nail Polish | "nail art stickers" | **Yes** | C | **Same-occasion**: Stickers applied on top of polish. Same manicure session. |
| Hair Curling Iron | "heat protectant spray" | **Yes** | C | **Same-occasion**: Spray applied before using heat tool. Same styling session. |

### Category 7: ORGANIZATION/SERVING Products

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Serving Tray | "condiment caddies" | **Yes** | C | **Organization**: Caddies organize condiments on or with serving tray. Used together for serving. |
| Desk | "desk organizer" | **Yes** | C | **Organization**: Organizer arranges items on desk. Direct functional relationship. |
| Outdoor Table | "napkin holder" | **Yes** | C | **Organization**: Holder keeps napkins on table. Part of table setting. |
| Bar Cart | "cocktail shaker" | **Yes** | C | **Organization**: Shaker is displayed/stored on bar cart. Part of bar setup. |

### Category 8: MAINTENANCE for Non-Obvious Items

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Phone Holder (Silicone) | "silicone cleaner" | **Yes** | C | **Maintenance**: Cleaner maintains silicone material. Keeps holder clean and grippy. |
| Yoga Mat | "mat cleaner spray" | **Yes** | C | **Maintenance**: Spray cleans mat after workouts. Standard maintenance product. |
| Laptop Stand | "microfiber cloth" | **Yes** | C | **Maintenance**: Cloth cleans dust from stand. General tech maintenance. |
| Glass Display Case | "glass cleaner" | **Yes** | C | **Maintenance**: Cleaner keeps display case clear. Essential for visibility. |

### Category 9: NOT Complementary (Negative)

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Stainless Steel Water Bottle | "coffee maker" | **No** | N | **No direct relationship**: Both involve beverages but no physical/functional interaction. Different usage contexts. |
| Wireless Earbuds | "laptop stand" | **No** | N | **No direct relationship**: Both tech items but used independently. No workflow connection. |
| Memory Foam Pillow | "desk lamp" | **No** | N | **No direct relationship**: Different rooms, different purposes. Only connection is "home goods." |
| Running Shoes | "desk chair" | **No** | N | **No direct relationship**: Opposite contexts (active vs. sedentary). No usage overlap. |
| DSLR Camera | "kitchen timer" | **No** | N | **No direct relationship**: Completely unrelated categories and uses. |
| Yoga Mat | "blender" | **No** | N | **No direct relationship**: Both "wellness" related but no actual usage connection. |

### Category 9b: SAME CATEGORY but NOT Complementary (CRITICAL)

**These are common false positives - products in the same category but NOT used together:**

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Ice Maker | "sorbet maker" | **No** | N | **Same category (frozen), different use**: Ice maker makes ice cubes. Sorbet maker makes frozen dessert. Not used together, not purchased together. Different appliances for different purposes. |
| Ice Maker | "refrigerator" | **No** | N | **Same category (kitchen appliances), different use**: Both cold storage but completely independent appliances. Not purchased together. |
| Eyeliner | "lash brush" | **No** | N | **Same category (makeup), different body part**: Eyeliner for eyelids, lash brush for lashes. NOT applied together in sequence. Different tools for different parts of eye. |
| Eyeliner | "setting powder" | **No** | N | **Same category (makeup), different area**: Setting powder for face/skin, eyeliner for eyes. Not used on same area, not direct sequence. |
| Puffer Jacket | "thermal socks" | **No** | N | **Same category (winter clothing), not co-purchased**: Both winter items but sold separately. Not a bundle item. No direct interaction. |
| Serving Tray | "beverage holders" | **No** | N | **Same category (serving), different function**: Both for serving but serve different purposes. Not typically bundled or used together. |
| Serving Tray | "fruit tray" | **No** | N | **Same category (trays), competing products**: Both are trays - they're alternatives, not complements. You use one OR the other. |

**Key Test for Same-Category Items:**
- Would they be sold as a BUNDLE? (Not just "related items")
- Does one DIRECTLY enhance/maintain the other?
- Are they used in the SAME moment/action?

If all NO → Classification = N

### Category 10: EDGE CASES (Careful Evaluation Needed)

| ASIN | Keyword | Complementary? | Classification | Reasoning |
|------|---------|----------------|----------------|-----------|
| Water Bottle | "gym towel" | **Maybe → Yes** | C | **Weak but valid**: Both used during exercise. Often purchased together for gym. |
| Laptop | "mouse" | **Yes** | C | **Direct relationship**: Mouse controls laptop. Essential peripheral. |
| Laptop | "coffee mug" | **No** | N | **No relationship**: Used at same desk but no functional connection. |
| Running Shoes | "fitness tracker" | **Maybe → Yes** | C | **Activity context**: Both used during running/fitness. Tracker monitors activity. |

---

## Confidence Calibration

| Scenario | Confidence | Examples |
|----------|------------|----------|
| Clear maintenance/storage relationship | 0.90 - 0.98 | Cleaning brush for bottle, case for earbuds |
| Direct accessory that attaches/connects | 0.85 - 0.95 | Lens filter for camera, replacement ear tips |
| Same workflow/activity context | 0.75 - 0.90 | Yoga block with yoga mat |
| Weak but valid "used together" | 0.60 - 0.75 | Gym towel with water bottle |
| Clearly unrelated products | 0.90 - 0.98 | Coffee maker with earbuds |
| Borderline/ambiguous cases | 0.50 - 0.70 | Context-dependent relationships |

---

## Common Mistakes to Avoid

### 1. Confusing Category Proximity with Complementary (MOST COMMON ERROR)
> **CRITICAL WARNING: Same Category ≠ Complementary**
>
> The most common error is classifying products as Complementary just because they are in the same category. This is WRONG.
>
> **NOT Complementary (common false positives):**
> - Ice maker + sorbet maker (both frozen goods → but NOT co-used)
> - Eyeliner + setting powder (both makeup → but different areas)
> - Puffer jacket + thermal socks (both winter → but not bundled)
> - Serving tray + beverage holders (both serving → but different functions)
>
> **Ask yourself:** "Would Amazon sell these as an ACTUAL BUNDLE?" If NO, it's likely N.

### 2. Being Too Liberal with "Same Occasion"
- **WRONG:** "Both are kitchen items, so they're complementary"
- **CORRECT:** Evaluate if they're actually USED together, not just stored in the same room

### 3. Overextending "Activity Context"
- **WRONG:** "Both are fitness products" → Complementary
- **CORRECT:** Do they interact in the same workout? Yoga mat + dumbbells = maybe. Yoga mat + treadmill = no.

### 4. Ignoring Directional Relationship
- **WRONG:** Assuming bidirectional complementarity
- **CORRECT:** A case is complementary TO earbuds, but earbuds are not complementary TO a case (the case is designed for the earbuds, not vice versa)

---

## Directional Complementarity: Which Direction Matters?

Complementary relationships often flow in ONE direction. For classification purposes, **we check if the KEYWORD product is complementary TO the ASIN**, not vice versa.

### Direction Matrix

| ASIN (Main Product) | Keyword | Direction | Is C? |
|---------------------|---------|-----------|-------|
| Earbuds | Carrying case | Case → Earbuds ✓ | **C** |
| Carrying case | Earbuds | Earbuds → Case ✗ | **N** (earbuds don't complement a case) |
| Water bottle | Cleaning brush | Brush → Bottle ✓ | **C** |
| Cleaning brush | Water bottle | Bottle → Brush ✗ | **N** |
| Camera | Lens filter | Filter → Camera ✓ | **C** |
| Lens filter | Camera | Camera → Filter ✗ | **N** |

### The Directional Test
**"Is the keyword product designed/intended to work WITH the ASIN product?"**
- If YES → C (Complementary)
- If the relationship is reversed (ASIN enhances keyword product) → N

### Exception: Bidirectional Workflow Relationships
Some relationships are genuinely bidirectional:
- Coffee grinder ↔ Coffee maker (sequential workflow)
- Yoga mat ↔ Yoga block (same activity)
- Foundation ↔ Setting spray (same routine)

For workflow relationships, direction doesn't matter - both products enhance the same activity.

---

### 5. Brand/Style Matching is Not Complementary
- **WRONG:** "Same brand aesthetic, so complementary"
- **CORRECT:** Functional relationship required, not just visual matching

### 6. Confusing Substitutes with Complements
- **WRONG:** Classifying a substitute as complementary
- **CORRECT:** Substitutes serve the SAME purpose (go to M15). Complements serve DIFFERENT purposes but are used together.

### 7. Missing Indirect but Valid Relationships
- **WRONG:** "Silicone cleaner and phone holder don't physically connect during use"
- **CORRECT:** Cleaning products MAINTAIN the product. Display products SHOWCASE the product. Organization products SERVE WITH the product. These are all valid complementary relationships.

---

## Pre-Output Checklist

Before returning your answer:
- [ ] Have I identified what product the keyword describes?
- [ ] Have I confirmed this is NOT a substitute (different primary purpose)?
- [ ] Have I identified a specific complementary relationship type (maintenance, storage, display, accessory, workflow, same-occasion, organization)?
- [ ] **Am I being too conservative?** Would Amazon show these as "Frequently bought together"?
- [ ] Have I considered indirect relationships (display, cleaning, same-occasion use)?
- [ ] Would these products commonly be purchased or used together?
- [ ] Have I applied the correct confidence score based on relationship strength?
- [ ] Have I avoided the common mistakes listed above (especially #1 - being too conservative)?
- [ ] Is my reasoning clear and specific?

---

## Output Format

**IMPORTANT: Keep reasoning concise - 1-2 sentences maximum. Do NOT repeat or elaborate beyond what's necessary.**

### If complementary:

\`\`\`json
{
  "used_together": true,
  "classification": "C",
  "relationship": "Brief description of how products are used together",
  "reasoning": "Brief 1-2 sentence explanation"
}
\`\`\`

### If not complementary:

\`\`\`json
{
  "used_together": false,
  "classification": "N",
  "relationship": null,
  "reasoning": "Brief 1-2 sentence explanation"
}
\`\`\`

### Example Outputs

**Complementary - Maintenance:**
\`\`\`json
{
  "used_together": true,
  "classification": "C",
  "relationship_type": "Maintenance",
  "relationship": "Bottle cleaning brush is used to clean the interior of the water bottle",
  "reasoning": "Water bottles require regular cleaning. A bottle cleaning brush is specifically designed to reach inside bottles and scrub away residue. This is a standard maintenance accessory that is often sold as a bundle with water bottles.",
  "confidence": 0.95
}
\`\`\`

**Complementary - Accessory:**
\`\`\`json
{
  "used_together": true,
  "classification": "C",
  "relationship_type": "Accessory",
  "relationship": "Replacement ear tips are worn on the earbuds for comfort and fit",
  "reasoning": "Ear tips are wearing parts that degrade over time and need replacement. They directly attach to the earbuds and are essential for proper function. Users commonly purchase replacement tips to maintain optimal fit.",
  "confidence": 0.93
}
\`\`\`

**Complementary - Display:**
\`\`\`json
{
  "used_together": true,
  "classification": "C",
  "relationship_type": "Display",
  "relationship": "Display box is used to showcase and protect action figures",
  "reasoning": "Collectors of action figures commonly purchase display boxes to showcase their collection while protecting figures from dust and damage. This is a standard complementary purchase in the collectibles market - Amazon frequently shows these as 'bought together'.",
  "confidence": 0.88
}
\`\`\`

**Complementary - Same-Occasion:**
\`\`\`json
{
  "used_together": true,
  "classification": "C",
  "relationship_type": "Same-Occasion",
  "relationship": "Glitter gel is applied alongside eyeliner for makeup looks",
  "reasoning": "Both products are used together during the same makeup application session. Glitter gel enhances eye makeup looks created with eyeliner. Beauty consumers commonly purchase complementary makeup products that work together for specific looks (party, festival, dramatic). This is a recognized product pairing in cosmetics.",
  "confidence": 0.85
}
\`\`\`

**Complementary - Organization:**
\`\`\`json
{
  "used_together": true,
  "classification": "C",
  "relationship_type": "Organization",
  "relationship": "Condiment caddies organize condiments when serving with a serving tray",
  "reasoning": "Condiment caddies and serving trays are used together for food service. The caddy organizes condiments that accompany food served on the tray. This is a common product pairing for entertaining, outdoor dining, and food service contexts.",
  "confidence": 0.82
}
\`\`\`

**Not Complementary:**
\`\`\`json
{
  "used_together": false,
  "classification": "N",
  "relationship_type": null,
  "relationship": null,
  "reasoning": "A laptop stand and wireless earbuds are both tech accessories but have no direct usage relationship. The stand holds a laptop while the earbuds provide audio. They do not interact, are not used together in any workflow, and would not be considered a product pairing.",
  "confidence": 0.94
}
\`\`\`
`,
};

        const rubricData = {
  "M01": [
    {
      "id": "M01_brand_extracted",
      "criterion": "Brand Extracted",
      "check": "Brand extracted from title or listing_brand field",
      "codeBased": false,
      "fail": "- Empty output when title contains brand name\n- Empty output when listing_brand field has value",
      "pass": "- brand_name matches brand found in title OR listing_brand field"
    },
    {
      "id": "M01_no_hallucination",
      "criterion": "No Hallucination",
      "check": "Base brand must come from input; typos must be variations of that brand",
      "codeBased": false,
      "fail": "- Output contains a completely different brand not related to input (e.g., \"Sony\" when input brand is \"JBL\")\n- Brand name invented from scratch, not derived from input brand",
      "pass": "- All base brands traceable to input data (e.g., brand_name, title, manufacturer)\n- Typos/variations are clearly derived from the input brand (e.g., \"JLB\", \"jbl\" from \"JBL\")"
    },
    {
      "id": "M01_no_product_words",
      "criterion": "No Product Words",
      "check": "No generic product/feature words in brand output",
      "codeBased": false,
      "fail": "- Brand contains generic product words (e.g., Wireless, Bluetooth, Speaker, Headphones, Charger, etc.)\n- Product category used as brand name",
      "pass": "- Output contains only actual brand/trademark names\n- No generic descriptors or product types"
    },
    {
      "id": "M01_amazon_test_applied",
      "criterion": "Amazon Test Applied",
      "check": "Entity is a brand you search FOR, not a product you search TO BUY",
      "codeBased": false,
      "fail": "- Searching the entity on Amazon returns a product category, not a brand (e.g., \"Wireless Earbuds\" \u2192 shows earbuds listings, not a brand page)",
      "pass": "- Searching the entity on Amazon returns brand-specific results (e.g., \"JBL\" \u2192 shows JBL brand page/products, \"Sony\" \u2192 shows Sony products)\n- The entity is something customers search FOR to find products, not something they search TO BUY directly"
    },
    {
      "id": "M01_no_duplicates",
      "criterion": "No Duplicates",
      "check": "No exact duplicate strings in list",
      "codeBased": false,
      "fail": "- Exact same string appears more than once (e.g., \"JBL\", \"JBL\")",
      "pass": "- Each string in list is unique\n- Case variations are different entries, not duplicates (e.g., \"JBL\" and \"jbl\" are both valid)"
    }
  ],
  "M01a": [
    {
      "id": "M01a_has_variations",
      "criterion": "Has Variations",
      "check": "Multiple brand variations generated",
      "codeBased": false,
      "fail": "- Only 1 variation returned\n- Empty list",
      "pass": "- Multiple variations generated"
    },
    {
      "id": "M01a_no_unrelated_terms",
      "criterion": "No Unrelated Terms",
      "check": "All variations are misspellings/typos of the SAME brand only",
      "codeBased": false,
      "fail": "- Contains different brand names (e.g., \"Sony\" in JBL variations)\n- Contains product words (e.g., \"Earbuds\", \"Speaker\")\n- Contains sub-brand names (should be in M01b)",
      "pass": "- All items are typos/case variations/misspellings of the input brand_name only"
    },
    {
      "id": "M01a_count_in_range",
      "criterion": "8-12 Count",
      "check": "Exactly 8-12 variations",
      "codeBased": false,
      "fail": "- Fewer than 8 variations\n- More than 12 variations",
      "pass": "- Exactly 8-12 variations in the list"
    },
    {
      "id": "M01a_first_is_canonical",
      "criterion": "First is Canonical",
      "check": "First variation matches input brand_name exactly",
      "codeBased": false,
      "fail": "- First item differs from input brand_name\n- First item has typos, spacing changes, or case changes",
      "pass": "- variations[0] === brand_name (exact match)"
    }
  ],
  "M01b": [
    {
      "id": "M01b_sub_brands_found",
      "criterion": "Sub-brands Found",
      "check": "Sub-brands, product lines, brand-owned tech extracted from listing",
      "codeBased": false,
      "fail": "- Sub-brand mentioned in title/bullets not captured\n- Product line name in listing not captured",
      "pass": "- sub_brands array contains product families, series names, brand-owned tech mentioned in listing"
    },
    {
      "id": "M01b_no_universal_standards",
      "criterion": "No Universal Standards",
      "check": "No universal/industry standards listed as brand-specific",
      "codeBased": false,
      "fail": "- Universal standards included as brand-specific (e.g., Bluetooth, USB-C, WiFi, HDMI, NFC, Qi, etc.)",
      "pass": "- Only proprietary brand-owned terms included\n- No industry-wide standards or protocols"
    },
    {
      "id": "M01b_manufacturer_null_when_same",
      "criterion": "Manufacturer Null When Same",
      "check": "Manufacturer=null when same as brand",
      "codeBased": false,
      "fail": "- Returned manufacturer when = brand_name",
      "pass": "- Returns null when manufacturer matches brand"
    },
    {
      "id": "M01b_searchable_standards_default_empty",
      "criterion": "Searchable Standards Empty",
      "check": "searchable_standards empty unless customers actively search for standard by name",
      "codeBased": false,
      "fail": "- Technical standards included (e.g., ENFit, USB-C, Bluetooth)\n- Standards customers don't search for by name",
      "pass": "- Empty array (most products)\n- Only brand-like standards people search: Gore-Tex, Dolby Atmos, THX"
    }
  ],
  "M02": [
    {
      "id": "M02_correct_classification",
      "criterion": "Correct Classification",
      "check": "OB when keyword contains brand from variations_own, null otherwise",
      "codeBased": false,
      "fail": "- OB returned but keyword has no match in variations_own or related_terms_own\n- null returned but keyword contains exact term from variations_own",
      "pass": "- OB only when keyword contains term from variations_own/related_terms_own\n- null when no match found (passes to M03)"
    },
    {
      "id": "M02_brand_match_found",
      "criterion": "Brand Match Found",
      "check": "Brand from variations_own detected in keyword when present",
      "codeBased": false,
      "fail": "- Missed brand that exists in variations_own input",
      "pass": "- Brand correctly detected by matching against variations_own list"
    },
    {
      "id": "M02_no_false_positives",
      "criterion": "No False Positives",
      "check": "No generic words flagged as brand",
      "codeBased": false,
      "fail": "- Generic words flagged as brand (e.g., \"wireless\", \"bluetooth\", \"speaker\")",
      "pass": "- Only actual brand/trademark names matched"
    },
    {
      "id": "M02_case_insensitive",
      "criterion": "Case Insensitive",
      "check": "Brand matching ignores uppercase/lowercase differences",
      "codeBased": false,
      "fail": "- Case difference caused missed match (e.g., \"jbl\" in keyword didn't match \"JBL\" in variations_own)",
      "pass": "- Brand matched regardless of case (e.g., \"jbl\", \"JBL\", \"Jbl\" all match)"
    },
    {
      "id": "M02_word_boundary_respected",
      "criterion": "Word Boundary Respected",
      "check": "Partial matches rejected (jbl \u2260 jblue)",
      "codeBased": false,
      "fail": "- \"jbl\" incorrectly matched \"jblue\"\n- Substring match accepted",
      "pass": "- Only whole word matches accepted"
    },
    {
      "id": "M02_no_similar_brand_confusion",
      "criterion": "No Similar Brand Confusion",
      "check": "Similar-looking brands rejected (jlab \u2260 JBL)",
      "codeBased": false,
      "fail": "- Confused similar-sounding brands\n- \"jlab\" matched as \"JBL\"",
      "pass": "- Different brands correctly rejected"
    }
  ],
  "M03": [
    {
      "id": "M03_competitors_relevant",
      "criterion": "Competitors Relevant",
      "check": "All competitors sell products in same category as ASIN",
      "codeBased": false,
      "fail": "- Brands from different product categories\n- Generic retailers included (e.g., Amazon, Walmart, Target)\n- Own brand included in competitors list",
      "pass": "- All brands sell similar products to the ASIN\n- No unrelated brands or retailers"
    },
    {
      "id": "M03_competitor_count",
      "criterion": "Competitor Count",
      "check": "5-10 distinct competitor brands included",
      "codeBased": false,
      "fail": "- Fewer than 5 distinct brands\n- More than 10 distinct brands",
      "pass": "- 5-10 unique competitor brand names"
    },
    {
      "id": "M03_no_hallucinated_brands",
      "criterion": "No Hallucinated Brands",
      "check": "All competitor brands are verifiable real brands",
      "codeBased": false,
      "fail": "- Brand names that don't exist\n- Misspelled brand names presented as separate brands",
      "pass": "- All brands can be found on Amazon/Google as real companies"
    }
  ],
  "M04": [
    {
      "id": "M04_correct_classification",
      "criterion": "Correct Classification",
      "check": "CB when competitor brand in keyword, null otherwise",
      "codeBased": false,
      "fail": "- CB returned but no competitor brand in keyword\n- null returned but keyword contains competitor brand",
      "pass": "- CB only when keyword contains term from competitors list\n- null when no match (passes to M05)"
    },
    {
      "id": "M04_own_brand_excluded",
      "criterion": "Own Brand Excluded",
      "check": "Own brand terms never trigger CB classification",
      "codeBased": false,
      "fail": "- Own brand term classified as CB\n- Own brand variation matched as competitor",
      "pass": "- Own brand terms return null, not CB"
    },
    {
      "id": "M04_word_boundary_respected",
      "criterion": "Word Boundary Respected",
      "check": "Partial/substring matches rejected - only full words match",
      "codeBased": false,
      "fail": "- Substring incorrectly matched (e.g., \"kitchen\" to \"KitchenAid\", \"good\" to \"Good Grips\")",
      "pass": "- Only complete word/phrase matches accepted\n- Generic words not confused with brands"
    },
    {
      "id": "M04_known_brands_detected",
      "criterion": "Known Brands Detected",
      "check": "Recognizable brands caught even if not in competitors list",
      "codeBased": false,
      "fail": "- Known brand missed because not in provided list (e.g., Homwe, Beats, Iron Flask)",
      "pass": "- Known brands detected using category knowledge\n- Brand recognized regardless of whether in competitors input"
    },
    {
      "id": "M04_character_ip_recognized",
      "criterion": "Character/IP Recognized",
      "check": "Licensed character and franchise names detected as brands",
      "codeBased": false,
      "fail": "- Character/franchise keyword returned null (e.g., \"batman action figure\", \"disney princess\", \"marvel toys\")",
      "pass": "- Licensed characters/franchises classified as CB (e.g., Batman, Disney, Marvel, Star Wars)"
    }
  ],
  "M05": [
    {
      "id": "M05_correct_classification",
      "criterion": "Correct Classification",
      "check": "NB only when keyword has zero brand references",
      "codeBased": false,
      "fail": "- NB returned but keyword contains a brand\n- null returned for truly generic keyword",
      "pass": "- NB only for pure generic keywords (e.g., \"wireless bluetooth earbuds\")\n- null when any brand detected"
    },
    {
      "id": "M05_hidden_brands_detected",
      "criterion": "Hidden Brands Detected",
      "check": "Brands not in provided lists are still caught",
      "codeBased": false,
      "fail": "- Hidden brand missed (e.g., Beats, Echo, Iron Flask not in list but returned NB)",
      "pass": "- Known brands caught regardless of whether in competitors list"
    },
    {
      "id": "M05_typo_variations_caught",
      "criterion": "Typo Variations Caught",
      "check": "Spacing and typo variations recognized as brands",
      "codeBased": false,
      "fail": "- Brand typo/spacing missed (e.g., \"camel back\" not recognized as CamelBak, \"hydro flask\" not matched)",
      "pass": "- Common typos and spacing variations detected as brands"
    },
    {
      "id": "M05_product_lines_recognized",
      "criterion": "Product Lines Recognized",
      "check": "Trademarked product line names caught as brands",
      "codeBased": false,
      "fail": "- Product line returned NB (e.g., \"airpods case\", \"quietcomfort headphones\")",
      "pass": "- Trademarked product lines classified as branded (e.g., AirPods, QuietComfort, Galaxy)"
    },
    {
      "id": "M05_ppc_terms_filtered",
      "criterion": "PPC Terms Filtered",
      "check": "ASIN codes and PPC match-type terms return null",
      "codeBased": false,
      "fail": "- PPC meta-term returned NB (e.g., ASIN codes, \"close-match\", \"loose-match\")",
      "pass": "- ASINs and PPC meta-terms return null (not valid product keywords)"
    }
  ],
  "M06": [
    {
      "id": "M06_hierarchy_correct",
      "criterion": "Hierarchy Correct",
      "check": "Rank 1 = most specific type, higher ranks = broader categories",
      "codeBased": false,
      "fail": "- Rank 1 is broader than Rank 2 (e.g., \"Earbuds\" at Rank 1, \"True Wireless Earbuds\" at Rank 2)\n- General category before specific type",
      "pass": "- Rank 1 is most specific: e.g., Rank 1: \"Pencil Eyeliner\" \u2192 Rank 2: \"Eyeliner\" \u2192 Rank 3: \"Eye Makeup\"\n- Each rank is a TRUE parent of the previous (test: \"Is Rank 1 a TYPE OF Rank 2?\")"
    },
    {
      "id": "M06_product_type_accurate",
      "criterion": "Product Type Accurate",
      "check": "Rank 1 accurately describes what the product IS",
      "codeBased": false,
      "fail": "- Rank 1 doesn't match the actual product\n- Would confuse a shopper about what they're buying",
      "pass": "- Rank 1 is what you'd call this product in conversation"
    },
    {
      "id": "M06_synonyms_merged",
      "criterion": "Synonyms Merged",
      "check": "Terms with same meaning merged on same rank with \" / \" separator",
      "codeBased": false,
      "fail": "- Synonyms on different ranks (e.g., \"Stroller\" at Rank 2, \"Baby Stroller\" at Rank 1 - these mean the same thing)\n- Translations not merged (e.g., \"Soy Sauce\" and \"Kecap Manis\" on separate ranks)",
      "pass": "- Synonyms merged: e.g., \"Pencil Eyeliner / Eyeliner Pencil\" on same rank\n- Test: \"Do both terms refer to the same product?\" If yes \u2192 same rank with \" / \""
    },
    {
      "id": "M06_no_excluded_terms",
      "criterion": "No Excluded Terms",
      "check": "No adjectives, features, materials, colors, sizes in taxonomy ranks",
      "codeBased": false,
      "fail": "- Adjectives in rank (e.g., \"Premium\", \"Best\", \"Waterproof\")\n- Materials as separate rank (e.g., \"Stainless Steel\" as its own rank)\n- Features in rank (e.g., \"Bluetooth\", \"Wireless\", \"LED\")\n- Colors, sizes, audiences in rank (e.g., \"Black\", \"32oz\", \"Men's\")",
      "pass": "- Only product type/category nouns in ranks\n- Materials/features excluded or combined with product type (e.g., \"Stainless Steel Water Bottle\" not \"Stainless Steel\" \u2192 \"Water Bottle\")"
    }
  ],
  "M07": [
    {
      "id": "M07_attributes_from_listing",
      "criterion": "Attributes From Listing",
      "check": "Variants, use cases derived from title, bullets, description, or Keepa hints",
      "codeBased": false,
      "fail": "- Attribute not mentioned in any input field\n- Completely invented attributes",
      "pass": "- Each attribute traceable to title, bullets, description, or Keepa data"
    },
    {
      "id": "M07_no_fabricated_use_cases",
      "criterion": "No Fabricated Use Cases",
      "check": "Use cases supported by product's actual function",
      "codeBased": false,
      "fail": "- Use case physically impossible for this product\n- Use case contradicts product description",
      "pass": "- Use cases match what product can actually do based on listing"
    },
    {
      "id": "M07_audiences_explicit_or_dash",
      "criterion": "Audiences Explicit or Dash",
      "check": "Audiences from listing OR [\"-\"] when no specific audience mentioned",
      "codeBased": false,
      "fail": "- Generic terms like \"Everyone\", \"Adults\", \"Users\", \"People\"\n- Audiences not mentioned in listing",
      "pass": "- [\"-\"] when listing doesn't specify audience\n- Specific audiences only when explicitly stated (e.g., \"Men's\", \"For Nurses\")"
    },
    {
      "id": "M07_specs_preserve_units",
      "criterion": "Specs Preserve Units",
      "check": "Full specs with numbers and units preserved",
      "codeBased": false,
      "fail": "- Truncated specs, missing units\n- \"32\" instead of \"32oz\"",
      "pass": "- Full specifications preserved (e.g., \"32oz\", \"Bluetooth 5.2\")"
    }
  ],
  "M08": [
    {
      "id": "M08_important_ranked_high",
      "criterion": "Important Ranked High",
      "check": "Title attributes = rank 1-2, bullet attributes = rank 2-3, description = rank 3-4",
      "codeBased": false,
      "fail": "- Title attribute ranked 3 or lower\n- Generic attribute ranked above title attribute",
      "pass": "- Title attributes = rank 1-2\n- First bullet attributes = rank 2-3\n- Description-only = rank 3-4"
    },
    {
      "id": "M08_unique_ranks_per_type",
      "criterion": "Unique Ranks Per Type",
      "check": "Each attribute_type has unique sequential ranks (no duplicates)",
      "codeBased": false,
      "fail": "- Duplicate rank within same type (e.g., two Variants both with rank=2)\n- Gaps in sequence (e.g., Variants with ranks 1,2,4 - missing 3)\n- Non-sequential ordering (e.g., ranks 3,1,2 instead of 1,2,3)",
      "pass": "- Each attribute_type has its own independent rank sequence starting at 1\n- No duplicate ranks within same type (e.g., Variants: 1,2,3 and UseCases: 1,2 - both start at 1, that's correct)\n- Sequential integers with no gaps"
    },
    {
      "id": "M08_title_attributes_ranked_high",
      "criterion": "Title Attributes Ranked High",
      "check": "Attributes appearing in title get rank 1-2 within their type",
      "codeBased": false,
      "fail": "- Title attribute ranked 3 or lower",
      "pass": "- Title attributes ranked 1-2 within their attribute_type"
    }
  ],
  "M09": [
    {
      "id": "M09_captures_core_purpose",
      "criterion": "Captures Core Purpose",
      "check": "Answers: \"What is the ONE thing this product does?\"",
      "codeBased": false,
      "fail": "- Describes a feature, not core function\n- Lists multiple uses instead of single primary",
      "pass": "- Describes core function (verb + object)\n- Passes test: \"If product could only do ONE thing, what would it be?\""
    },
    {
      "id": "M09_no_marketing_language",
      "criterion": "No Marketing Language",
      "check": "No adjectives, quality claims, or marketing words",
      "codeBased": false,
      "fail": "- Includes adjectives (e.g., \"premium\", \"comfortable\", \"amazing\")\n- Includes quality claims (e.g., \"best\", \"enhanced\")",
      "pass": "- Simple verb+noun structure\n- No descriptive adjectives"
    },
    {
      "id": "M09_word_count_3_to_6",
      "criterion": "Word Count 3-6",
      "check": "Exactly 3-6 words in primary_use",
      "codeBased": false,
      "fail": "- Fewer than 3 words\n- More than 6 words",
      "pass": "- Exactly 3-6 words"
    },
    {
      "id": "M09_no_brand_tech_names",
      "criterion": "No Brand/Tech Names",
      "check": "No brand names or technology specs in output",
      "codeBased": false,
      "fail": "- Contains brand (e.g., \"JBL\", \"Nike\")\n- Contains tech (e.g., \"Bluetooth\", \"WiFi\", \"USB-C\")",
      "pass": "- Generic functional description only\n- No specific brands or technologies"
    }
  ],
  "M10": [
    {
      "id": "M10_invalid_correctly_flagged",
      "criterion": "Invalid Correctly Flagged",
      "check": "Correctly flags: adjectives, tech names, wrong word count, marketing language",
      "codeBased": false,
      "fail": "- Missed adjective (e.g., \"premium\", \"comfortable\")\n- Missed tech name (e.g., \"Bluetooth\")\n- Missed word count violation\n- Missed marketing language",
      "pass": "- All violations from M09 checklist flagged in issues_found array"
    },
    {
      "id": "M10_fix_improves_output",
      "criterion": "Fix Improves Output",
      "check": "Corrected validated_use passes all M09 criteria",
      "codeBased": false,
      "fail": "- Fixed output still has adjectives/tech names\n- Fixed output wrong word count\n- Fix is worse than original",
      "pass": "- validated_use: 3-6 words, no adjectives, no tech, describes core function"
    }
  ],
  "M11": [
    {
      "id": "M11_only_true_constraints",
      "criterion": "Only True Constraints",
      "check": "Only attributes that make product PHYSICALLY UNABLE to function when removed",
      "codeBased": false,
      "fail": "- Quality levels marked hard (e.g., \"Deep Bass\", \"500F rating\")\n- Durability features marked hard (e.g., \"Waterproof\")\n- Convenience features marked hard",
      "pass": "- Device compatibility (e.g., \"iPhone 15 fit\" for case)\n- Essential safety (e.g., \"Heat Resistant\" for oven mitt)"
    },
    {
      "id": "M11_critical_not_missed",
      "criterion": "Critical Not Missed",
      "check": "Device compatibility and essential safety constraints not missed",
      "codeBased": false,
      "fail": "- Phone case missing device fit constraint\n- Oven mitt missing heat resistance constraint",
      "pass": "- Device-specific fit captured for accessories\n- Essential safety properties captured"
    },
    {
      "id": "M11_never_categories_excluded",
      "criterion": "NEVER Categories Excluded",
      "check": "No tech versions, durability, performance specs marked as hard",
      "codeBased": false,
      "fail": "- Tech versions marked hard (e.g., Bluetooth 5.2, WiFi 6, USB 3.0)\n- Durability features marked hard (e.g., Waterproof, Rustproof)\n- Performance specs marked hard (e.g., 32hr battery, 26lbs/day)",
      "pass": "- NEVER categories excluded from hard constraints"
    },
    {
      "id": "M11_expected_distribution",
      "criterion": "Expected Distribution",
      "check": "Most products have 0 hard constraints, accessories may have 1",
      "codeBased": false,
      "fail": "- Standalone products with 2+ hard constraints (e.g., earbuds, water bottles, trays shouldn't have multiple)\n- Generic products with any hard constraints when none are truly required for function",
      "pass": "- 0 constraints for standalone products (e.g., earbuds, bottles, trays, makeup, toys, jackets)\n- 1 constraint for compatibility-dependent accessories (e.g., phone cases need device fit, cables need connector type, oven mitts need heat rating)"
    },
    {
      "id": "M11_three_step_test_applied",
      "criterion": "3-Step Test Applied",
      "check": "All 3 tests applied: (1) Complete Removal, (2) Mechanism vs Quality, (3) Validated Use Alignment",
      "codeBased": false,
      "fail": "- Step 1 missing: No analysis of \"would product still work if attribute completely removed?\"\n- Step 2 missing: No distinction between mechanism (how it works) vs quality (how well it works)\n- Step 3 missing: No check if validated_use specifically requires this attribute",
      "pass": "- Step 1 shown: \"If [attribute] removed entirely, does product still function?\" (e.g., earbuds without Bluetooth = non-functional)\n- Step 2 shown: \"Is this HOW it works (mechanism) or HOW WELL (quality)?\" (e.g., \"Deep Bass\" = quality, \"Bluetooth\" = mechanism)\n- Step 3 shown: \"Does validated_use require this specific attribute?\" (e.g., \"portable audio\" doesn't require specific Bluetooth version)"
    }
  ],
  "M12": [
    {
      "id": "M12_correct_classification",
      "criterion": "Correct Classification",
      "check": "Classification follows decision tree: Hard Constraint \u2192 Product Type \u2192 Primary Use \u2192 Complementary",
      "codeBased": false,
      "fail": "- R assigned but hard constraint violated (should be N)\n- N assigned but keyword describes same primary use as product (should be S)\n- N assigned but keyword product is commonly used together with ASIN (should be C)",
      "pass": "- R (Relevant): Keyword asks for same product type AND serves same primary use (e.g., \"wireless earbuds\" for wireless earbuds product)\n- S (Substitute): Different product type but same primary use - buyer could choose either (e.g., \"headphones\" for earbuds - both for personal audio)\n- C (Complementary): Different type, different use, but commonly purchased/used together (e.g., \"earbuds case\" for earbuds)\n- N (Negative): None of above - unrelated product OR hard constraint violated (e.g., \"iPhone case\" for earbuds)"
    },
    {
      "id": "M12_decision_path_followed",
      "criterion": "Decision Path Followed",
      "check": "Steps followed in order: (1) Hard constraint \u2192 (2) Product type \u2192 (3a/3b) Use check \u2192 (4) Complementary",
      "codeBased": false,
      "fail": "- Jumped to classification without checking hard constraints first\n- Skipped product type check",
      "pass": "- Reasoning shows each step evaluated in order\n- Early termination only at valid exit points"
    }
  ],
  "M13": [
    {
      "id": "M13_same_type_correct",
      "criterion": "Same Type Correct",
      "check": "Correctly identifies if keyword asks for same base product type as ASIN taxonomy",
      "codeBased": false,
      "fail": "- Said \"different type\" but keyword is synonym or variation (e.g., earphones vs earbuds are SAME type)\n- Said \"same type\" but fundamentally different product (e.g., earbuds vs speakers are DIFFERENT types)",
      "pass": "- YES (same type) when: keyword product would be shelved in same store section as ASIN (e.g., \"bluetooth earphones\" for earbuds product - both in earbuds section)\n- NO (different type) when: keyword product belongs in different store section (e.g., \"speaker\" for earbuds - speaker section vs earbuds section)"
    },
    {
      "id": "M13_modifiers_stripped",
      "criterion": "Modifiers Stripped",
      "check": "Core product noun extracted, modifiers ignored",
      "codeBased": false,
      "fail": "- Adjectives caused \"different type\" decision (e.g., \"hiking water bottle\" marked different from \"water bottle\")\n- Material differences caused \"different type\" (e.g., \"stainless steel tumbler\" vs \"plastic tumbler\" marked as different types)",
      "pass": "- Comparison based only on the BASE PRODUCT NOUN, ignoring all modifiers\n- These modifier types are stripped before comparison: material (e.g., stainless steel, plastic), use-case (e.g., hiking, office), brand (e.g., Nike, Yeti), color (e.g., black, blue), size (e.g., large, 32oz)\n- Example: \"large stainless steel hiking water bottle\" \u2192 compares as \"water bottle\""
    },
    {
      "id": "M13_synonyms_recognized",
      "criterion": "Synonyms Recognized",
      "check": "Common synonyms recognized as same type",
      "codeBased": false,
      "fail": "- Marked synonyms as different types (e.g., earphones\u2260earbuds, ice machine\u2260ice maker)",
      "pass": "- Synonyms correctly recognized as same product type"
    }
  ],
  "M14": [
    {
      "id": "M14_same_use_correct",
      "criterion": "Same Use Correct",
      "check": "Keyword's implied use matches ASIN's validated_use",
      "codeBased": false,
      "fail": "- Said \"different use\" but both products solve the same problem (e.g., paper tray vs bamboo tray - both for serving food)\n- Said \"same use\" but products solve different problems (e.g., bed pillow for sleeping vs throw pillow for decoration)",
      "pass": "- YES (same use): Ask \"what problem does each solve?\" - if same answer, it's same use (e.g., \"wireless earbuds\" and \"bluetooth earphones\" both solve \"personal audio listening\")\n- NO (different use): Products solve fundamentally different problems (e.g., \"gaming headset\" solves \"gaming communication\" vs \"earbuds\" solves \"portable music listening\")"
    },
    {
      "id": "M14_superficial_differences_ignored",
      "criterion": "Superficial Differences Ignored",
      "check": "Material/form/character/brand differences don't change primary use classification",
      "codeBased": false,
      "fail": "- Superficial differences treated as different use (e.g., paper tray vs bamboo tray, liquid eyeliner vs pencil eyeliner, Bumblebee vs Optimus Prime toy)",
      "pass": "- Same primary use recognized despite material/form/character differences"
    }
  ],
  "M15": [
    {
      "id": "M15_substitute_correct",
      "criterion": "Substitute Correct",
      "check": "Different product type that satisfies same customer need = Substitute",
      "codeBased": false,
      "fail": "- Marked N but customer could reasonably buy either for same need (e.g., tumbler vs bottle - both solve \"carry drinks on the go\")\n- Marked S but products serve different needs (e.g., coffee mug for desk use vs water bottle for portable use)",
      "pass": "- S when: Different product types BUT customer shopping for one could reasonably choose the other\n- Test: \"If I need [core need], would I consider both products?\" If yes \u2192 S\n- Examples of S: water bottle\u2194tumbler (portable hydration), earbuds\u2194wired headphones (personal audio), puffer jacket\u2194winter coat (cold weather warmth)\n- NOT S when: Different contexts even if similar category (e.g., desk mug vs travel bottle)"
    },
    {
      "id": "M15_sixty_percent_overlap",
      "criterion": "60% Overlap Rule",
      "check": "Near-substitutes with significant use overlap classified as S",
      "codeBased": false,
      "fail": "- Too strict on near-substitutes: marked N when products share \u226560% of use cases (e.g., travel mug vs water bottle, bone conduction vs earbuds)",
      "pass": "- Apply 60% test: \"What % of use cases would BOTH products satisfy?\"\n- \u226560% overlap \u2192 classify as S (Substitute)\n- Examples: travel mug\u2194water bottle (80% overlap - both portable, differ on hot drinks focus) \u2192 S\n- Examples: bone conduction\u2194earbuds (70% overlap - both personal audio, differ on ear coverage) \u2192 S\n- <60% overlap \u2192 pass to M16 for complementary check"
    }
  ],
  "M16": [
    {
      "id": "M16_complementary_correct",
      "criterion": "Complementary Correct",
      "check": "One product maintains, stores, displays, or enhances the other = C",
      "codeBased": false,
      "fail": "- C assigned but products have no direct usage relationship (just same category)\n- N assigned but one product clearly supports/maintains the other (e.g., case for earbuds should be C)",
      "pass": "- C when keyword product DIRECTLY supports the ASIN in one of these ways:\n  \u2022 Maintenance: cleans/cares for it (e.g., cleaning brush for bottle, lens wipes for glasses)\n  \u2022 Storage: holds/protects it (e.g., case for earbuds, sleeve for laptop)\n  \u2022 Display: shows/presents it (e.g., stand for watch, holder for phone)\n  \u2022 Accessory: attaches to/works with it (e.g., ear tips for earbuds, strap for bottle)\n  \u2022 Workflow: used in same task sequence (e.g., pillowcase for pillow, lid for container)"
    },
    {
      "id": "M16_amazon_bundle_test",
      "criterion": "Amazon Bundle Test",
      "check": "\"Would Amazon show these as Frequently Bought Together?\"",
      "codeBased": false,
      "fail": "- C for products Amazon wouldn't bundle\n- Products only share category, not actual usage",
      "pass": "- Products commonly purchased together\n- One directly supports/maintains the other"
    },
    {
      "id": "M16_same_category_not_complementary",
      "criterion": "Same Category != Complementary",
      "check": "Products in same category but different functions are NOT complementary",
      "codeBased": false,
      "fail": "- Same category marked as complementary (e.g., ice maker + sorbet maker, eyeliner + setting powder, puffer jacket + thermal socks)",
      "pass": "- Same-category different-function correctly classified as N"
    },
    {
      "id": "M16_relationship_type_identified",
      "criterion": "Relationship Type Identified",
      "check": "For C classification: Maintenance/Storage/Display/Accessory/Workflow/Same-Occasion specified",
      "codeBased": false,
      "fail": "- No relationship_type for C classification\n- relationship_type is vague or wrong",
      "pass": "- Specific relationship type identified from: Maintenance, Storage, Display, Accessory, Workflow, Same-Occasion, Organization"
    }
  ]
};
        const moduleDescriptions = {
  "M01": "Extract Own Brand Entities",
  "M01a": "Generate Brand Variations",
  "M01b": "Extract Brand Related Terms",
  "M02": "Detect Brand in Keyword",
  "M03": "Generate Competitor Entities",
  "M04": "Classify Competitor Brand Keywords",
  "M05": "Classify Non-Branded Keywords",
  "M06": "Generate Product Type Taxonomy",
  "M07": "Extract Product Attributes",
  "M08": "Assign Attribute Ranks",
  "M09": "Identify Primary Intended Use",
  "M10": "Validate Primary Intended Use",
  "M11": "Identify Hard Constraints",
  "M12": "Combined Classification",
  "M13": "Product Type Check",
  "M14": "Primary Use Check (Same Type)",
  "M15": "Substitute Check",
  "M16": "Complementary Check"
};

        function openSplitView(moduleId, event) {
            event.stopPropagation();
            document.getElementById('welcome').classList.add('hidden');
            document.getElementById('splitContainer').classList.add('active');
            document.getElementById('sidebar').classList.add('split-mode');
            document.querySelectorAll('.module-header').forEach(h => h.classList.remove('active'));
            document.querySelector('[data-module="' + moduleId + '"] .module-header').classList.add('active');
            document.getElementById('promptTitle').textContent = moduleId + ': ' + moduleDescriptions[moduleId];
            document.getElementById('promptContent').textContent = modulePrompts[moduleId] || 'Prompt not available';
            const rubrics = rubricData[moduleId] || [];
            document.getElementById('rubricTitle').textContent = 'Rubrics (' + rubrics.length + ')';
            let html = '';
            rubrics.forEach(r => {
                html += '<div class="rubric-card ' + (r.codeBased ? 'code-based' : '') + '">' +
                    '<div class="rubric-card-header"><span class="rubric-card-id">' + r.id + '</span>' +
                    (r.codeBased ? '<span class="rubric-card-badge">CODE-BASED</span>' : '') + '</div>' +
                    '<div class="rubric-card-criterion">' + r.criterion + '</div>' +
                    '<div class="rubric-card-check">Check: ' + r.check + '</div>' +
                    '<div class="rubric-card-section"><div class="rubric-card-label fail">FAIL when:</div>' +
                    '<div class="rubric-card-content">' + r.fail + '</div></div>' +
                    '<div class="rubric-card-section"><div class="rubric-card-label pass">PASS when:</div>' +
                    '<div class="rubric-card-content">' + r.pass + '</div></div></div>';
            });
            document.getElementById('rubricContent').innerHTML = html;
        }

        function closeSplitView() {
            document.getElementById('welcome').classList.remove('hidden');
            document.getElementById('splitContainer').classList.remove('active');
            document.getElementById('sidebar').classList.remove('split-mode');
            document.querySelectorAll('.module-header').forEach(h => h.classList.remove('active'));
        }
    </script>
</body>
</html>